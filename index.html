<script>
(function(){
  // ---------- DOM ----------
  const NAV  = document.getElementById('nav');
  const MAIN = document.getElementById('main');
  const RAIL = document.getElementById('rail');
  const MENU = document.getElementById('menu');
  const SEARCH_BOX = document.getElementById('q');
  const SEARCH_DD  = document.getElementById('dd');
  const LB = document.getElementById('lightbox');
  const LB_SLOT = document.getElementById('lbSlot');
  const LB_CLOSE = document.getElementById('lbClose');

  // ---------- Config ----------
  const LS_SEEN = 'ao.v2.seen';
  const LS_TIME = 'ao.v2.time';
  const LS_LAST = 'ao.v2.last';
  const COMP_THRESH = { red:20, yellow:60 };

  const params = new URLSearchParams(location.search);
  const WANT_DEMO = params.get('demo') === '1';   // only show demo when explicitly requested
  const WANT_FULL = params.get('full') === '1';   // load /full/site.json
  const EXCLUDE_TEST_TITLES = ['Media Tests','Demo Samples']; // hidden unless ?demo=1

  // ---------- Helpers ----------
  const h=(t,a={},...c)=>{const e=document.createElement(t);
    for(const[k,v]of Object.entries(a)){
      if(k==='class')e.className=v;
      else if(k==='html')e.innerHTML=v;
      else if(k.startsWith('on')&&typeof v==='function')e.addEventListener(k.slice(2),v);
      else e.setAttribute(k,v);
    }
    c.forEach(x=>{ if(x!=null) e.appendChild(typeof x==='string'?document.createTextNode(x):x) });
    return e;
  };
  const num = s => s ? parseInt(s,10) : NaN;
  const tokenize = s => (s||'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(Boolean);
  const fmtDate=(iso,tz,time)=>{
    try{const dt=new Date(`${iso}T${time||'00:00'}:00`);
      const opt={dateStyle:'medium',timeStyle:time?'short':undefined};
      if(tz) opt.timeZone = tz;
      const s=new Intl.DateTimeFormat(undefined,opt).format(dt);
      return s + (tz?` (${(tz.split('/')[1]||tz)})`:'');
    }catch{ return iso+(time?` ${time}`:''); }
  };
  const loadJSON=(k,def)=>{ try{const v=JSON.parse(localStorage.getItem(k)||''); return v??def;}catch{ return def; } };
  const saveJSON=(k,v)=>localStorage.setItem(k, JSON.stringify(v));

  // ---------- State ----------
  const seen = new Set(loadJSON(LS_SEEN, []));
  const timeMap = loadJSON(LS_TIME, {});
  let currentTimer = null;
  let site=null, chapters=[], docs=[];

  // ---------- Timing ----------
  function startTiming(key){ stopTiming(); currentTimer={key,start:Date.now()}; localStorage.setItem(LS_LAST,key); }
  function stopTiming(){ if(!currentTimer) return; const dt=Math.max(0,Math.round((Date.now()-currentTimer.start)/1000)); timeMap[currentTimer.key]=(timeMap[currentTimer.key]||0)+dt; saveJSON(LS_TIME,timeMap); currentTimer=null; localStorage.removeItem(LS_LAST); }
  window.addEventListener('beforeunload', stopTiming);
  document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopTiming(); });
  (function recover(){ const last=localStorage.getItem(LS_LAST); if(last){ seen.add(last); saveJSON(LS_SEEN,[...seen]); localStorage.removeItem(LS_LAST); } })();

  // ---------- Ordering + labels ----------
  function chapterOrderIndex(ch, i) {
    if (typeof ch.index === 'number') return ch.index;
    const ct = (ch.title || '').trim();
    let m = /^Chapter\s+(\d+)/i.exec(ct);
    if (m) return num(m[1]);
    let best = Infinity;
    (ch.los||[]).forEach(lo=>{
      const t=(lo.title||'').trim();
      const matches = t.match(/\b(\d+\.\d+)\b/g);
      if(matches){matches.forEach(mm=>{
        const major=parseInt(mm.split('.')[0],10);
        if(!Number.isNaN(major)&&major<best)best=major;
      })};
    });
    return best !== Infinity ? best : 1000+i;
  }
  function loLabel(lo){
    const t=(lo.title||'').trim();
    const m=t.match(/(\d+\.\d+)/);
    if(m){
      const rest=t.replace(m[0],'').replace(/^[-—:\s]+/,'').trim();
      return `${m[0]} — ${rest||''}`.trim();
    }
    return t||'Untitled';
  }

  // ---------- Inline media (tokens) ----------
  function normalizeMedia(raw){
    const toItem = (x)=>{
      if(typeof x==='string'){
        if(/^https?:/i.test(x) && (/\.(mp4|webm|ogg)(\?|$)/i).test(x)) return {kind:'video',src:x};
        return {kind:'image',src:x};
      }
      if(x && typeof x==='object'){
        const kind = x.type==='video' || x.video ? 'video' : ((x.src||'').match(/\.(mp4|webm|ogg)(\?|$)/i) ? 'video':'image');
        return { kind, src:x.src, alt:x.alt||'', caption:x.caption||x.title||'' };
      }
      return null;
    };
    if(Array.isArray(raw)) return raw.map(toItem).filter(Boolean);
    if(!raw) return [];
    const one=toItem(raw); return one? [one] : [];
  }
  function extractTokenIndices(text, token){
    const re = token==='img' ? /\[\[img:(\d+)\]\]/gi : /\[\[vid:(\d+)\]\]/gi;
    const inds=[]; (text||'').replace(re,(_,n)=>{ inds.push(Math.max(1,parseInt(n,10))-1); return ''; });
    return inds;
  }
  function openZoom(node){
    LB_SLOT.innerHTML='';
    if(node.tagName==='IMG'){
      LB_SLOT.appendChild(h('img',{src:node.src, alt:node.alt||'', style:'max-width:92vw;max-height:92vh;border-radius:10px'}));
    }else if(node.tagName==='VIDEO'){
      const v = h('video',{src:node.currentSrc||node.src, controls:true, autoplay:true, style:'max-width:92vw;max-height:92vh;border-radius:10px'});
      LB_SLOT.appendChild(v);
    }
    LB.style.display='flex';
  }
  function closeZoom(){ LB.style.display='none'; LB_SLOT.innerHTML=''; }
  LB_CLOSE.addEventListener('click', closeZoom);
  LB.addEventListener('click', (e)=>{ if(e.target===LB) closeZoom(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeZoom(); });

  // ---------- Reader ----------
  function renderMain(ch, lo, chIdx, loIdx){
    const key = `${chIdx+1}.${loIdx+1}`;
    if(!seen.has(key)){ seen.add(key); saveJSON(LS_SEEN,[...seen]); }
    stopTiming(); startTiming(key);

    MAIN.innerHTML='';
    MAIN.append(
      h('h1',{}, `${ch.title || 'Chapter'} — ${lo.title || 'Learning Objective'}`),
      h('p',{class:'lead'}, lo.preview || 'This is preview text for this learning objective.')
    );

    const pool = [
      ...normalizeMedia(lo.images),
      ...normalizeMedia(lo.image||lo.img)
    ];
    (lo.snippets||[]).forEach(s=>{
      pool.push(...normalizeMedia(s.images), ...normalizeMedia(s.image||s.img));
    });

    const s = (lo.snippets||[])[0];
    let body = s?.body || '';
    if (s?.title) MAIN.append(h('h2',{}, s.title));

    const imgTokens = extractTokenIndices(body,'img').filter(i=>pool[i] && pool[i].kind==='image');
    const vidTokens = extractTokenIndices(body,'vid').filter(i=>pool[i] && pool[i].kind==='video');

    const stripped = body.replace(/\[\[(img|vid):\d+\]\]/gi,'').replace(/\s{2,}/g,' ').trim();
    if(stripped) MAIN.append(h('p',{}, stripped));

    const addFigure = (item)=>{
      const fig=h('figure');
      if(item.kind==='image'){
        const im = h('img',{src:item.src, alt:item.alt||''});
        im.addEventListener('dblclick', ()=>openZoom(im));
        fig.appendChild(im);
      }else{
        const v = h('video',{src:item.src, controls:true});
        v.addEventListener('dblclick', ()=>openZoom(v));
        fig.appendChild(v);
      }
      if(item.caption) fig.appendChild(h('figcaption',{}, item.caption));
      MAIN.appendChild(fig);
    };

    [...imgTokens.map(i=>({i,kind:'img'})), ...vidTokens.map(i=>({i,kind:'vid'}))]
      .sort((a,b)=>a.i-b.i)
      .forEach(t => addFigure(pool[t.i]));

    if(imgTokens.length===0 && vidTokens.length===0 && pool[0]) addFigure(pool[0]);

    if(!s && !pool.length){
      MAIN.append(h('div',{class:'muted'}, 'Data source: site.json.'));
    }
  }

  function buildLeftNav(){
    NAV.innerHTML='';
    const list=h('ul');
    chapters.forEach((ch,chIdx)=>{
      list.append(h('h3',{}, ch.title || `Chapter ${chIdx+1}`));
      (ch.los||[]).forEach((lo,loIdx)=>{
        const btn=h('button',{
          class:'lo',
          onclick:()=>{
            renderMain(ch,lo,chIdx,loIdx);
            location.hash=`#ch${chIdx+1}-lo${loIdx+1}`;
            setActiveLO(btn);
            refreshRail();
          }
        }, loLabel(lo));
        list.append(h('li',{}, btn));
      });
    });
    NAV.append(list, h('a',{href:'#data',class:'meta-link'},'→ Open My Data'));

    // Footer (copyright + privacy)
    const year = new Date().getFullYear();
    const foot = h('div',{class:'foot',id:'foot'});
    foot.appendChild(h('div',{html:`©${year} Hall Financial Services, Inc. d/b/a ADVICE ONLY.`}));
    foot.appendChild(h('div',{}, h('a',{href:'https://adviceonly.info/important-disclosures-and-privacy/',target:'_blank',rel:'noopener'}, 'Privacy')));
    NAV.appendChild(foot);
  }

  function setActiveLO(btn){
    NAV.querySelectorAll('button[aria-current="true"]').forEach(b=>b.setAttribute('aria-current','false'));
    btn?.setAttribute('aria-current','true');
    btn?.scrollIntoView({block:'nearest', inline:'nearest'});
  }
  function openFromHash(){
    const m=location.hash.match(/^#ch(\d+)-lo(\d+)$/);
    const ch=chapters[(m?+m[1]:1)-1];
    const lo=ch?.los?.[(m?+m[2]:1)-1];
    if(ch && lo){
      renderMain(ch,lo,(m?+m[1]:1)-1,(m?+m[2]:1)-1);
      const btns = NAV.querySelectorAll('button.lo');
      let flat=0,target=0;
      chapters.forEach((c)=>{(c.los||[]).forEach((l)=>{ if(c===ch&&l===lo) target=flat; flat++; });});
      setActiveLO(btns[target]);
      return true;
    }
    return false;
  }

  // ---------- Rail ----------
  function totals(){
    let total=0; (chapters||[]).forEach(ch=> total+=(ch.los?.length||0));
    let done=0; for(const k of seen){
      const [ci,li]=(k||'').split('.').map(Number);
      if(chapters?.[ci-1]?.los?.[li-1]) done++;
    }
    return {done,total,pct: total? Math.round((done/total)*100) : 0};
  }
  function refreshRail(){
    const evHost = document.getElementById('rail-events');
    const progHost = document.getElementById('rail-progress');
    // Events
    evHost.innerHTML = '<h4>Next event</h4>';
    const list=Array.isArray(site?.events)?site.events.slice():[];
    if(!list.length){ evHost.appendChild(h('div',{class:'muted'},'No events')); }
    else{
      list.sort((a,b)=> new Date(`${a.date}T${a.time||'00:00'}:00`) - new Date(`${b.date}T${b.time||'00:00'}:00`));
      const ev=list.find(e=> new Date(`${e.date}T${e.time||'00:00'}:00`)>=new Date()) || list[0];
      evHost.appendChild(h('div',{class:'muted'}, fmtDate(ev.date, ev.tz, ev.time)));
      evHost.appendChild(h('div',{style:'font-weight:600;margin-top:4px'}, ev.title || 'Event'));
      if(ev.mode) evHost.appendChild(h('div',{class:'muted',style:'margin-top:2px'}, ev.mode));
      if(ev.ctaUrl && ev.ctaLabel) evHost.appendChild(h('div',{style:'margin-top:8px'}, h('a',{href:ev.ctaUrl,class:'btn',target:'_blank',rel:'noopener'}, ev.ctaLabel)));
    }
    // Progress
    progHost.innerHTML = '<h4>Your progress</h4>';
    const {done,total,pct}=totals();
    progHost.appendChild(h('div',{class:'muted'}, `${done} of ${total} (${pct}%)`));
    progHost.appendChild(
      h('div',{class:'progress',style:'margin-top:6px'}, h('i',{style:`width:${pct}%;`}))
    );
  }

  // ---------- Pages ----------
  function setActiveMenu(){
    const r = (location.hash.replace('#','') || 'home').split(':')[0];
    MENU.querySelectorAll('a').forEach(a=>{
      a.setAttribute('aria-current', a.dataset.route===r ? 'page' : 'false');
    });
  }
  function renderHome(){
    stopTiming();
    MAIN.innerHTML='';
    MAIN.append(
      h('h1',{}, site?.title || site?.book || 'Advice-Only®'),
      h('p',{class:'lead'}, 'Welcome. Browse chapters on the left, or use search above.')
    );
    const {done,total,pct}=totals();
    MAIN.append(
      h('div',{class:'cardlet'},
        h('h4',{},'At a glance'),
        h('div',{class:'muted'}, `${done} of ${total} learning objectives viewed`),
        h('div',{class:'progress',style:'margin-top:6px'}, h('i',{style:`width:${pct}%;`})),
        h('div',{style:'margin-top:10px;display:flex;gap:8px;flex-wrap:wrap'},
          h('a',{href:'#data',class:'btn'},'Open My Data'),
          h('a',{href:'#events',class:'btn'},'View Events')
        )
      )
    );
  }
  function renderEvents(){
    stopTiming();
    MAIN.innerHTML='';
    MAIN.append(h('h1',{},'Events'), h('p',{class:'lead'},'Upcoming and past sessions.'));
    const list=Array.isArray(site?.events)?site.events.slice():[];
    if(!list.length){ MAIN.append(h('div',{class:'muted'},'No events found.')); return; }
    list.sort((a,b)=> new Date(`${a.date}T${a.time||'00:00'}:00`) - new Date(`${b.date}T${b.time||'00:00'}:00`));
    list.forEach(e=>{
      MAIN.append(h('div',{class:'cardlet'},
        h('div',{style:'font-weight:600'}, e.title || 'Event'),
        h('div',{class:'muted'}, fmtDate(e.date, e.tz, e.time)),
        e.mode ? h('div',{class:'muted'}, e.mode): null,
        (e.ctaUrl && e.ctaLabel) ? h('div',{style:'margin-top:6px'}, h('a',{href:e.ctaUrl,class:'btn',target:'_blank',rel:'noopener'}, e.ctaLabel)) : null
      ));
    });
  }
  function renderPrivacy(){
    stopTiming();
    MAIN.innerHTML='';
    MAIN.append(
      h('h1',{},'Privacy'),
      h('p',{class:'lead'}, 'Local-only analytics; nothing leaves your browser.')
    );
    MAIN.append(
      h('div',{class:'cardlet'},
        h('h4',{},'What is stored'),
        h('p',{},'Completion status and time-on-page for each learning objective (via localStorage).'),
        h('p',{},'Clear your data in My Data with “Clear progress” and “Clear time”.')
      )
    );
  }
  function renderAbout(){
    stopTiming();
    MAIN.innerHTML='';
    MAIN.append(h('h1',{},'About'));
    const a = site?.about || site?.profile || null;
    if(!a){ MAIN.append(h('div',{class:'muted'},'No about/profile information in site.json.')); return; }
    const name = a.name || '';
    const location = a.location || a.address || '';
    const bio = a.bio || a.subtitle || '';
    const specialties = Array.isArray(a.specialties) ? a.specialties : (a.specialty ? [a.specialty] : []);
    MAIN.append(
      h('div',{class:'cardlet'},
        h('div',{style:'font-size:18px;font-weight:700'}, name),
        location ? h('div',{class:'muted',style:'margin-top:2px'}, location) : null,
        bio ? h('p',{style:'margin-top:8px'}, bio) : null,
        specialties.length ? h('div',{style:'margin-top:6px'}, h('span',{class:'pill'}, `Specialties: ${specialties.join(', ')}`)) : null,
        (a.ctaUrl && a.ctaLabel) ? h('div',{style:'margin-top:12px'}, h('a',{href:a.ctaUrl,class:'btn',target:'_blank',rel:'noopener'}, a.ctaLabel)) : null
      )
    );
  }
  const compColor = secs => secs < COMP_THRESH.red ? 'red' : (secs < COMP_THRESH.yellow ? 'yellow' : 'green');
  function renderMyData(){
    stopTiming();
    const agg = Object.entries(timeMap).reduce((acc,[,s])=>{
      const c=compColor(s); acc[c]++; acc.totalSecs+=s; return acc;
    }, {red:0,yellow:0,green:0,totalSecs:0});
    const {done,total,pct} = totals();

    MAIN.innerHTML='';
    MAIN.append(
      h('h1',{},'My Data'),
      h('p',{class:'lead'},'Local-only engagement data (per learning objective).')
    );

    MAIN.append(
      h('div',{class:'data-grid'},
        h('div',{class:'cardlet'},
          h('h4',{},'Overall progress'),
          h('div',{class:'muted'}, `${done} of ${total} viewed (${pct}%)`),
          h('div',{class:'progress',style:'margin-top:6px'}, h('i',{style:`width:${pct}%;`}))
        ),
        h('div',{class:'cardlet'},
          h('h4',{},'Engagement balance'),
          h('div',{class:'legend',style:'margin-top:4px'},
            h('span',{}, h('i',{class:'dot red'}),'Under 20s'),
            h('span',{}, h('i',{class:'dot yellow'}),'20–59s'),
            h('span',{}, h('i',{class:'dot green'}),'60s+')
          ),
          h('div',{class:'muted',style:'margin-top:8px'}, `Total time: ${Math.round(agg.totalSecs/60)} min`)
        )
      )
    );

    const table=h('table',{class:'data-table', style:'margin-top:8px'});
    table.innerHTML=`<thead>
      <tr><th>Chapter / LO</th><th style="text-align:right">Time (s)</th><th style="text-align:right">Status</th></tr>
    </thead><tbody></tbody>`;
    const tb=table.querySelector('tbody');

    (chapters||[]).forEach((ch,ci)=>{
      const title = ch.title || `Chapter ${ci+1}`;
      let chTime=0;
      (ch.los||[]).forEach((_,li)=>{ chTime += (timeMap[`${ci+1}.${li+1}`]||0); });
      tb.appendChild(h('tr',{},
        h('td',{style:'font-weight:600'}, title),
        h('td',{style:'text-align:right'}, String(chTime)),
        h('td',{style:'text-align:right'}, '')
      ));
      (ch.los||[]).forEach((lo,li)=>{
        const key=`${ci+1}.${li+1}`, secs=(timeMap[key]||0);
        const color=compColor(secs);
        tb.appendChild(h('tr',{},
          h('td',{}, h('span',{class:'muted'}, `${key} `), lo.title || `LO ${li+1}`),
          h('td',{style:'text-align:right'}, String(secs)),
          h('td',{style:'text-align:right'}, h('i',{class:`dot ${color}`},''))
        ));
      });
    });
    MAIN.append(table);

    MAIN.append(h('div',{style:'margin-top:12px;display:flex;gap:8px;flex-wrap:wrap'},
      h('button',{class:'btn',onclick:()=>{ localStorage.removeItem(LS_SEEN); seen.clear(); refreshRail(); renderMyData(); }},'Clear progress'),
      h('button',{class:'btn',onclick:()=>{ localStorage.removeItem(LS_TIME); for(const k in timeMap) delete timeMap[k]; renderMyData(); }},'Clear time'),
      h('a',{href:'#home',class:'btn'},'Back to Home')
    ));
  }

  // ---------- Search ----------
  function buildDocs(){
    docs = [];
    (chapters||[]).forEach((ch,ci)=>{
      (ch.los||[]).forEach((lo,li)=>{
        const fields = [];
        if (lo.title)   fields.push({text:lo.title, w:3});
        if (lo.preview) fields.push({text:lo.preview, w:2});
        (lo.snippets||[]).forEach(s=>{
          if (s.title) fields.push({text:s.title, w:2});
          if (s.body)  fields.push({text:s.body,  w:1});
        });
        docs.push({ ci, li, chTitle: ch.title||`Chapter ${ci+1}`, loTitle: lo.title||`LO ${li+1}`, fields });
      });
    });
  }
  function scoreDoc(qTokens, doc){
    let score=0;
    for(const f of doc.fields){
      const fTokens = tokenize(f.text);
      for(const qt of qTokens){
        const hits = fTokens.filter(t=>t===qt).length;
        if (hits) score += hits * f.w;
      }
    }
    const lt=(doc.loTitle||'').toLowerCase();
    if(qTokens.some(q=>lt.includes(q))) score+=2;
    return score;
  }
  function hilite(text, qTokens){
    if(!text) return '';
    let out = text;
    qTokens.forEach(q=>{
      const esc = q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      out = out.replace(new RegExp(`(${esc})`,'ig'), '<mark>$1</mark>');
    });
    return out;
  }
  function showSearchDD(results, qTokens){
    SEARCH_DD.innerHTML='';
    if(!results.length){ SEARCH_DD.classList.remove('show'); return; }
    results.slice(0,8).forEach(r=>{
      const pv = (chapters[r.ci].los[r.li].snippets?.[0]?.body) || (chapters[r.ci].los[r.li].preview) || '';
      SEARCH_DD.appendChild(
        h('div',{class:'res', onclick:()=>{ location.hash = `#ch${r.ci+1}-lo${r.li+1}`; SEARCH_DD.classList.remove('show'); SEARCH_BOX.blur(); }},
          h('div',{html: hilite(`${r.chTitle} — ${r.loTitle}`, qTokens)}),
          h('small',{html: hilite(pv, qTokens)})
        )
      );
    });
    SEARCH_DD.classList.add('show');
  }
  function runSearch(q, mode){
    const qTokens = tokenize(q);
    if(!qTokens.length){ SEARCH_DD.classList.remove('show'); return; }
    const results = docs.map(d=>{
      const pv = (chapters[d.ci].los[d.li].snippets?.[0]?.body) || (chapters[d.ci].los[d.li].preview) || '';
      return { ...d, score: scoreDoc(qTokens, d), preview: pv };
    }).filter(r=>r.score>0).sort((a,b)=>b.score-a.score);

    if(mode==='dd'){ showSearchDD(results, qTokens); return; }
    stopTiming();
    SEARCH_DD.classList.remove('show');
    MAIN.innerHTML='';
    MAIN.append(h('h1',{},'Search'), h('p',{class:'lead'}, `Results for “${q}”`));
    if(!results.length){ MAIN.append(h('div',{class:'muted'},'No matches.')); return; }
    results.slice(0,30).forEach(r=>{
      MAIN.append(h('div',{class:'cardlet'},
        h('div',{style:'font-weight:600',html: hilite(`${r.chTitle} — ${r.loTitle}`, qTokens)}),
        h('p',{class:'muted',html: hilite(r.preview || '', qTokens)}),
        h('div',{}, h('a',{href:`#ch${r.ci+1}-lo${r.li+1}`,class:'btn'},'Open'))
      ));
    });
  }
  SEARCH_BOX.addEventListener('input', e=>{
    const q=e.target.value.trim();
    if(!q){ SEARCH_DD.classList.remove('show'); return; }
    runSearch(q,'dd');
  });
  SEARCH_BOX.addEventListener('keydown', e=>{
    if(e.key==='Enter'){
      const q=SEARCH_BOX.value.trim();
      if(q){ location.hash = '#search:' + encodeURIComponent(q); }
    }else if(e.key==='Escape'){
      SEARCH_DD.classList.remove('show');
    }
  });
  document.addEventListener('click', (e)=>{
    if(!document.getElementById('search').contains(e.target)){ SEARCH_DD.classList.remove('show'); }
  });

  // ---------- Boot ----------
  async function boot(){
    const base = location.pathname.replace(/[^/]*$/, ''); // keep directory only
    const url = base + (WANT_FULL ? 'full/site.json' : 'site.json');

    try{
      const res=await fetch(url, {cache:'no-store', credentials:'same-origin'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const txt=await res.text();
      site=JSON.parse(txt);
    }catch(e){
      if(!WANT_DEMO){
        NAV.innerHTML='';
        NAV.append(h('div',{class:'muted'}, `Could not load site.json (${e.message||e}).`));
        site = { title:'', chapters:[], events:[] };
      }else{
        site = makeDemoSite();
      }
    }

    const filterTests = ch => {
      const title=(ch.title||'').trim().toLowerCase();
      return WANT_DEMO || !EXCLUDE_TEST_TITLES.some(t => title === t.toLowerCase());
    };

    chapters=(site.chapters||[])
      .filter(filterTests)
      .map((ch,i)=>({ch,ord:chapterOrderIndex(ch,i)}))
      .sort((a,b)=>a.ord-b.ord)
      .map(x=>x.ch);

    buildLeftNav();
    buildDocs();
    refreshRail();

    route();
    window.addEventListener('hashchange', route);
  }

  function route(){
    setActiveMenu();
    const hash = location.hash || '#home';
    if (/^#ch\d+-lo\d+$/.test(hash)) { if(!openFromHash()) renderHome(); return; }
    if (hash.startsWith('#home'))     { renderHome(); return; }
    if (hash.startsWith('#data'))     { renderMyData(); return; }
    if (hash.startsWith('#events'))   { renderEvents(); return; }
    if (hash.startsWith('#privacy'))  { renderPrivacy(); return; }
    if (hash.startsWith('#about'))    { renderAbout(); return; }
    if (hash.startsWith('#search:'))  { runSearch(decodeURIComponent(hash.split(':')[1]||''),'page'); return; }
    if(chapters[0]?.los?.length){ location.hash = '#ch1-lo1'; openFromHash(); } else { renderHome(); }
  }

  // ---------- Demo (only if ?demo=1 and fetch fails) ----------
  function makeDemoSite(){
    return {
      title:"Demo Samples",
      alerts:["Demo is enabled via ?demo=1. Remove the query parameter to hide."],
      events:[{title:"Live Q&A",date:"2026-01-08",time:"13:00",tz:"America/New_York",mode:"Zoom",ctaUrl:"#",ctaLabel:"Details"}],
      about:{name:"Your Name",location:"City, ST",bio:"Financial planner, educator.",specialties:["Planning","Behavior","Retirement"]},
      chapters:[
        { title:"Demo Samples", los:[
          { title:"1.1 — Inline tokens", preview:"Two images and one short video, tokenized.",
            images:[
              "https://picsum.photos/seed/a/1200/800",
              "https://picsum.photos/seed/b/1200/800",
              {type:"video",src:"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.webm",caption:"Sample video"}
            ],
            snippets:[{title:"Body",body:"Here’s an image [[img:1]] in-line, then a video [[vid:3]], and later another image [[img:2]]."}]
          },
          { title:"1.2 — No tokens", preview:"Shows first media under text when no tokens.",
            images:["https://picsum.photos/seed/c/1200/800"],
            snippets:[{title:"Body",body:"No tokens here—first media appears below."}]
          }
        ]}
      ]
    };
  }

  boot();
})();
</script>
