<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Advice-Only® Bookstore (Preview)</title>
<meta name="robots" content="noindex,nofollow"/>

<meta name="ao-root" content="/ao-learn/"/>

<style>
  :root{
    --bg:#0b0d10;--panel:#12151a;--muted:#8ea1b2;--fg:#e8eef3;--brand:#00d0b6;
    --border:#1e242c;--hover:#171c24;--danger:#ff5d5d;--warn:#ffcc66;--ok:#25d18a
  }
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,sans-serif}
  a{color:var(--brand);text-decoration:none}

  /* Top bar */
  .top{position:sticky;top:0;z-index:50;background:#0c1015;border-bottom:1px solid var(--border)}
  .top-wrap{display:grid;grid-template-columns:220px 1fr 380px;gap:12px;align-items:center;padding:10px 16px}
  .logo{display:flex;align-items:center;gap:10px;font-weight:800}
  .logo img{height:26px;width:auto;display:block}
  .menu{display:flex;gap:6px;flex-wrap:wrap}
  .menu a{padding:6px 10px;border-radius:8px;color:#cfe0ee}
  .menu a[aria-current="page"], .menu a:hover{background:var(--hover)}
  .search{position:relative}
  .search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #233041;background:#0d131a;color:var(--fg)}
  .search .dd{position:absolute;inset:auto 0 auto 0;top:42px;background:#0f141b;border:1px solid #223042;border-radius:10px;max-height:50vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none}
  .search .dd.show{display:block}
  .search .res{padding:10px;border-bottom:1px dashed #223042;cursor:pointer}
  .search .res:hover{background:#131a23}
  .search .res small{display:block;color:#98a9ba;margin-top:4px}
  .search mark{background:transparent;color:#e4faff;border-bottom:1px solid #2c4655}

  /* Columns */
  .wrap{display:grid;grid-template-columns:280px 1fr 320px;gap:16px;min-height:calc(100vh - 58px);padding:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:10px}
  .nav{padding:12px;overflow:auto;max-height:calc(100vh - 98px)}
  .main{padding:16px;overflow:auto}
  .rail{padding:12px}

  /* Left nav */
  .nav h3{margin:12px 8px 6px;color:#bcd0e0;font-weight:600;font-size:13px}
  .nav ul{list-style:none;margin:0;padding:0}
  .nav li{margin:0}
  .nav button{display:block;width:100%;text-align:left;background:transparent;border:0;color:var(--fg);padding:8px 10px;border-radius:8px;cursor:pointer}
  .nav button:hover{background:var(--hover)}
  .nav .lo{padding-left:18px;color:#cfe0ee}
  .nav button[aria-current="true"]{background:#0e2723;outline:1px solid #11433b}
  .nav .meta-link{margin:12px 8px 6px;display:block;color:var(--muted);font-size:13px}
  .foot{margin:14px 8px 4px;color:#8ea1b2;font-size:12px;border-top:1px dashed #2a3340;padding-top:10px}
  .foot a{color:#9ab0c3;text-decoration:underline}

  /* Reader */
  .main h1{margin:0 0 14px;font-size:22px}
  .main h2{margin:20px 0 8px;font-size:16px}
  .main .lead{margin:0 0 16px;color:#c7d7e6}
  figure{margin:10px 0}
  figure img, figure video{display:block;max-width:100%;height:auto;border:1px solid var(--border);border-radius:10px;background:#000}
  figure figcaption{font-size:12px;color:#9ab0c3;margin-top:4px;line-height:1.3}

  /* Small components */
  .muted{color:var(--muted)}
  .kbd{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0d1117;padding:2px 6px;border-radius:6px;border:1px solid #222a33;color:#a3b4c5}
  .btn{display:inline-block;padding:8px 10px;border-radius:8px;border:1px solid #11433b;background:#0e2723;color:#e8eef3;text-decoration:none;font-weight:600;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .pill{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #2a3340;background:#0d1117;color:#9ab0c3}
  .cardlet{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px;margin:0 0 12px}
  .cardlet h4{margin:0 0 8px;color:#bcd0e0;font-weight:600;font-size:14px}
  .progress{height:10px;background:#0d1117;border:1px solid #222a33;border-radius:999px;overflow:hidden}
  .progress>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#00d0b6,#35e0a5)}

  /* Data table */
  .data-grid{display:grid;grid-template-columns:1fr;gap:12px}
  .data-table{width:100%;border-collapse:collapse;font-size:14px}
  .data-table th,.data-table td{padding:8px;border-bottom:1px dashed #2a3340}
  .data-table th{border-bottom:1px solid #2a3340;color:#bcd0e0;font-weight:600;text-align:left}
  .data-table td:last-child,.data-table th:last-child{text-align:right}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:-1px;margin-right:6px}
  .dot.red{background:var(--danger)} .dot.yellow{background:var(--warn)} .dot.green{background:var(--ok)}
  .legend{display:flex;gap:12px;align-items:center}
  .legend span{display:inline-flex;align-items:center;gap:6px;color:#9ab0c3;font-size:12px}

  @media (max-width:1100px){
    .top-wrap{grid-template-columns:1fr}
    .wrap{grid-template-columns:1fr}
    .nav{order:1}.main{order:2}.rail{order:3}
  }
</style>
</head>
<body>

  <header class="top" id="top">
    <div class="top-wrap">
      <div class="logo">
        <img src="/logo.svg" alt="" onerror="this.remove()"/>
        <a href="#home" id="brand">Advice-Only®</a>
      </div>
      <nav class="menu" id="menu">
        <a href="#home" data-route="home">Home</a>
        <a href="#data" data-route="data">My Data</a>
        <a href="#events" data-route="events">Events</a>
        <a href="#privacy" data-route="privacy">Privacy</a>
        <a href="#about" data-route="about">About</a>
      </nav>
      <div class="search" id="search">
        <input id="q" placeholder="Search or ask (Enter to view all)…" autocomplete="off"/>
        <div class="dd" id="dd"></div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <aside class="card nav" id="nav"><div class="muted">Loading…</div></aside>

    <main class="card main" id="main">
      <h1>Welcome</h1>
      <p class="lead">Select a learning objective from the left. Use the search above to jump to content.</p>
      <div class="muted">Data comes from <span class="kbd">site.json</span>. Add <span class="kbd">?full=1</span> to load <span class="kbd">full/site.json</span>.</div>
    </main>

    <aside class="card rail" id="rail">
      <div class="cardlet">
        <h4>Alerts</h4>
        <div class="muted">This panel is a placeholder for progress and events.</div>
      </div>
      <div class="cardlet" id="rail-events"></div>
      <div class="cardlet" id="rail-progress"></div>
    </aside>
  </div>

  <div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="Zoom" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:100">
    <button class="btn" id="lbClose" style="position:absolute;top:14px;right:14px">Close</button>
    <div id="lbSlot" style="max-width:92vw;max-height:92vh;margin:auto"></div>
  </div>

<script>
/* Surface any boot errors in the left nav */
window.addEventListener('error', (ev) => {
  try {
    const n = document.getElementById('nav');
    if (!n) return;
    n.innerHTML = '';
    const d = document.createElement('div');
    d.className = 'muted';
    d.textContent = 'Script error: ' + (ev.error?.message || ev.message || 'unknown');
    n.appendChild(d);
  } catch {}
});

(function(){
  // ---------- DOM ----------
  const NAV  = document.getElementById('nav');
  const MAIN = document.getElementById('main');
  const RAIL = document.getElementById('rail');
  const MENU = document.getElementById('menu');
  const SEARCH_BOX = document.getElementById('q');
  const SEARCH_DD  = document.getElementById('dd');
  const LB = document.getElementById('lightbox');
  const LB_SLOT = document.getElementById('lbSlot');
  const LB_CLOSE = document.getElementById('lbClose');

  // ---------- Config ----------
  const LS_SEEN = 'ao.v2.seen';
  const LS_TIME = 'ao.v2.time';
  const LS_LAST = 'ao.v2.last';
  const LS_QUIZ   = 'ao.v2.quiz';
  const LS_ASSESS = 'ao.v2.assess';
  const COMP_THRESH = { red:20, yellow:60 };

  const params = new URLSearchParams(location.search);
  const WANT_DEMO = params.get('demo') === '1';   // only show demo if requested
  const WANT_FULL = params.get('full') === '1';   // load /full/site.json

  // ---------- Helpers ----------
  const h=(t,a={},...c)=>{const e=document.createElement(t);
    for(const[k,v]of Object.entries(a)){
      if(k==='class')e.className=v;
      else if(k==='html')e.innerHTML=v;
      else if(k.startsWith('on')&&typeof v==='function')e.addEventListener(k.slice(2),v);
      else e.setAttribute(k,v);
    }
    c.forEach(x=>{ if(x!=null) e.appendChild(typeof x==='string'?document.createTextNode(x):x) });
    return e;
  };
  const num = s => s ? parseInt(s,10) : NaN;
  const tokenize = s => (s||'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(Boolean);
  const fmtDate=(iso,tz,time)=>{
    try{const dt=new Date(`${iso}T${time||'00:00'}:00`);
      const opt={dateStyle:'medium',timeStyle:time?'short':undefined};
      if(tz) opt.timeZone = tz;
      const s=new Intl.DateTimeFormat(undefined,opt).format(dt);
      return s + (tz?` (${(tz.split('/')[1]||tz)})`:'');
    }catch{ return iso+(time?` ${time}`:''); }
  };
  const loadJSON=(k,def)=>{ try{const v=JSON.parse(localStorage.getItem(k)||''); return v??def;}catch{ return def; } };
  const saveJSON=(k,v)=>localStorage.setItem(k, JSON.stringify(v));

  // ---------- State ----------
  const seen = new Set(loadJSON(LS_SEEN, []));
  const timeMap = loadJSON(LS_TIME, {});
  const quizResults   = loadJSON(LS_QUIZ,   {});
  const assessResults = loadJSON(LS_ASSESS, {});
  let currentTimer = null;
  let site=null, chapters=[], docs=[];

  // ---------- Timing ----------
  function startTiming(key){ stopTiming(); currentTimer={key,start:Date.now()}; localStorage.setItem(LS_LAST,key); }
  function stopTiming(){ if(!currentTimer) return; const dt=Math.max(0,Math.round((Date.now()-currentTimer.start)/1000)); timeMap[currentTimer.key]=(timeMap[currentTimer.key]||0)+dt; saveJSON(LS_TIME,timeMap); currentTimer=null; localStorage.removeItem(LS_LAST); }
  window.addEventListener('beforeunload', stopTiming);
  document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopTiming(); });
  (function recover(){ const last=localStorage.getItem(LS_LAST); if(last){ seen.add(last); saveJSON(LS_SEEN,[...seen]); localStorage.removeItem(LS_LAST); } })();

  // ---------- Ordering + labels ----------
  function chapterOrderIndex(ch, i) {
    if (typeof ch.index === 'number') return ch.index;
    const ct = (ch.title || '').trim();
    let m = /^Chapter\s+(\d+)/i.exec(ct);
    if (m) return num(m[1]);
    let best = Infinity;
    (ch.los||[]).forEach(lo=>{
      const t=(lo.title||'').trim();
      const matches = t.match(/\b(\d+\.\d+)\b/g);
      if(matches){matches.forEach(mm=>{
        const major=parseInt(mm.split('.')[0],10);
        if(!Number.isNaN(major)&&major<best)best=major;
      })};
    });
    return best !== Infinity ? best : 1000+i;
  }
  function loLabel(lo){
    const t=(lo.title||'').trim();
    const m=t.match(/(\d+\.\d+)/);
    if(m){
      const rest=t.replace(m[0],'').replace(/^[-—:\s]+/,'').trim();
      return `${m[0]} — ${rest||''}`.trim();
    }
    return t||'Untitled';
  }

  // ---------- Inline media (tokens) ----------
  function normalizeMedia(raw){
    const toItem = (x)=>{
      if(typeof x==='string'){
        if(/^https?:/i.test(x) && (/\.(mp4|webm|ogg)(\?|$)/i).test(x)) return {kind:'video',src:x};
        return {kind:'image',src:x};
      }
      if(x && typeof x==='object'){
        const kind = x.type==='video' || x.video ? 'video' : ((x.src||'').match(/\.(mp4|webm|ogg)(\?|$)/i) ? 'video':'image');
        return { kind, src:x.src, alt:x.alt||'', caption:x.caption||x.title||'' };
      }
      return null;
    };
    if(Array.isArray(raw)) return raw.map(toItem).filter(Boolean);
    if(!raw) return [];
    const one=toItem(raw); return one? [one] : [];
  }
  function extractTokenIndices(text, token){
    const re = token==='img' ? /\[\[img:(\d+)\]\]/gi : /\[\[vid:(\d+)\]\]/gi;
    const inds=[]; (text||'').replace(re,(_,n)=>{ inds.push(Math.max(1,parseInt(n,10))-1); return ''; });
    return inds;
  }
  function openZoom(node){
    LB_SLOT.innerHTML='';
    if(node.tagName==='IMG'){
      LB_SLOT.appendChild(h('img',{src:node.src, alt:node.alt||'', style:'max-width:92vw;max-height:92vh;border-radius:10px'}));
    }else if(node.tagName==='VIDEO'){
      const v = h('video',{src:node.currentSrc||node.src, controls:true, autoplay:true, style:'max-width:92vw;max-height:92vh;border-radius:10px'});
      LB_SLOT.appendChild(v);
    }
    LB.style.display='flex';
  }
  function closeZoom(){ LB.style.display='none'; LB_SLOT.innerHTML=''; }
  LB_CLOSE.addEventListener('click', closeZoom);
  LB.addEventListener('click', (e)=>{ if(e.target===LB) closeZoom(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeZoom(); });

  // ---------- QUIZ & ASSESSMENT ----------
  function valueSafe(s){ return String(s||'').replace(/[^a-zA-Z0-9_-]/g,'_'); }
  function saveQuizResult(id, payload){ quizResults[id] = payload; saveJSON(LS_QUIZ, quizResults); }
  function saveAssessResult(id, payload){ assessResults[id] = payload; saveJSON(LS_ASSESS, assessResults); }

  function renderQuiz(lo, key){
  const q = lo.quiz;
  if(!q || !Array.isArray(q.questions) || !q.questions.length) return;

  const host = h('div',{class:'cardlet'});
  host.appendChild(h('h4',{}, q.title || 'Quiz'));

  const prior = quizResults[q.id];
  const form  = h('form', {style:'margin-top:6px'});

  // Questions
  q.questions.forEach((qq,qi)=>{
    const fs = h('fieldset',{style:'border:0;border-top:1px dashed #2a3340;padding:10px 0;margin:8px 0 0'});
    fs.appendChild(h('div',{style:'font-weight:600;margin-bottom:6px'}, `${qi+1}. ${qq.text}`));
    (qq.options||[]).forEach((opt,oi)=>{
      const id = `${q.id}-q${qi}-o${oi}`;
      const lbl = h('label',{for:id,style:'display:flex;gap:8px;align-items:flex-start;margin:4px 0;cursor:pointer'});
      const rb  = h('input',{type:'radio',name:`q${qi}`,id:id.replace(/[^a-zA-Z0-9_-]/g,'_'),value:String(oi)});
      lbl.appendChild(rb);
      lbl.appendChild(h('span',{}, opt));
      fs.appendChild(lbl);
    });
    form.appendChild(fs);
  });

  // Submit row **inside the form**
  const buttonRow = h('div',{style:'margin-top:10px;display:flex;gap:8px;flex-wrap:wrap'});
  const submit    = h('button',{type:'submit',class:'btn'}, prior ? 'Retake quiz' : 'Submit quiz');
  buttonRow.appendChild(submit);
  form.appendChild(buttonRow);

  const status  = h('div',{class:'muted',style:'margin-top:6px'});
  host.append(form, status);
  MAIN.appendChild(host);

  const lockForm = (lock) => {
    form.querySelectorAll('input[type="radio"]').forEach(i=>{ i.disabled = lock; });
    submit.textContent = lock ? 'Retake quiz' : 'Submit quiz';
  };

  if (prior){
    status.textContent = `Last score: ${prior.score}/${prior.total}`;
    lockForm(true);
  }

  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    if(submit.textContent==='Retake quiz'){
      form.querySelectorAll('input[type="radio"]').forEach(i=>{ i.checked=false; });
      status.textContent = '';
      lockForm(false);
      return;
    }
    const answers = q.questions.map((_,qi)=>{
      const sel = form.querySelector(`input[name="q${qi}"]:checked`);
      return sel ? parseInt(sel.value,10) : -1;
    });
    let score=0;
    q.questions.forEach((qq,qi)=>{
      if(answers[qi]===qq.correctIndex) score++;
    });
    const res = { key, score, total:q.questions.length, answers, ts: Date.now() };
    saveQuizResult(q.id, res);
    status.textContent = `Score: ${score}/${q.questions.length}`;
    lockForm(true);
  });
}

 function renderAssessment(ch, chIdx){
  const a = ch.assessment;
  if(!a || !Array.isArray(a.items) || !a.items.length) return;

  const host = h('div',{class:'cardlet'});
  host.appendChild(h('h4',{}, a.title || 'Assessment'));
  if(a.intro) host.appendChild(h('p',{class:'muted',style:'margin-top:4px'}, a.intro));

  const prior = assessResults[a.id];
  const form  = h('form', {style:'margin-top:6px'});
  const min = a.scale?.min ?? 1, max = a.scale?.max ?? 5;

  a.items.forEach((it,ii)=>{
    const row = h('div',{style:'padding:8px 0;border-top:1px dashed #2a3340'});
    row.appendChild(h('div',{style:'font-weight:600;margin-bottom:6px'}, `${ii+1}. ${it.text}`));
    const opts = h('div',{style:'display:flex;gap:10px;flex-wrap:wrap'});
    for(let v=min; v<=max; v++){
      const id = `${a.id}-i${ii}-v${v}`;
      const lbl = h('label',{for:id,style:'display:flex;gap:6px;align-items:center;cursor:pointer'});
      const rb  = h('input',{type:'radio',name:`i${ii}`,id:id.replace(/[^a-zA-Z0-9_-]/g,'_'),value:String(v)});
      lbl.appendChild(rb);
      const tag = (v===min && a.scale?.labels?.[String(min)]) ? ` (${a.scale.labels[String(min)]})`
                : (v===max && a.scale?.labels?.[String(max)]) ? ` (${a.scale.labels[String(max)]})` : '';
      lbl.appendChild(h('span',{}, String(v)+tag));
      opts.appendChild(lbl);
    }
    row.appendChild(opts);
    form.appendChild(row);
  });

  // Submit row **inside the form**
  const buttonRow = h('div',{style:'margin-top:10px;display:flex;gap:8px;flex-wrap:wrap'});
  const submit    = h('button',{type:'submit',class:'btn'}, prior ? 'Retake assessment' : 'Submit assessment');
  buttonRow.appendChild(submit);
  form.appendChild(buttonRow);

  const status  = h('div',{class:'muted',style:'margin-top:6px'});
  host.append(form, status);
  MAIN.appendChild(host);

  const lockForm = (lock) => {
    form.querySelectorAll('input[type="radio"]').forEach(i=>{ i.disabled = lock; });
    submit.textContent = lock ? 'Retake assessment' : 'Submit assessment';
  };

  if (prior){
    status.textContent = `Last: total=${prior.sum}, avg=${prior.avg.toFixed(2)}`;
    lockForm(true);
  }

  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    if(submit.textContent==='Retake assessment'){
      form.querySelectorAll('input[type="radio"]').forEach(i=>{ i.checked=false; });
      status.textContent = '';
      lockForm(false);
      return;
    }
    const vals = a.items.map((_,ii)=>{
      const sel = form.querySelector(`input[name="i${ii}"]:checked`);
      return sel ? parseInt(sel.value,10) : 0;
    });
    const sum = vals.reduce((s,v)=>s+v,0);
    const avg = vals.length? sum/vals.length : 0;
    const res = { chapter: chIdx+1, values: vals, sum, avg, ts: Date.now() };
    saveAssessResult(a.id, res);
    status.textContent = `Saved: total=${sum}, avg=${avg.toFixed(2)}`;
    lockForm(true);
  });
}

  function downloadFile(name, text, mime='application/json'){
    const blob = new Blob([text], {type:mime});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  }

  function buildCSV(){
    const esc = s => `"${String(s??'').replace(/"/g,'""')}"`;
    const lines = [];

    // Quizzes (one row per question so selections are preserved)
    lines.push("type,quiz_id,lo_key,score,total,ts_iso,question_index,question_text,selected_index,selected_text");
    for(const [id,res] of Object.entries(quizResults||{})){
      const ts = new Date(res.ts||Date.now()).toISOString();
      (res.questionText||[]).forEach((qt,qi)=>{
        const selIdx = Array.isArray(res.answers) ? res.answers[qi] : "";
        const selTxt = Array.isArray(res.answersText) ? res.answersText[qi] : "";
        lines.push([
          "quiz", id, res.key||"", res.score, res.total, ts,
          qi, qt, selIdx, selTxt
        ].map(esc).join(","));
      });
    }

    // Assessments (one row per item)
    lines.push("type,assess_id,chapter,ts_iso,item_index,item_text,value,label,total,average");
    for(const [id,res] of Object.entries(assessResults||{})){
      const ts = new Date(res.ts||Date.now()).toISOString();
      (res.itemText||[]).forEach((txt,ii)=>{
        const val = Array.isArray(res.values) ? res.values[ii] : "";
        const lab = Array.isArray(res.valueLabels) ? res.valueLabels[ii] : "";
        lines.push([
          "assessment", id, res.chapter||"", ts, ii, txt, val, lab, res.sum, res.avg
        ].map(esc).join(","));
      });
    }

    return lines.join("\n");
  }

  // ---------- Reader ----------
  function renderMain(ch, lo, chIdx, loIdx){
    const key = `${chIdx+1}.${loIdx+1}`;
    if(!seen.has(key)){ seen.add(key); saveJSON(LS_SEEN,[...seen]); }
    stopTiming(); startTiming(key);

    MAIN.innerHTML='';
    MAIN.append(
      h('h1',{}, `${ch.title || 'Chapter'} — ${lo.title || 'Learning Objective'}`),
      h('p',{class:'lead'}, lo.preview || 'This is preview text for this learning objective.')
    );

    // media pool (LO + snippet media)
    const pool = [
      ...normalizeMedia(lo.images),
      ...normalizeMedia(lo.image||lo.img)
    ];
    (lo.snippets||[]).forEach(s=>{
      pool.push(...normalizeMedia(s.images), ...normalizeMedia(s.image||s.img));
    });

    // Render first snippet text
    const s = (lo.snippets||[])[0];
    let body = s?.body || '';
    if (s?.title) MAIN.append(h('h2',{}, s.title));

    // Tokens: [[img:n]] and [[vid:n]]
    const imgTokens = extractTokenIndices(body,'img').filter(i=>pool[i] && pool[i].kind==='image');
    const vidTokens = extractTokenIndices(body,'vid').filter(i=>pool[i] && pool[i].kind==='video');

    // Strip tokens from text and append
    const stripped = body.replace(/\[\[(img|vid):\d+\]\]/gi,'').replace(/\s{2,}/g,' ').trim();
    if(stripped) MAIN.append(h('p',{}, stripped));

    // Insert tokened media in order
    const addFigure = (item)=>{
      const fig=h('figure');
      if(item.kind==='image'){
        const im = h('img',{src:item.src, alt:item.alt||''});
        im.addEventListener('dblclick', ()=>openZoom(im));
        fig.appendChild(im);
      }else{
        const v = h('video',{src:item.src, controls:true});
        v.addEventListener('dblclick', ()=>openZoom(v));
        fig.appendChild(v);
      }
      if(item.caption) fig.appendChild(h('figcaption',{}, item.caption));
      MAIN.appendChild(fig);
    };

    [...imgTokens.map(i=>({i,kind:'img'})), ...vidTokens.map(i=>({i,kind:'vid'}))]
      .sort((a,b)=>a.i-b.i)
      .forEach(t => addFigure(pool[t.i]));

    // If no tokens, but media exists, show the first media once
    if(imgTokens.length===0 && vidTokens.length===0 && pool[0]) addFigure(pool[0]);

    // Quiz & Assessment panels
    try { renderQuiz(lo, key); } catch {}
    try { renderAssessment(ch, chIdx); } catch {}

    // Fallback copy
    if(!s && !pool.length){
      MAIN.append(h('div',{class:'muted'}, 'Data source: site.json.'));
    }
  }

  function buildLeftNav(){
    NAV.innerHTML='';
    const list=h('ul');
    chapters.forEach((ch,chIdx)=>{
      list.append(h('h3',{}, ch.title || `Chapter ${chIdx+1}`));
      (ch.los||[]).forEach((lo,loIdx)=>{
        const btn=h('button',{
          class:'lo',
          onclick:()=>{
            renderMain(ch,lo,chIdx,loIdx);
            location.hash=`#ch${chIdx+1}-lo${loIdx+1}`;
            setActiveLO(btn);
            refreshRail();
          }
        }, loLabel(lo));
        list.append(h('li',{}, btn));
      });
    });
    NAV.append(list, h('a',{href:'#data',class:'meta-link'},'→ Open My Data'));

    const year = new Date().getFullYear();
    const foot = h('div',{class:'foot',id:'foot'});
    foot.appendChild(h('div',{html:`©${year} Hall Financial Services, Inc. d/b/a ADVICE ONLY.`}));
    foot.appendChild(h('div',{}, h('a',{href:'https://adviceonly.info/important-disclosures-and-privacy/',target:'_blank',rel:'noopener'}, 'Privacy')));
    NAV.appendChild(foot);
  }

  function setActiveLO(btn){
    NAV.querySelectorAll('button[aria-current="true"]').forEach(b=>b.setAttribute('aria-current','false'));
    btn?.setAttribute('aria-current','true');
    btn?.scrollIntoView({block:'nearest', inline:'nearest'});
  }
  function openFromHash(){
    const m=location.hash.match(/^#ch(\d+)-lo(\d+)$/);
    const ch=chapters[(m?+m[1]:1)-1];
    const lo=ch?.los?.[(m?+m[2]:1)-1];
    if(ch && lo){
      renderMain(ch,lo,(m?+m[1]:1)-1,(m?+m[2]:1)-1);
      const btns = NAV.querySelectorAll('button.lo');
      let flat=0,target=0;
      chapters.forEach((c)=>{(c.los||[]).forEach((l)=>{ if(c===ch&&l===lo) target=flat; flat++; });});
      setActiveLO(btns[target]);
      return true;
    }
    return false;
  }

  // ---------- Rail ----------
  function totals(){
    let total=0; (chapters||[]).forEach(ch=> total+=(ch.los?.length||0));
    let done=0; for(const k of seen){
      const [ci,li]=(k||'').split('.').map(Number);
      if(chapters?.[ci-1]?.los?.[li-1]) done++;
    }
    return {done,total,pct: total? Math.round((done/total)*100) : 0};
  }
  function refreshRail(){
    const evHost = document.getElementById('rail-events');
    const progHost = document.getElementById('rail-progress');

    // Events
    evHost.innerHTML = '<h4>Next event</h4>';
    const list=Array.isArray(site?.events)?site.events.slice():[];
    if(!list.length){ evHost.appendChild(h('div',{class:'muted'},'No events')); }
    else{
      list.sort((a,b)=> new Date(`${a.date}T${a.time||'00:00'}:00`) - new Date(`${b.date}T${b.time||'00:00'}:00`));
      const ev=list.find(e=> new Date(`${e.date}T${e.time||'00:00'}:00`)>=new Date()) || list[0];
      evHost.appendChild(h('div',{class:'muted'}, fmtDate(ev.date, ev.tz, ev.time)));
      evHost.appendChild(h('div',{style:'font-weight:600;margin-top:4px'}, ev.title || 'Event'));
      if(ev.mode) evHost.appendChild(h('div',{class:'muted',style:'margin-top:2px'}, ev.mode));
      if(ev.ctaUrl && ev.ctaLabel) evHost.appendChild(h('div',{style:'margin-top:8px'}, h('a',{href:ev.ctaUrl,class:'btn',target:'_blank',rel:'noopener'}, ev.ctaLabel)));
    }

    // Progress
    const {done,total,pct}=totals();
    progHost.innerHTML = '<h4>Your progress</h4>';
    progHost.appendChild(h('div',{class:'muted'}, `${done} of ${total} (${pct}%)`));
    progHost.appendChild(h('div',{class:'progress',style:'margin-top:6px'}, h('i',{style:`width:${pct}%;`})));
  }

  // ---------- Pages ----------
  function setActiveMenu(){
    const r = (location.hash.replace('#','') || 'home').split(':')[0];
    MENU.querySelectorAll('a').forEach(a=>{
      a.setAttribute('aria-current', a.dataset.route===r ? 'page' : 'false');
    });
  }
  function renderHome(){
    stopTiming();
    MAIN.innerHTML='';
    MAIN.append(
      h('h1',{}, site?.title || site?.book || 'Advice-Only®'),
      h('p',{class:'lead'}, 'Welcome. Browse chapters on the left, or use search above.')
    );
    const {done,total,pct}=totals();
    MAIN.append(
      h('div',{class:'cardlet'},
        h('h4',{},'At a glance'),
        h('div',{class:'muted'}, `${done} of ${total} learning objectives viewed`),
        h('div',{class:'progress',style:'margin-top:6px'}, h('i',{style:`width:${pct}%;`})),
        h('div',{style:'margin-top:10px;display:flex;gap:8px;flex-wrap:wrap'},
          h('a',{href:'#data',class:'btn'},'Open My Data'),
          h('a',{href:'#events',class:'btn'},'View Events')
        )
      )
    );
  }
  function renderEvents(){
    stopTiming();
    MAIN.innerHTML='';
    MAIN.append(h('h1',{},'Events'), h('p',{class:'lead'},'Upcoming and past sessions.'));
    const list=Array.isArray(site?.events)?site.events.slice():[];
    if(!list.length){ MAIN.append(h('div',{class:'muted'},'No events found.')); return; }
    list.sort((a,b)=> new Date(`${a.date}T${a.time||'00:00'}:00`) - new Date(`${b.date}T${b.time||'00:00'}:00`));
    list.forEach(e=>{
      MAIN.append(h('div',{class:'cardlet'},
        h('div',{style:'font-weight:600'}, e.title || 'Event'),
        h('div',{class:'muted'}, fmtDate(e.date, e.tz, e.time)),
        e.mode ? h('div',{class:'muted'}, e.mode): null,
        (e.ctaUrl && e.ctaLabel) ? h('div',{style:'margin-top:6px'}, h('a',{href:e.ctaUrl,class:'btn',target:'_blank',rel:'noopener'}, e.ctaLabel)) : null
      ));
    });
  }
  function renderPrivacy(){
    stopTiming();
    MAIN.innerHTML='';
    MAIN.append(
      h('h1',{},'Privacy'),
      h('p',{class:'lead'}, 'Local-only analytics; nothing leaves your browser.')
    );
    MAIN.append(
      h('div',{class:'cardlet'},
        h('h4',{},'What is stored'),
        h('p',{},'Completion status and time-on-page for each learning objective (via localStorage).'),
        h('p',{},'Clear your data in My Data with “Clear progress” and “Clear time”.')
      )
    );
  }
  function renderAbout(){
    stopTiming();
    MAIN.innerHTML='';
    MAIN.append(h('h1',{},'About'));
    const a = site?.about || site?.profile || null;
    if(!a){ MAIN.append(h('div',{class:'muted'},'No about/profile information in site.json.')); return; }
    const name = a.name || '';
    const location = a.location || a.address || '';
    const bio = a.bio || a.subtitle || '';
    const specialties = Array.isArray(a.specialties) ? a.specialties : (a.specialty ? [a.specialty] : []);
    MAIN.append(
      h('div',{class:'cardlet'},
        h('div',{style:'font-size:18px;font-weight:700'}, name),
        location ? h('div',{class:'muted',style:'margin-top:2px'}, location) : null,
        bio ? h('p',{style:'margin-top:8px'}, bio) : null,
        specialties.length ? h('div',{style:'margin-top:6px'}, h('span',{class:'pill'}, `Specialties: ${specialties.join(', ')}`)) : null,
        (a.ctaUrl && a.ctaLabel) ? h('div',{style:'margin-top:12px'}, h('a',{href:a.ctaUrl,class:'btn',target:'_blank',rel:'noopener'}, a.ctaLabel)) : null
      )
    );
  }

  function renderMyData(){
    stopTiming();
    const compColor = secs => secs < COMP_THRESH.red ? 'red' : (secs < COMP_THRESH.yellow ? 'yellow' : 'green');

    const agg = Object.entries(timeMap).reduce((acc,[,s])=>{
      const c=compColor(s); acc[c]++; acc.totalSecs+=s; return acc;
    }, {red:0,yellow:0,green:0,totalSecs:0});
    const {done,total,pct} = totals();

    MAIN.innerHTML='';
    MAIN.append(
      h('h1',{},'My Data'),
      h('p',{class:'lead'},'Local-only engagement, quiz results, and assessments (nothing leaves your browser).')
    );

    MAIN.append(
      h('div',{class:'data-grid'},
        h('div',{class:'cardlet'},
          h('h4',{},'Overall progress'),
          h('div',{class:'muted'}, `${done} of ${total} viewed (${pct}%)`),
          h('div',{class:'progress',style:'margin-top:6px'}, h('i',{style:`width:${pct}%;`}))
        ),
        h('div',{class:'cardlet'},
          h('h4',{},'Engagement balance'),
          h('div',{class:'legend',style:'margin-top:4px'},
            h('span',{}, h('i',{class:'dot red'}),'Under 20s'),
            h('span',{}, h('i',{class:'dot yellow'}),'20–59s'),
            h('span',{}, h('i',{class:'dot green'}),'60s+')
          ),
          h('div',{class:'muted',style:'margin-top:8px'}, `Total time: ${Math.round(agg.totalSecs/60)} min`)
        )
      )
    );

    const table=h('table',{class:'data-table', style:'margin-top:8px'});
    table.innerHTML=`<thead>
      <tr><th>Chapter / LO</th><th style="text-align:right">Time (s)</th><th style="text-align:right">Status</th></tr>
    </thead><tbody></tbody>`;
    const tb=table.querySelector('tbody');

    (chapters||[]).forEach((ch,ci)=>{
      const title = ch.title || `Chapter ${ci+1}`;
      let chTime=0;
      (ch.los||[]).forEach((_,li)=>{ chTime += (timeMap[`${ci+1}.${li+1}`]||0); });
      tb.appendChild(h('tr',{},
        h('td',{style:'font-weight:600'}, title),
        h('td',{style:'text-align:right'}, String(chTime)),
        h('td',{style:'text-align:right'}, '')
      ));
      (ch.los||[]).forEach((lo,li)=>{
        const key=`${ci+1}.${li+1}`, secs=(timeMap[key]||0);
        const color=compColor(secs);
        tb.appendChild(h('tr',{},
          h('td',{}, h('span',{class:'muted'}, `${key} `), lo.title || `LO ${li+1}`),
          h('td',{style:'text-align:right'}, String(secs)),
          h('td',{style:'text-align:right'}, h('i',{class:`dot ${color}`},''))
        ));
      });
    });
    MAIN.append(table);

    const quizCard = h('div',{class:'cardlet',style:'margin-top:12px'});
    quizCard.appendChild(h('h4',{},'Quizzes'));
    if(Object.keys(quizResults||{}).length===0){
      quizCard.appendChild(h('div',{class:'muted'},'No quiz attempts yet.'));
    }else{
      const qt = h('table',{class:'data-table',style:'margin-top:6px'});
      qt.innerHTML = `<thead><tr>
        <th>Quiz ID</th><th>Score</th><th>When</th><th>LO Key</th>
      </tr></thead><tbody></tbody>`;
      const qtb = qt.querySelector('tbody');
      Object.entries(quizResults).forEach(([id,res])=>{
        const when = new Date(res.ts||Date.now()).toLocaleString();
        qtb.appendChild(h('tr',{},
          h('td',{}, id),
          h('td',{}, `${res.score}/${res.total}`),
          h('td',{}, when),
          h('td',{}, res.key||'')
        ));
      });
      quizCard.appendChild(qt);
    }
    MAIN.append(quizCard);

    const assessCard = h('div',{class:'cardlet',style:'margin-top:12px'});
    assessCard.appendChild(h('h4',{},'Assessments'));
    if(Object.keys(assessResults||{}).length===0){
      assessCard.appendChild(h('div',{class:'muted'},'No assessments yet.'));
    }else{
      const at = h('table',{class:'data-table',style:'margin-top:6px'});
      at.innerHTML = `<thead><tr>
        <th>Assessment ID</th><th>Total</th><th>Average</th><th>Chapter</th><th>When</th>
      </tr></thead><tbody></tbody>`;
      const atb = at.querySelector('tbody');
      Object.entries(assessResults).forEach(([id,res])=>{
        const when = new Date(res.ts||Date.now()).toLocaleString();
        atb.appendChild(h('tr',{},
          h('td',{}, id),
          h('td',{}, String(res.sum)),
          h('td',{}, (res.avg??0).toFixed(2)),
          h('td',{}, String(res.chapter||'')),
          h('td',{}, when)
        ));
      });
      assessCard.appendChild(at);
    }
    MAIN.append(assessCard);

    MAIN.append(h('div',{style:'margin-top:12px;display:flex;gap:8px;flex-wrap:wrap'},
      h('button',{class:'btn',onclick:()=>{ localStorage.removeItem(LS_SEEN); seen.clear(); refreshRail(); renderMyData(); }},'Clear progress'),
      h('button',{class:'btn',onclick:()=>{ localStorage.removeItem(LS_TIME); for(const k in timeMap) delete timeMap[k]; renderMyData(); }},'Clear time'),
      h('button',{class:'btn',onclick:()=>{ localStorage.removeItem(LS_QUIZ); for(const k in quizResults) delete quizResults[k]; renderMyData(); }},'Clear quizzes'),
      h('button',{class:'btn',onclick:()=>{ localStorage.removeItem(LS_ASSESS); for(const k in assessResults) delete assessResults[k]; renderMyData(); }},'Clear assessments'),
      h('button',{class:'btn',onclick:()=>{
        const payload = { seen:[...seen], timeMap, quizResults, assessResults };
        downloadFile('my-data.json', JSON.stringify(payload,null,2), 'application/json');
      }},'Download JSON'),
      h('button',{class:'btn',onclick:()=>{ downloadFile('my-data.csv', buildCSV(), 'text/csv'); }},'Download CSV'),
      h('a',{href:'#home',class:'btn'},'Back to Home')
    ));
  }

  // ---------- Search ----------
  function buildDocs(){
    docs = [];
    (chapters||[]).forEach((ch,ci)=>{
      (ch.los||[]).forEach((lo,li)=>{
        const fields = [];
        if (lo.title)   fields.push({text:lo.title, w:3});
        if (lo.preview) fields.push({text:lo.preview, w:2});
        (lo.snippets||[]).forEach(s=>{
          if (s.title) fields.push({text:s.title, w:2});
          if (s.body)  fields.push({text:s.body,  w:1});
        });
        docs.push({ ci, li, chTitle: ch.title||`Chapter ${ci+1}`, loTitle: lo.title||`LO ${li+1}`, fields });
      });
    });
  }
  function scoreDoc(qTokens, doc){
    let score=0;
    for(const f of doc.fields){
      const fTokens = tokenize(f.text);
      for(const qt of qTokens){
        const hits = fTokens.filter(t=>t===qt).length;
        if (hits) score += hits * f.w;
      }
    }
    const lt=(doc.loTitle||'').toLowerCase();
    if(qTokens.some(q=>lt.includes(q))) score+=2;
    return score;
  }
  function hilite(text, qTokens){
    if(!text) return '';
    let out = text;
    qTokens.forEach(q=>{
      const esc = q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      out = out.replace(new RegExp(`(${esc})`,'ig'), '<mark>$1</mark>');
    });
    return out;
  }
  function showSearchDD(results, qTokens){
    SEARCH_DD.innerHTML='';
    if(!results.length){ SEARCH_DD.classList.remove('show'); return; }
    results.slice(0,8).forEach(r=>{
      const pv = (chapters[r.ci].los[r.li].snippets?.[0]?.body) || (chapters[r.ci].los[r.li].preview) || '';
      SEARCH_DD.appendChild(
        h('div',{class:'res', onclick:()=>{ location.hash = `#ch${r.ci+1}-lo${r.li+1}`; SEARCH_DD.classList.remove('show'); SEARCH_BOX.blur(); }},
          h('div',{html: hilite(`${r.chTitle} — ${r.loTitle}`, qTokens)}),
          h('small',{html: hilite(pv, qTokens)})
        )
      );
    });
    SEARCH_DD.classList.add('show');
  }
  function runSearch(q, mode){
    const qTokens = tokenize(q);
    if(!qTokens.length){ SEARCH_DD.classList.remove('show'); return; }
    const results = docs.map(d=>{
      const pv = (chapters[d.ci].los[d.li].snippets?.[0]?.body) || (chapters[d.ci].los[d.li].preview) || '';
      return { ...d, score: scoreDoc(qTokens, d), preview: pv };
    }).filter(r=>r.score>0).sort((a,b)=>b.score-a.score);

    if(mode==='dd'){ showSearchDD(results, qTokens); return; }
    stopTiming();
    SEARCH_DD.classList.remove('show');
    MAIN.innerHTML='';
    MAIN.append(h('h1',{},'Search'), h('p',{class:'lead'}, `Results for “${q}”`));
    if(!results.length){ MAIN.append(h('div',{class:'muted'},'No matches.')); return; }
    results.slice(0,30).forEach(r=>{
      MAIN.append(h('div',{class:'cardlet'},
        h('div',{style:'font-weight:600',html: hilite(`${r.chTitle} — ${r.loTitle}`, qTokens)}),
        h('p',{class:'muted',html: hilite(r.preview || '', qTokens)}),
        h('div',{}, h('a',{href:`#ch${r.ci+1}-lo${r.li+1}`,class:'btn'},'Open'))
      ));
    });
  }
  SEARCH_BOX.addEventListener('input', e=>{
    const q=e.target.value.trim();
    if(!q){ SEARCH_DD.classList.remove('show'); return; }
    runSearch(q,'dd');
  });
  SEARCH_BOX.addEventListener('keydown', e=>{
    if(e.key==='Enter'){
      const q=SEARCH_BOX.value.trim();
      if(q){ location.hash = '#search:' + encodeURIComponent(q); }
    }else if(e.key==='Escape'){
      SEARCH_DD.classList.remove('show');
    }
  });
  document.addEventListener('click', (e)=>{
    if(!document.getElementById('search').contains(e.target)){ SEARCH_DD.classList.remove('show'); }
  });

  // ---------- Boot ----------
  async function loadSiteJSON(){
    const metaRoot = document.querySelector('meta[name="ao-root"]')?.content ?? '/';
    const base = WANT_FULL ? 'full/site.json' : 'site.json';
    const candidates = [];
    const add=(u)=>{ if(!candidates.includes(u)) candidates.push(u); };
    // Prefer metaRoot, but try robust fallbacks for file:// and subpaths.
    add((metaRoot||'') + base);
    add(base);
    add('/' + base);

    const errs=[];
    for(const u of candidates){
      try{
        const res=await fetch(u, {cache:'no-store', credentials:'same-origin'});
        if(res.ok){ return JSON.parse(await res.text()); }
        errs.push(`${u} -> HTTP ${res.status}`);
      }catch(e){ errs.push(`${u} -> ${e.message||e}`); }
    }
    throw new Error(errs.join(' | '));
  }

  async function boot(){
    try{
      site = await loadSiteJSON();
    }catch(e){
      if(!WANT_DEMO){
        NAV.innerHTML='';
        NAV.append(h('div',{class:'muted'}, `Could not load site.json (${e.message||e}).`));
        site = { title:'', chapters:[], events:[] };
      }else{
        site = makeDemoSite();
      }
    }

    chapters=(site.chapters||[])
      .map((ch,i)=>({ch,ord:chapterOrderIndex(ch,i)}))
      .sort((a,b)=>a.ord-b.ord)
      .map(x=>x.ch);

    buildLeftNav();
    buildDocs();
    refreshRail();

    route();
    window.addEventListener('hashchange', route);
  }

  function route(){
    setActiveMenu();
    const hash = location.hash || '#home';
    if (/^#ch\d+-lo\d+$/.test(hash)) { if(!openFromHash()) renderHome(); return; }
    if (hash.startsWith('#home'))     { renderHome(); return; }
    if (hash.startsWith('#data'))     { renderMyData(); return; }
    if (hash.startsWith('#events'))   { renderEvents(); return; }
    if (hash.startsWith('#privacy'))  { renderPrivacy(); return; }
    if (hash.startsWith('#about'))    { renderAbout(); return; }
    if (hash.startsWith('#search:'))  { runSearch(decodeURIComponent(hash.split(':')[1]||''),'page'); return; }
    if(chapters[0]?.los?.length){ location.hash = '#ch1-lo1'; openFromHash(); } else { renderHome(); }
  }

  // ---------- Demo (only if ?demo=1 and fetch fails) ----------
  function makeDemoSite(){
    return {
      title:"Demo Samples",
      alerts:["Demo is enabled via ?demo=1. Remove the query parameter to hide."],
      events:[{title:"Live Q&A",date:"2026-01-08",time:"13:00",tz:"America/New_York",mode:"Zoom",ctaUrl:"#",ctaLabel:"Details"}],
      chapters:[
        { title:"Demo Samples", los:[
          { title:"1.1 — Inline tokens", preview:"Two images and one short video, tokenized.",
            images:[
              "https://picsum.photos/seed/a/1200/800",
              "https://picsum.photos/seed/b/1200/800",
              {type:"video",src:"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.webm",caption:"Sample video"}
            ],
            snippets:[{title:"Body",body:"Here’s an image [[img:1]] in-line, then a video [[vid:3]], and later another image [[img:2]]."}]
          }
        ]}
      ]
    };
  }

  boot();
})();
</script>

</body>
</html>
}