<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Advice-Only® Learning Management System (Preview)</title>
  <meta name="robots" content="noindex,nofollow"/>
  <meta name="ao-root" content="/"/>

  <link rel="stylesheet" href="static/css/ao-ui.css"/>

  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
  <link rel="preconnect" href="https://www.clarity.ms" crossorigin>

  <link href="static/js/vendor/survey/survey-core.min.css" rel="stylesheet"/>
<script src="static/js/vendor/survey/survey.core.min.js"></script>
<script src="static/js/vendor/survey/survey-js-ui.min.js"></script>
<script></script></head>
<body>

  <header class="top" id="top">
    <div class="top-wrap">
      <div class="logo">
        <img src="static/brand/ao-teal-logo.png" alt="AO Logo" onerror="this.remove()"/>
        <a href="#home" id="brand">Advice-Only®</a>
      </div>
      <nav class="menu" id="menu">
        <a href="#home" data-route="home">Home</a>
        <a href="#data" data-route="data">My Data</a>
        <a href="#events" data-route="events">Events</a>
        <a href="#privacy" data-route="privacy">Privacy</a>
        <a href="#about" data-route="about">About</a>
      </nav>
      <div class="search" id="search">
        <input id="q" aria-label="Search or ask" placeholder="Search or ask (Enter to view all)…" autocomplete="off"/>
        <div class="dd" id="dd"></div>
      </div>
      <button id="theme-toggle" aria-label="Toggle theme">
        <svg class="icon-dark" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <title>Activate light mode</title>
          <circle cx="12" cy="12" r="5"></circle>
          <path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 7.05-1.41-1.41M6.46 6.46 5.05 5.05m13.9 0-1.41 1.41M6.46 17.54 5.05 18.95"></path>
        </svg>
        <svg class="icon-light" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <title>Activate dark mode</title>
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
    </div>
  </header>

  <div class="wrap">
    <aside class="card nav" id="nav"><div class="muted">Loading…</div></aside>

    <main class="card main" id="main">
      <h1>Welcome</h1>
      <p class="lead">Select a learning objective from the left. Use the search above to jump to content.</p>
      <div class="muted">Data comes from <span class="kbd">site.json</span>. Add <span class="kbd">?full=1</span> to load <span class="kbd">full/site.json</span>.</div>
    </main>

    <aside class="card rail" id="rail">
      <div class="cardlet">
        <h4>Alerts</h4>
        <div class="muted">This panel is a placeholder for progress and events.</div>
      </div>
      <div class="cardlet" id="rail-events"></div>
      <div class="cardlet" id="rail-progress"></div>
    </aside>
  </div>

  <div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="Zoom" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:100">
    <button class="btn" id="lbClose" style="position:absolute;top:14px;right:14px">Close</button>
    <div id="lbSlot" style="max-width:92vw;max-height:92vh;margin:auto"></div>
  </div>

  <div class="ao-modal__panel" id="aoModal" hidden>
    <div class="ao-modal__head">
      <h3 id="aoModalTitle" style="font-weight:600">Loading...</h3>
      <button class="ao-modal__close" aria-label="Close">×</button>
    </div>
    <div id="aoSurveyContainer"></div>
  </div>
<!-- AO: assessments/quizzes patch + boot + router -->
  <script src="scripts/ao-patch.js"></script>
  <script>
  (async function boot(){
    const params = new URLSearchParams(location.search);
    const url = params.has('full') ? 'full/site.json' : 'site.json';
    try {
      const r = await fetch(url);
      if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
      const v2 = await r.json();

      const miniAdapt = (v2) => ({
        chapters: (v2.chapters || []).map(ch => ({
          title: ch.title || ch.slug || 'Chapter',
          assessment: ch.assessment || null,
          los: (ch.sections || []).map(sec => ({
            title: sec.title || sec.h2_id || 'Learning Objective',
            snippets: [
              ...(sec.section_public_html
                  ? [{ title: 'Overview', body: (sec.section_public_html||'').replace(/<[^>]+>/g,' ') }]
                  : []),
              ...((sec.sub_objectives || [])
                  .filter(so => (so.type || so.kind) === 'quiz' && so.quiz)
                  .map(so => ({ type:'quiz', title: so.title || 'Quick Check', quiz: so.quiz })))
            ]
          }))
        }))
      });
      const adapt =
        (typeof window.__ao_adaptV2ToLegacy === 'function' && window.__ao_adaptV2ToLegacy) ||
        (typeof window.__ao_patch_preAdapt === 'function' && (x => window.__ao_patch_preAdapt(x))) ||
        miniAdapt;

      const site = adapt(v2);
      window.__AO_SITE = site;

      const left = document.getElementById('nav') || document.querySelector('.card');
      const parts = [];
      (site.chapters || []).forEach((ch, ci) => {
        parts.push(`<div class="muted" style="margin:.5rem 0;font-weight:600">${(ch.title||'Chapter')}</div>`);
        (ch.los || []).forEach((lo, li) => {
          parts.push(`<a href="#c${ci}l${li}" class="nav-lo" style="display:block;margin:.25rem 0">${(lo.title||'Learning Objective')}</a>`);
        });
      });
      if (left) left.innerHTML = parts.join('') || '<div class="muted">No content.</div>';
    } catch(err) {
      const left = document.getElementById('nav') || document.querySelector('.card');
      if (left) left.innerHTML = '<div class="muted">Failed to load site.json</div>';
      console.error(err);
    }
  })();
  </script>

  <script>
    function getMainEl() {
      return document.getElementById('main')
          || document.querySelector('#content')
          || document.querySelector('.card.main')
          || (function () {
              const div = document.createElement('div');
              div.className = 'card main';
              div.style.marginTop = '1rem';
              document.body.appendChild(div);
              return div;
            })();
    }
    function escapeHTML(s){ return (s||'').replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

    function renderLO(ci, li) {
      const site = window.__AO_SITE;
      const ch = site?.chapters?.[ci];
      const lo = ch?.los?.[li];
      const main = getMainEl();
      if (!ch || !lo) { main.innerHTML = '<div class="muted">Select a learning objective from the left.</div>'; return; }
      let html = `<h2 style="margin-bottom:.5rem">${escapeHTML(lo.title || 'Learning Objective')}</h2>`;
      (lo.snippets || []).forEach(sn => {
        if (sn.type === 'quiz' && sn.quiz && sn.quiz.src) {
          html += `<div class="cardlet"><strong>Quick check</strong><br>
                   <button class="btn" data-quiz="\${escapeHTML(sn.quiz.src)}">Take quiz</button></div>`;
        } else if (sn.body) {
          html += `<p>\${escapeHTML(sn.body)}</p>`;
        } else if (sn.title) {
          html += `<p>\${escapeHTML(sn.title)}</p>`;
        }
      });
      if (ch.assessment && ch.assessment.src) {
        html += `<div class="cardlet" style="margin-top:1rem">
                 <strong>Chapter assessment</strong><br>
                 <button class="btn" data-assessment="\${escapeHTML(ch.assessment.src)}">Start assessment</button>
                 </div>`;
      }
      main.innerHTML = html;
    }

    function onRoute() {
      const m = location.hash.match(/^#c(\d+)l(\d+)$/);
      if (m) renderLO(+m[1], +m[2]);
    }
    window.addEventListener('hashchange', onRoute);
    onRoute();

    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-quiz],[data-assessment]');
      if (!btn) return;
      e.preventDefault();
      const src = btn.dataset.quiz || btn.dataset.assessment;
      try {
        const r = await fetch(src);
        if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
        const json = await r.json();

        const lb = document.getElementById('lightbox') || (function () {
          const el = document.createElement('div');
          el.id = 'lightbox';
          el.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:9999';
          el.addEventListener('click', (ev)=>{ if (ev.target===el) el.remove(); });
          document.body.appendChild(el);
          return el;
        })();
        lb.innerHTML = '';
        const panel = document.createElement('div');
        panel.style.cssText = 'max-width:90vw;max-height:80vh;background:#1a1a1a;color:#ddd;padding:16px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.4)';
        panel.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>\${btn.dataset.quiz ? 'Quiz' : 'Assessment'}</strong>
          <button class="btn" onclick="this.closest('#lightbox').remove()">Close</button>
        </div>`;
        const pre = document.createElement('pre');
        pre.style.cssText = 'max-height:60vh;overflow:auto;padding:12px;background:#111;border-radius:12px';
        pre.textContent = JSON.stringify(json, null, 2);
        panel.appendChild(pre);
        lb.appendChild(panel);
      } catch (err) {
        alert('Failed to load ' + src + '\n' + err.message);
      }
    });
  </script>
</body>
</html>
