<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Advice-Only® Learning Management System (Preview)</title>
  <meta name="robots" content="noindex,nofollow"/>
  <meta name="ao-root" content="/"/>

  <link rel="stylesheet" href="static/css/ao-ui.css"/>

  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
  <link rel="preconnect" href="https://www.clarity.ms" crossorigin>

  <!-- SurveyJS (CDN) -->
  <script src="https://unpkg.com/survey-core@1.9.162/survey.core.min.js"></script>
  <script src="https://unpkg.com/survey-knockout-ui@1.9.162/survey-knockout-ui.min.js"></script>
  <link href="https://unpkg.com/survey-core@1.9.162/defaultV2.min.css" rel="stylesheet"/>

  <!-- Analytics script (unchanged) -->
  <script>
  (function(){
    const GA_ID='G-C2E79R93CQ', CLARITY_ID='t38u1ekrco', LS_KEY='analytics_consent';
    const GPC=(typeof navigator!=='undefined' && navigator.globalPrivacyControl===true);
    const prior=(typeof localStorage!=='undefined')?localStorage.getItem(LS_KEY):null;
    const consentOn=prior?(prior==='on'):!GPC;
    function loadGA(){if(!GA_ID||window.__gaLoaded) return;window.__gaLoaded=true;
      const s=document.createElement('script');s.async=true;
      s.src='https://www.googletagmanager.com/gtag/js?id='+encodeURIComponent(GA_ID);
      document.head.appendChild(s);
      window.dataLayer=window.dataLayer||[];
      function gtag(){dataLayer.push(arguments);} window.gtag=gtag;
      gtag('js',new Date()); gtag('config',GA_ID,{anonymize_ip:true});
    }
    function loadClarity(){if(!CLARITY_ID||window.__clarityLoaded) return;window.__clarityLoaded=true;
      (function(c,l,a,r,i,t,y){c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments);};
       t=l.createElement(r);t.async=1;t.src='https://www.clarity.ms/tag/'+i;
       y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window,document,'clarity','script',CLARITY_ID);
    }
    function enable(){try{localStorage.setItem(LS_KEY,'on');}catch{} loadGA(); loadClarity();}
    function disable(){try{localStorage.setItem(LS_KEY,'off');}catch{}}
    consentOn ? enable() : disable();
    window.AOAnalytics={enable,disable,isOn:()=>localStorage?.getItem(LS_KEY)==='on'};
  })();
  </script>
</head>
<body>
  <!-- header / layout unchanged ... -->

  <script>
  /* Boot error surface */
  window.addEventListener('error', ev=>{
    try{const n=document.getElementById('nav');if(n){n.innerHTML='';
      const d=document.createElement('div');d.className='muted';
      d.textContent='Script error: '+(ev.error?.message||ev.message||'unknown');n.appendChild(d);}}catch{}
  });

  (function(){
    /* ----- DOM ----- */
    const NAV=document.getElementById('nav'), MAIN=document.getElementById('main'),
          RAIL=document.getElementById('rail'), MENU=document.getElementById('menu'),
          SEARCH_BOX=document.getElementById('q'), SEARCH_DD=document.getElementById('dd');

    /* ----- Config ----- */
    const LS_SEEN='ao.v2.seen', LS_TIME='ao.v2.time', LS_LAST='ao.v2.last',
          LS_QUIZ='ao.v2.quiz', LS_ASSESS='ao.v2.assess';
    const COMP_THRESH={red:20,yellow:60};
    const params=new URLSearchParams(location.search);
    const WANT_DEMO=params.get('demo')==='1';
    const WANT_FULL=params.get('full')==='1';

    /* ----- Helpers, state, timing … (unchanged) ----- */

    /* ----- QUIZ & ASSESSMENT RENDERERS ----- */
    function saveQuizResult(id,payload){quizResults[id]=payload;saveJSON(LS_QUIZ,quizResults);}
    function saveAssessResult(id,payload){assessResults[id]=payload;saveJSON(LS_ASSESS,assessResults);}

    function renderQuiz(lo,key){
      const surveyJson=lo.quiz; if(!surveyJson) return;
      const host=h('div',{class:'cardlet',style:'margin-top:20px;'}); MAIN.appendChild(host);
      Survey.StylesManager.applyTheme('defaultV2');
      const survey=new Survey.Model(surveyJson);
      survey.onComplete.add(sender=>{
        saveQuizResult(lo.quiz.id||`quiz_${key}`,{
          key,score:sender.getCorrectAnswerCount(),
          total:sender.getQuestionCount(),answers:sender.data,ts:Date.now()
        });
      });
      survey.render(host);
    }

    function renderAssessment(ch,chIdx){
      const surveyJson=ch.assessment; if(!surveyJson) return;
      const host=document.getElementById('survey-container'); if(!host) return;
      Survey.StylesManager.applyTheme('defaultV2');
      const survey=new Survey.Model(surveyJson);
      survey.onComplete.add(sender=>{
        saveAssessResult(ch.assessment.id||`assess_ch${chIdx+1}`,{
          chapter:chIdx+1,answers:sender.data,ts:Date.now()
        });
      });
      survey.render(host);
    }

    /* ----- rest of file: renderMain, renderMyData, search, boot, etc. (unchanged) ----- */

    async function loadSiteJSON(){
      const metaRoot=document.querySelector('meta[name="ao-root"]')?.content??'/';
      const base=WANT_FULL?'full/site.json':'site.json';
      const urls=[metaRoot+base,base,'/'+base];
      for(const u of urls){try{const res=await fetch(u,{cache:'no-store'});if(res.ok)return res.json();}catch{}}
      throw new Error('site.json not found');
    }

    async function boot(){
      try{site=await loadSiteJSON();}catch(e){
        if(!WANT_DEMO){NAV.innerHTML='';NAV.append(h('div',{class:'muted'},`Could not load site.json (${e.message})`));site={chapters:[],events:[]};}
        else{site=makeDemoSite();}
      }
      chapters=(site.chapters||[]).map((ch,i)=>({ch,ord:chapterOrderIndex(ch,i)}))
                .sort((a,b)=>a.ord-b.ord).map(x=>x.ch);
      buildLeftNav(); buildDocs(); refreshRail(); route();
      window.addEventListener('hashchange',route);
    }

    function route(){
      setActiveMenu();
      const hash=location.hash||'#home';
      if(/^#ch\d+-lo\d+$/.test(hash)){if(!openFromHash())renderHome();return;}
      if(/^#ch\d+-assessment$/.test(hash)){if(!openFromHash())renderHome();return;}
      if(hash.startsWith('#home')) return renderHome();
      if(hash.startsWith('#data')) return renderMyData();
      if(hash.startsWith('#events')) return renderEvents();
      if(hash.startsWith('#privacy')) return renderPrivacy();
      if(hash.startsWith('#about')) return renderAbout();
      if(hash.startsWith('#search:')) return runSearch(decodeURIComponent(hash.split(':')[1]||''),'page');
      chapters[0]?.los?.length ? (location.hash='#ch1-lo1', openFromHash()) : renderHome();
    }

    boot();
  })();
  </script>

  <!-- privacy popup & analytics allow button scripts (unchanged) -->
</body>
</html>
