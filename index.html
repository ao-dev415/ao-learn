<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Advice-Only(r) Bookstore (Preview)</title>
  <meta name="robots" content="noindex,nofollow"/>

  <style>
    :root{--bg:#0b0d10;--panel:#12151a;--muted:#8ea1b2;--fg:#e8eef3;--brand:#00d0b6;--border:#1e242c;--hover:#171c24}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,sans-serif}
    a{color:var(--brand);text-decoration:none}

    /* layout */
    .wrap{display:grid;grid-template-columns:280px 1fr 320px;gap:16px;min-height:100vh;padding:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px}
    .nav{padding:12px;overflow:auto;max-height:calc(100vh - 32px)}
    .main{padding:16px;overflow:auto}
    .rail{padding:12px}

    /* left nav */
    .nav h3{margin:12px 8px 6px;color:#bcd0e0;font-weight:600;font-size:13px}
    .nav ul{list-style:none;margin:0;padding:0}
    .nav li{margin:0}
    .nav button{display:block;width:100%;text-align:left;background:transparent;border:0;color:var(--fg);padding:8px 10px;border-radius:8px;cursor:pointer}
    .nav button:hover{background:var(--hover)}
    .nav .lo{padding-left:18px;color:#cfe0ee}
    .nav button[aria-current="true"]{background:#0e2723;outline:1px solid #11433b}

    /* main content */
    .main h1{margin:0 0 14px;font-size:22px}
    .main h2{margin:20px 0 8px;font-size:16px}
    .main .lead{margin:0 0 16px;color:#c7d7e6}

    /* right rail base */
    .rail h4{margin:0 0 8px;color:#bcd0e0;font-weight:600}
    .muted{color:var(--muted)}
    .kbd{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0d1117;padding:2px 6px;border-radius:6px;border:1px solid #222a33;color:#a3b4c5}

    /* small components used by the rail + data page */
    .btn{display:inline-block;padding:8px 10px;border-radius:8px;border:1px solid #11433b;background:#0e2723;color:#e8eef3;text-decoration:none;font-weight:600;cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .pill{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #2a3340;background:#0d1117;color:#9ab0c3}
    .cardlet{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px;margin:0 0 12px}
    .cardlet h4{margin:0 0 8px;color:#bcd0e0;font-weight:600;font-size:14px}
    .progress{height:10px;background:#0d1117;border:1px solid #222a33;border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#00d0b6,#35e0a5)}

    /* My Data table + small nav link */
    .data-table{width:100%;border-collapse:collapse;font-size:14px}
    .data-table th,.data-table td{padding:8px;border-bottom:1px dashed #2a3340}
    .data-table th{border-bottom:1px solid #2a3340;color:#bcd0e0;font-weight:600;text-align:left}
    .data-table td:last-child,.data-table th:last-child{text-align:right}
    .nav .meta-link{margin:12px 8px 6px;display:block;color:var(--muted);font-size:13px}
    .nav .meta-link button{width:auto;display:inline-block;padding:6px 10px}

    @media (max-width:1100px){.wrap{grid-template-columns:1fr}.rail{order:3}.nav{order:1}.main{order:2}}
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="card nav" id="nav"><div class="muted">Loading…</div></aside>

    <main class="card main" id="main">
      <h1>Welcome</h1>
      <p class="lead">Select a learning objective from the left.</p>
      <div class="muted">If blank, check <span class="kbd">site.json</span> in Network, then hard-reload.</div>
    </main>

    <aside class="card rail" id="rail">
      <div class="muted">Loading cards…</div>
    </aside>
  </div>

  <!-- ===== Working chapter/LO loader (left nav + main) ===== -->
  <script>
  (async () => {
    const navEl = document.getElementById('nav');
    const mainEl = document.getElementById('main');

    const h = (t,a={},...c)=>{const e=document.createElement(t);
      for(const[k,v]of Object.entries(a)){
        if(k==='class')e.className=v;
        else if(k.startsWith('on')&&typeof v==='function')e.addEventListener(k.slice(2),v);
        else e.setAttribute(k,v)
      }
      for(const x of c){ if(x!=null) e.appendChild(typeof x==='string'?document.createTextNode(x):x); }
      return e
    };
    const num = s => s ? parseInt(s,10) : NaN;
    const pickUrl = ()=> new URL(location.href).searchParams.get('full')==='1' ? '/full/site.json' : '/site.json';

    function chapterOrderIndex(ch, i) {
      if (typeof ch.index === 'number') return ch.index;
      const ct = (ch.title || '').trim();
      let m = /^Chapter\s+(\d+)/i.exec(ct);
      if (m) return num(m[1]);
      let best = Infinity;
      (ch.los||[]).forEach(lo=>{
        const t=(lo.title||'').trim();
        const matches=t.match(/\b(\d+\.\d+)\b/g);
        if(matches){matches.forEach(mm=>{
          const major=parseInt(mm.split('.')[0],10);
          if(!Number.isNaN(major)&&major<best)best=major;
        })}
      });
      return best !== Infinity ? best : 1000+i;
    }
    function loLabel(lo){
      const t=(lo.title||'').trim();
      const m=t.match(/(\d+\.\d+)/);
      if(m){
        const rest=t.replace(m[0],'').replace(/^[-—:\s]+/,'').trim();
        return `${m[0]} — ${rest||''}`.trim();
      }
      return t||'Untitled';
    }
    function setActive(btn){
      navEl.querySelectorAll('button[aria-current="true"]').forEach(b=>b.setAttribute('aria-current','false'));
      btn?.setAttribute('aria-current','true');
      btn?.scrollIntoView({block:'nearest', inline:'nearest'});
    }
    function renderMain(ch, lo){
      mainEl.innerHTML='';
      mainEl.append(
        h('h1',{}, `${ch.title || 'Chapter'} — ${lo.title || 'Learning Objective'}`),
        h('p',{class:'lead'}, lo.preview || 'This is preview text for this learning objective.')
      );
      const s = lo.snippets && lo.snippets[0];
      if(s){
        if(s.title) mainEl.append(h('h2',{}, s.title));
        if(s.body)  mainEl.append(h('p',{}, s.body));
      } else {
        mainEl.append(h('div',{class:'muted'}, 'Data source: site.json.'));
      }
    }

    // load site.json
    let site;
    try{
      const res = await fetch(pickUrl(), { cache:'no-store', credentials:'same-origin' });
      if(!res.ok) throw new Error(`site.json ${res.status}`);
      site = await res.json();
    }catch(e){
      navEl.innerHTML='';
      navEl.append(h('div',{class:'muted'}, `Could not load site.json (${String(e)}).`));
      console.error(e);
      return;
    }

    // build left nav
    const chapters = (site.chapters||[])
      .map((ch,i)=>({ch,ord:chapterOrderIndex(ch,i)}))
      .sort((a,b)=>a.ord-b.ord)
      .map(x=>x.ch);

    navEl.innerHTML='';
    const list=h('ul');
    chapters.forEach((ch,chIdx)=>{
      list.append(h('h3',{}, ch.title || `Chapter ${chIdx+1}`));
      (ch.los||[]).forEach((lo,loIdx)=>{
        const btn=h('button',{
          class:'lo',
          onclick:()=>{
            renderMain(ch,lo);
            location.hash=`#ch${chIdx+1}-lo${loIdx+1}`;
            setActive(btn);
          }
        }, loLabel(lo));
        list.append(h('li',{}, btn));
      });
    });
    navEl.append(list);

    function openFromHash(){
      const m=location.hash.match(/^#ch(\d+)-lo(\d+)$/);
      const ch=chapters[(m?+m[1]:1)-1];
      const lo=ch?.los?.[(m?+m[2]:1)-1];
      if(ch && lo){
        renderMain(ch,lo);
        const btns=navEl.querySelectorAll('button.lo');
        let flat=0,target=0;
        chapters.forEach((c)=>{(c.los||[]).forEach((l)=>{ if(c===ch && l===lo) target=flat; flat++; });});
        setActive(btns[target]);
        return true;
      }
      return false;
    }
    window.addEventListener('hashchange', openFromHash);
    if(!openFromHash()){
      location.hash='#ch1-lo1';
      openFromHash();
    }
  })();
  </script>

  <!-- ===== Rail cards + My Data add-on (events/profile/progress + #data) ===== -->
  <script>
  (function(){
    const NAV  = document.getElementById('nav');
    const MAIN = document.getElementById('main');
    const RAIL = document.getElementById('rail');
    if (!NAV || !MAIN || !RAIL) return;

    const LS_KEY='ao.v1.seen';
    const HASH_RE=/^#ch(\d+)-lo(\d+)$/;

    const h=(t,a={},...c)=>{const e=document.createElement(t);
      for(const[k,v]of Object.entries(a)){
        if(k==='class')e.className=v;
        else if(k==='html')e.innerHTML=v;
        else if(k.startsWith('on')&&typeof v==='function')e.addEventListener(k.slice(2),v);
        else e.setAttribute(k,v)
      }
      c.forEach(x=>x!=null && e.appendChild(typeof x==='string'?document.createTextNode(x):x));
      return e
    };
    const pickUrl=()=> new URL(location.href).searchParams.get('full')==='1'?'/full/site.json':'/site.json';
    const pct=(n,d)=>d>0?Math.max(0,Math.min(100,Math.round((n/d)*100))):0;
    const fmtDate=(iso,tz,time)=>{
      try{const dt=new Date(`${iso}T${time||'00:00'}:00`);
        const opt={dateStyle:'medium',timeStyle:time?'short':undefined};
        if(tz) opt.timeZone=tz;
        const str=new Intl.DateTimeFormat(undefined,opt).format(dt);
        return str+(tz?` (${(tz.split('/')[1]||tz)})`:'');
      }catch(_){return iso+(time?` ${time}`:'')}
    };

    const loadSeen=()=>{try{return new Set(JSON.parse(localStorage.getItem(LS_KEY)||'[]'))}catch{return new Set()}};
    const saveSeen=(set)=>localStorage.setItem(LS_KEY, JSON.stringify([...set]));
    const seen=loadSeen();

    function markSeenFromHash(site){
      const m=location.hash.match(HASH_RE);
      if(!m) return false;
      const ch=+m[1], lo=+m[2];
      const chObj=site.chapters?.[ch-1];
      const loObj=chObj?.los?.[lo-1];
      if(!loObj) return false;
      const key=`${ch}.${lo}`;
      if(!seen.has(key)){ seen.add(key); saveSeen(seen); }
      return true;
    }
    function totals(site){
      let total=0; (site.chapters||[]).forEach(ch=> total+=(ch.los?.length||0));
      let done=0; for(const k of seen){
        const [ci,li]=(k||'').split('.').map(Number);
        if(site.chapters?.[ci-1]?.los?.[li-1]) done++;
      }
      return {done,total,pct:pct(done,total)};
    }

    function railAlerts(site){
      const msg=(site.alerts && site.alerts[0]) || 'This panel is a placeholder for progress, recent items, etc.';
      return h('div',{class:'cardlet'}, h('h4',{},'Alerts'), h('div',{class:'muted'},msg));
    }
    function railProfile(site){
      if(!site.profile) return null;
      const p=site.profile;
      return h('div',{class:'cardlet'},
        h('h4',{},'Profile'),
        h('div',{},
          h('div',{style:'font-weight:600'}, p.name||''),
          h('div',{class:'muted'}, p.subtitle||''),
          p.mode ? h('div',{style:'margin-top:6px'}, h('span',{class:'pill'},p.mode)) : null,
          (p.ctaUrl && p.ctaLabel) ? h('div',{style:'margin-top:8px'}, h('a',{href:p.ctaUrl,class:'btn',target:'_blank',rel:'noopener'},p.ctaLabel)) : null
        )
      );
    }
    function railNextEvent(site){
      const list=Array.isArray(site.events)?site.events.slice():[];
      if(!list.length) return null;
      const now=new Date();
      list.sort((a,b)=> new Date(`${a.date}T${a.time||'00:00'}:00`) - new Date(`${b.date}T${b.time||'00:00'}:00`));
      const ev=list.find(e=> new Date(`${e.date}T${e.time||'00:00'}:00`)>=now) || list[0];
      return h('div',{class:'cardlet'},
        h('h4',{},'Next event'),
        h('div',{class:'muted'}, fmtDate(ev.date, ev.tz, ev.time)),
        h('div',{style:'font-weight:600;margin-top:4px'}, ev.title || 'Event'),
        ev.mode ? h('div',{class:'muted',style:'margin-top:2px'}, ev.mode) : null,
        (ev.ctaUrl && ev.ctaLabel) ? h('div',{style:'margin-top:8px'}, h('a',{href:ev.ctaUrl,class:'btn',target:'_blank',rel:'noopener'}, ev.ctaLabel)) : null
      );
    }
    function railProgress(site){
      const {done,total,pct:pp}=totals(site);
      return h('div',{class:'cardlet'},
        h('h4',{},'Your progress'),
        h('div',{class:'muted'}, `${done} of ${total} (${pp}%)`),
        h('div',{class:'progress',style:'margin-top:6px'}, h('i',{style:`width:${pp}%;`}))
      );
    }
    function renderRail(site){
      RAIL.innerHTML='';
      RAIL.appendChild(railAlerts(site));
      const prof=railProfile(site); if(prof) RAIL.appendChild(prof);
      const nxt=railNextEvent(site); if(nxt) RAIL.appendChild(nxt);
      RAIL.appendChild(railProgress(site));
    }

    function renderMyData(site){
      const {done,total,pct:pp}=totals(site);
      const rows=(site.chapters||[]).map((ch,i)=>{
        const count=(ch.los?.length||0);
        let seenCount=0; for(let li=1; li<=count; li++){ if(seen.has(`${i+1}.${li}`)) seenCount++; }
        return {title: ch.title || `Chapter ${i+1}`, seen: seenCount, total: count};
      });
      const table=h('table',{class:'data-table'});
      table.innerHTML=`
        <thead><tr><th>Chapter</th><th>Seen</th><th>Total</th></tr></thead>
        <tbody></tbody>`;
      const tb=table.querySelector('tbody');
      rows.forEach(r=>{
        tb.appendChild(h('tr',{},
          h('td',{}, r.title),
          h('td',{style:'text-align:right'}, String(r.seen)),
          h('td',{style:'text-align:right'}, String(r.total))
        ));
      });

      MAIN.innerHTML='';
      MAIN.append(
        h('h1',{},'My Data'),
        h('p',{class:'lead'},'Local-only progress saved in your browser.'),
        h('div',{class:'cardlet'},
          h('div',{class:'muted'}, `${done} of ${total} completed (${pp}%)`),
          h('div',{class:'progress',style:'margin-top:6px'}, h('i',{style:`width:${pp}%;`}))
        ),
        table,
        h('div',{style:'margin-top:12px;display:flex;gap:8px'},
          h('button',{class:'btn',onclick:()=>{ seen.clear(); localStorage.removeItem(LS_KEY); location.reload(); }},'Clear progress')
        )
      );
    }

    function addMyDataLink(){
      const link=h('a',{class:'meta-link',href:'#data'},
        h('button',{},'Open My Data')
      );
      NAV.appendChild(link);
    }

    async function boot(){
      let site;
      try{
        const res=await fetch(pickUrl(), {cache:'no-store', credentials:'same-origin'});
        const txt=await res.text();
        site=JSON.parse(txt);
      }catch(_){ return; }

      markSeenFromHash(site);
      renderRail(site);
      addMyDataLink();

      window.addEventListener('hashchange', ()=>{
        if(location.hash==='#data'){
          renderMyData(site);
        }else if(markSeenFromHash(site)){
          renderRail(site);
        }
      });
    }
    boot();
  })();
  </script>
</body>
</html>
