<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Advice-Only(r) Courses (Preview)</title>
  <meta name="robots" content="noindex,nofollow"/>
  <style>
    :root{
      --bg:#0b0d10;--panel:#12151a;--muted:#8ea1b2;--fg:#e8eef3;--brand:#00d0b6;
      --border:#1e242c;--hover:#171c24;--danger:#ff6b6b
    }
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,sans-serif}
    a{color:var(--brand);text-decoration:none}
    .wrap{display:grid;grid-template-columns:280px 1fr 320px;gap:16px;min-height:100vh;padding:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px}
    .nav{padding:12px;overflow:auto;max-height:calc(100vh - 32px)}
    .nav h3{margin:12px 8px 6px;color:#bcd0e0;font-weight:600;font-size:13px}
    .nav ul{list-style:none;margin:0;padding:0}
    .nav li{margin:0}
    .nav button{display:block;width:100%;text-align:left;background:transparent;border:0;color:var(--fg);padding:8px 10px;border-radius:8px;cursor:pointer}
    .nav button:hover{background:var(--hover)}
    .nav .lo{padding-left:18px;color:#cfe0ee}
    .nav button[aria-current="true"]{background:#0e2723;outline:1px solid #11433b}
    .main{padding:16px;overflow:auto}
    .main h1{margin:0 0 14px;font-size:22px}
    .main h2{margin:20px 0 8px;font-size:16px}
    .main .lead{margin:0 0 16px;color:#c7d7e6}
    .rail{padding:12px;overflow:auto;max-height:calc(100vh - 32px)}
    .rail h4{margin:16px 0 8px;color:#bcd0e0;font-weight:600}
    .alert{border:1px solid var(--border);padding:12px;border-radius:10px;color:#c7d7e6}
    .muted{color:var(--muted)}
    .kbd{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0d1117;padding:1px 6px;border-radius:6px;border:1px solid #222a33;color:#a3b4c5}
    .btn{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:8px}
    .btn:hover{background:var(--hover)}
    .cardlet{border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px}
    .progress{background:#0d1117;border:1px solid var(--border);border-radius:8px;height:10px;overflow:hidden;margin-top:6px}
    .progress i{display:block;height:100%;background:var(--brand);width:0%}
    .pill{display:inline-block;font-size:12px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;margin-left:6px;color:#cfe0ee}
    .danger{color:var(--danger)}
    @media (max-width:1100px){.wrap{grid-template-columns:1fr}.rail{order:3}.nav{order:1}.main{order:2}}
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="card nav" id="nav"><div class="muted">Loading…</div></aside>

    <main class="card main" id="main">
      <h1>Welcome</h1>
      <p class="lead">Select a learning objective from the left.</p>
      <div class="muted">If blank, check <span class="kbd">site.json</span> in Network, then hard-reload.</div>
    </main>

    <aside class="card rail" id="rail">
      <h4>Alerts</h4>
      <div class="alert">“Site accessibility tutorial” lives here for now. Later: notifications for subscribed users.</div>
    </aside>
  </div>

  <script>
  (async () => {
    const navEl = document.getElementById('nav');
    const mainEl = document.getElementById('main');
    const railEl = document.getElementById('rail');

    // --- helpers ---
    const h = (t,a={},...c)=>{const e=document.createElement(t);
      for(const[k,v]of Object.entries(a)){if(k==='class')e.className=v;
        else if(k==='html')e.innerHTML=v;
        else if(k.startsWith('on')&&typeof v==='function')e.addEventListener(k.slice(2),v);
        else e.setAttribute(k,v)}
      for(const x of c){if(x!=null)e.appendChild(typeof x==='string'?document.createTextNode(x):x)}
      return e};
    const num = s => s ? parseInt(s,10) : NaN;
    const pct = (n, d) => d>0 ? Math.max(0, Math.min(100, Math.round((n/d)*100))) : 0;

    // choose site.json (supports ?full=1)
    function pickUrl(){
      const u = new URL(location.href);
      return u.searchParams.get('full')==='1' ? '/full/site.json' : '/site.json';
    }

    // chapter sort index
    function chapterOrderIndex(ch, i) {
      if (typeof ch.index === 'number') return ch.index;
      const ct = (ch.title || '').trim();
      let m = /^Chapter\s+(\d+)/i.exec(ct);
      if (m) return num(m[1]);
      let best = Infinity;
      (ch.los||[]).forEach(lo=>{
        const t=(lo.title||'').trim();
        const matches = t.match(/\b(\d+\.\d+)\b/g);
        if(matches){matches.forEach(mm=>{
          const major=parseInt(mm.split('.')[0],10);
          if(!Number.isNaN(major)&&major<best)best=major;
        });}
      });
      return best !== Infinity ? best : 1000+i;
    }

    // LO label from "N.N rest"
    function loLabel(lo) {
      const t = (lo.title || '').trim();
      const m = t.match(/(\d+\.\d+)/);
      if (m) {
        const rest = t.replace(m[0],'').replace(/^[-—:\s]+/,'').trim();
        return `${m[0]} — ${rest || ''}`.trim();
      }
      return t || 'Untitled';
    }

    function setActive(btn){
      navEl.querySelectorAll('button[aria-current="true"]').forEach(b=>b.setAttribute('aria-current','false'));
      btn?.setAttribute('aria-current','true');
      btn?.scrollIntoView({block:'nearest', inline:'nearest'});
    }

    function renderMain(ch, lo){
      mainEl.innerHTML = '';
      mainEl.append(
        h('h1', {}, `${ch.title || 'Chapter'} — ${lo.title || 'Learning Objective'}`),
        h('p', {class:'lead'}, lo.preview || 'This is preview text for this learning objective.')
      );
      const snips = lo.snippets || [];
      snips.forEach(s=>{
        if (s.title) mainEl.append(h('h2', {}, s.title));
        if (s.body)  mainEl.append(h('p', {}, s.body));
        if (s.image) {
          const fig = h('figure', {style:'margin:12px 0'});
          fig.append(h('img', {src:s.image.src, alt:s.image.alt||'', style:'max-width:100%;border-radius:8px'}));
          if (s.image.caption) fig.append(h('figcaption', {class:'muted'}, s.image.caption));
          mainEl.append(fig);
        }
      });
      if (!snips.length) mainEl.append(h('div', {class:'muted'}, 'Data source: site.json.'));
    }

    function renderRail(site){
      railEl.innerHTML = '';

      // Alerts
      if (Array.isArray(site.alerts) && site.alerts.length){
        railEl.append(h('h4', {}, 'Alerts'));
        site.alerts.forEach(msg => railEl.append(h('div', {class:'cardlet'}, msg)));
      }

      // Profile
      if (site.profile){
        const p = site.profile;
        const top = h('div', {class:'cardlet'});
        top.append(
          h('div', {style:'display:flex;justify-content:space-between;align-items:center;gap:8px'},
            h('div', {},
              h('div', {style:'font-weight:600'}, p.name || ''),
              h('div', {class:'muted'}, p.subtitle || '')
            ),
            p.mode ? h('span', {class:'pill'}, p.mode) : null
          ),
          (p.ctaUrl && p.ctaLabel) ? h('div', {style:'margin-top:8px'},
            h('a', {href:p.ctaUrl, class:'btn'}, p.ctaLabel)
          ) : null
        );
        railEl.append(h('h4', {}, 'Profile'), top);
      }

      // Progress
      if (site.progress){
        const pr = site.progress;
        const done = Number(pr.completed||0), total = Number(pr.total||0);
        const percent = pct(done,total);
        const box = h('div', {class:'cardlet'},
          h('div', {style:'display:flex;justify-content:space-between'},
            h('div', {}, 'Progress'),
            h('div', {class:'muted'}, `${done}/${total}`)
          ),
          h('div', {class:'progress'}, h('i', {style:`width:${percent}%`}))
        );
        railEl.append(h('h4', {}, 'Progress'), box);
      }

      // Events
      if (Array.isArray(site.events) && site.events.length){
        railEl.append(h('h4', {}, 'Events'));
        site.events.forEach(ev=>{
          railEl.append(
            h('div', {class:'cardlet'},
              h('div', {style:'font-weight:600'}, ev.title || 'Event'),
              h('div', {class:'muted', style:'margin-top:2px'},
                [ev.date, ev.time, ev.tz].filter(Boolean).join(' · ')
              ),
              (ev.ctaUrl && ev.ctaLabel) ? h('div', {style:'margin-top:8px'},
                h('a', {href:ev.ctaUrl, class:'btn'}, ev.ctaLabel)
              ) : null
            )
          );
        });
      }

      // Fallback
      if (!railEl.children.length){
        railEl.append(h('h4', {}, 'Alerts'),
          h('div', {class:'alert'}, 'This panel is a placeholder for progress, recent items, etc.'));
      }
    }

    // --- fetch site.json ---
    let site, res, txt;
    const url = pickUrl();
    try {
      res = await fetch(url, { cache:'no-store', credentials:'same-origin' });
      txt = await res.text();
      if (!res.ok) throw new Error(`Fetch ${res.status} ${res.statusText}`);
      try { site = JSON.parse(txt); }
      catch(e){ throw new Error('JSON parse error: '+e.message); }
    } catch (e) {
      navEl.innerHTML = '';
      navEl.append(h('div', {class:'muted danger'}, `Could not load ${url}: ${String(e.message||e)}`));
      return;
    }

    // Sort chapters
    const chapters = (site.chapters||[])
      .map((ch,i)=>({ch,ord:chapterOrderIndex(ch,i)}))
      .sort((a,b)=>a.ord-b.ord)
      .map(x=>x.ch);

    // Build left nav
    navEl.innerHTML = '';
    const list = h('ul');
    chapters.forEach((ch, chIdx) => {
      list.append(h('h3', {}, ch.title || `Chapter ${chIdx+1}`));
      (ch.los||[]).forEach((lo, loIdx) => {
        const btn = h('button', {
          class:'lo',
          onclick: () => {
            renderMain(ch, lo);
            location.hash = `#ch${chIdx+1}-lo${loIdx+1}`;
            setActive(btn);
          }
        }, loLabel(lo));
        list.append(h('li', {}, btn));
      });
    });
    navEl.append(list);

    // Right rail cards
    renderRail(site);

    // Deep link / hash routing
    function openFromHash(){
      const m = location.hash.match(/^#ch(\d+)-lo(\d+)$/);
      const ch = chapters[(m?+m[1]:1)-1];
      const lo = ch?.los?.[(m?+m[2]:1)-1];
      if (ch && lo) {
        renderMain(ch, lo);
        // mark active btn
        const btns = navEl.querySelectorAll('button.lo');
        let flat = 0, target = 0;
        chapters.forEach((c)=>{(c.los||[]).forEach((l)=>{ if (c===ch && l===lo) target=flat; flat++; });});
        setActive(btns[target]);
        return true;
      }
      return false;
    }
    window.addEventListener('hashchange', openFromHash);
    if (!openFromHash()) { location.hash = '#ch1-lo1'; openFromHash(); }

    // Optional mini debug with ?debug=1
    if (new URL(location.href).searchParams.get('debug')==='1'){
      const box = h('div', {style:'position:fixed;left:16px;bottom:16px;max-width:520px;z-index:9999;background:#11161e;border:1px solid #3a4453;border-radius:10px;padding:10px'});
      box.append(
        h('div', {style:'font-weight:600;margin-bottom:6px'}, 'JSON Diagnose'),
        h('pre', {style:'margin:0;white-space:pre-wrap'}, `URL: ${url}
book: ${site.title||site.book||'(none)'}
chapters: ${(site.chapters||[]).length}
keys: ${Object.keys(site).join(', ')}`)
      );
      document.body.append(box);
    }

    // Build marker for quick verification
    console.log('BUILD B5 rail-cards active');
  })();
  </script>
</body>
</html>
