<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Advice-Only® Learning Management System (Preview)</title>
  <meta name="robots" content="noindex,nofollow"/>
  <meta name="ao-root" content="/"/>

  <link rel="stylesheet" href="static/css/ao-ui.css"/>

  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
  <link rel="preconnect" href="https://www.clarity.ms" crossorigin>

  <link href="static/js/vendor/survey/survey-core.min.css" rel="stylesheet"/>
  <script src="static/js/vendor/survey/survey.core.min.js"></script>
  <script src="static/js/vendor/survey/survey-js-ui.min.js"></script>

  <script>
  (function() {
    const GA_ID = 'G-C2E79R93CQ';
    const CLARITY_ID = 't38u1ekrco';

    function loadGA() {
      if (!GA_ID || window.__gaLoaded) return;
      window.__gaLoaded = true;
      var s = document.createElement('script');
      s.async = true;
      s.src = 'https://www.googletagmanager.com/gtag/js?id=' + encodeURIComponent(GA_ID);
      document.head.appendChild(s);
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', GA_ID, { anonymize_ip: true });
    }

    function loadClarity() {
      if (!CLARITY_ID || window.__clarityLoaded) return;
      window.__clarityLoaded = true;
      (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){ (c[a].q=c[a].q||[]).push(arguments); };
        t=l.createElement(r); t.async=1; t.src='https://www.clarity.ms/tag/' + i;
        y=l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t,y);
      })(window, document, 'clarity', 'script', CLARITY_ID);
    }
    
    window.loadGA = loadGA;
    window.loadClarity = loadClarity;

    window.AOAnalytics = {
      enable(){ localStorage.setItem('ao.v2.analytics.ga','1'); localStorage.setItem('ao.v2.analytics.clarity','1'); window.loadGA?.(); window.loadClarity?.(); },
      disable(){ localStorage.setItem('ao.v2.analytics.ga','0'); localStorage.setItem('ao.v2.analytics.clarity','0'); },
      isOn(){ return localStorage.getItem('ao.v2.analytics.ga')==='1' || localStorage.getItem('ao.v2.analytics.clarity')==='1'; }
    };
  })();
  </script>
</head>
<body>

  <header class="top" id="top">
    <div class="top-wrap">
      <div class="logo">
        <img src="static/brand/ao-teal-logo.png" alt="AO Logo" onerror="this.remove()"/>
        <a href="#home" id="brand">Advice-Only®</a>
      </div>
      <nav class="menu" id="menu">
        <a href="#home" data-route="home">Home</a>
        <a href="#data" data-route="data">My Data</a>
        <a href="#events" data-route="events">Events</a>
        <a href="#privacy" data-route="privacy">Privacy</a>
        <a href="#about" data-route="about">About</a>
      </nav>
      <div class="search" id="search">
        <input id="q" aria-label="Search or ask" placeholder="Search or ask (Enter to view all)…" autocomplete="off"/>
        <div class="dd" id="dd"></div>
      </div>
      <button id="theme-toggle" aria-label="Toggle theme">
        <svg class="icon-dark" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <title>Activate light mode</title>
          <circle cx="12" cy="12" r="5"></circle>
          <path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 7.05-1.41-1.41M6.46 6.46 5.05 5.05m13.9 0-1.41 1.41M6.46 17.54 5.05 18.95"></path>
        </svg>
        <svg class="icon-light" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <title>Activate dark mode</title>
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
    </div>
  </header>

  <div class="wrap">
    <aside class="card nav" id="nav"><div class="muted">Loading…</div></aside>

    <main class="card main" id="main">
      <h1>Welcome</h1>
      <p class="lead">Select a learning objective from the left. Use the search above to jump to content.</p>
      <div class="muted">Data comes from <span class="kbd">site.json</span>. Add <span class="kbd">?full=1</span> to load <span class="kbd">full/site.json</span>.</div>
    </main>

    <aside class="card rail" id="rail">
      <div class="cardlet">
        <h4>Alerts</h4>
        <div class="muted">This panel is a placeholder for progress and events.</div>
      </div>
      <div class="cardlet" id="rail-events"></div>
      <div class="cardlet" id="rail-progress"></div>
    </aside>
  </div>

  <div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="Zoom" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:100">
    <button class="btn" id="lbClose" style="position:absolute;top:14px;right:14px">Close</button>
    <div id="lbSlot" style="max-width:92vw;max-height:92vh;margin:auto"></div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const h=(t,a={},...c)=>{const e=document.createElement(t);for(const[k,v]of Object.entries(a)){if(k==='class')e.className=v;else if(k==='html'&&e)e.innerHTML=v;else if(k.startsWith('on')&&typeof v==='function')e.addEventListener(k.slice(2),v);else e.setAttribute(k,v);}c.forEach(x=>{if(x!=null)e.appendChild(typeof x==='string'?document.createTextNode(x):x)});return e;};
  const MAIN = document.getElementById('main');
  const NAV = document.getElementById('nav');
  let site = null;

  async function loadSiteJSON() {
    const res = await fetch('site.json');
    if (!res.ok) throw new Error(`HTTP ${res.status} for site.json`);
    return res.json();
  }

  async function renderContent(target, htmlString, quizDefs, assessDefs) {
    if (!htmlString) return;
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlString;
    
    const quizRegex = /\[\[quiz:([a-z0-9\-]+)\]\]/gi;
    const assessRegex = /\[\[assessment:([a-z0-9\-]+)\]\]/gi;
    
    let match;
    let newHtml = htmlString;
    
    const tokenQueue = [];
    
    // Process quizzes
    while ((match = quizRegex.exec(htmlString)) !== null) {
      const id = match[1];
      const quizDef = quizDefs.find(q => q.id === id);
      if (quizDef) {
        const placeholderId = `quiz-placeholder-${id}-${Date.now()}`;
        newHtml = newHtml.replace(match[0], `<div id="${placeholderId}"></div>`);
        tokenQueue.push({ id: placeholderId, def: quizDef, kind: 'quiz' });
      }
    }

    // Process assessments
    while ((match = assessRegex.exec(htmlString)) !== null) {
      const id = match[1];
      const assessDef = assessDefs.find(a => a.id === id);
      if (assessDef) {
        const placeholderId = `assess-placeholder-${id}-${Date.now()}`;
        newHtml = newHtml.replace(match[0], `<div id="${placeholderId}"></div>`);
        tokenQueue.push({ id: placeholderId, def: assessDef, kind: 'assessment' });
      }
    }
    
    target.innerHTML = newHtml;

    for (const { id, def, kind } of tokenQueue) {
      const placeholder = document.getElementById(id);
      if (placeholder) {
        await renderSurvey(def.src, placeholder);
      }
    }
  }

  async function renderSurvey(srcPath, container) {
    try {
      const surveyJSON = await (await fetch(srcPath)).json();
      const surveyModel = new Survey.Model(surveyJSON);
      surveyModel.render(container);
    } catch (error) {
      console.error('Failed to load survey:', error);
      container.innerHTML = `<p style="color:red;">Error loading survey from ${srcPath}</p>`;
    }
  }
  
  function renderChapter(chapter) {
    MAIN.innerHTML = '';
    const chapterIntro = h('div', { class: 'chapter-intro', html: chapter.intro_public_html });
    MAIN.appendChild(chapterIntro);
    
    chapter.sections.forEach(section => {
      const sectionEl = h('div', { class: 'section-content' });
      const sectionHTML = section.section_public_html || section.public_html || '';
      
      const quizzes = site.quizzes ? Object.values(site.quizzes) : [];
      const assessments = site.assessments ? Object.values(site.assessments) : [];
      
      renderContent(sectionEl, sectionHTML, quizzes, assessments);
      MAIN.appendChild(sectionEl);
    });
  }

  function buildNav(chapters) {
    const list = h('ul');
    chapters.forEach(ch => {
      list.appendChild(h('h3', {}, ch.title));
      ch.sections.forEach(sec => {
        const li = h('li', {}, h('a', { 
          href: '#', 
          'data-chapter-id': ch.id, 
          'data-section-id': sec.h2_id,
          onclick: (e) => {
            e.preventDefault();
            const targetChapter = site.chapters.find(c => c.id === ch.id);
            if (targetChapter) {
              renderChapter(targetChapter);
            }
          }
        }, sec.title));
        list.appendChild(li);
      });
    });
    NAV.innerHTML = '';
    NAV.appendChild(list);
  }

  async function boot() {
    try {
      site = await loadSiteJSON();
      if (site && site.chapters && site.chapters.length > 0) {
        buildNav(site.chapters);
        renderChapter(site.chapters[0]); // Load the first chapter by default
      }
    } catch (e) {
      console.error('Boot error:', e);
      NAV.innerHTML = '<div class="muted">Failed to load site content.</div>';
      MAIN.innerHTML = '<h1>Error</h1><p>Could not load site content. Please check the console for more details.</p>';
    }
  }

  boot();
});
</script>