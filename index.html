<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Advice-Only® Learning Management System (Preview)</title>
  <meta name="robots" content="noindex,nofollow"/>
  <!-- Used by resolveRoot() so relative data paths work everywhere -->
  <meta name="ao-root" content="/"/>

  <link rel="stylesheet" href="static/css/ao-ui.css"/>

  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
  <link rel="preconnect" href="https://www.clarity.ms" crossorigin>

  <link href="static/js/vendor/survey/survey-core.min.css" rel="stylesheet"/>
  <script src="static/js/vendor/survey/survey.core.min.js">
</script>
  <script src="static/js/vendor/survey/survey-js-ui.min.js">
</script>

  <script>
    // Warm the registry ASAP; everything still works if it arrives late.
    (function () {
      const g = window;
      g.REGISTRY = g.REGISTRY || null;

      g.__ao_ensureRegistry = (function () {
        let p;
        return function () {
          if (p) return p;
          p = fetch('data/registry.json', { cache: 'no-store' })
            .then(r => r.ok ? r.json() : { quizzes: {}, assessments: {} })
            .catch(() => ({ quizzes: {}, assessments: {} }))
            .then(j => (g.REGISTRY = j, j));
          return p;
        };
      })();

      g.__ao_ensureRegistry();
    })();
  
</script>

  <script>
    /* AO PATCH: promote assessment + allow quiz-by-ref (no inline payload required) */
    function __ao_patch_preAdapt(v2) {
      const REG = window.REGISTRY; // may be null when this runs

      (v2.chapters || []).forEach(ch => {
        // Promote first section-level assessment to chapter.assessment
        if (!ch.assessment) {
          const sec = (ch.sections || []).find(s =>
            (s.sub_objectives || []).some(so => so && so.type === 'assessment' && (so.assessment || so.src || so.ref))
          );
          if (sec) {
            const so = (sec.sub_objectives || []).find(x => x && x.type === 'assessment');
            const ref = so?.ref || so?.assessment?.id || null;
            const regA = REG && ref ? REG.assessments?.[ref] : null;

            const src =
              (so.assessment && so.assessment.src) ||
              so.src ||
              (regA && regA.src) ||
              (ref ? ('data/assessments/' + ref + '.json') : null);

            if (src) {
              ch.assessment = {
                id: ref || so?.assessment?.id || 'assessment',
                title: sec.title || 'Chapter Assessment',
                href: '/' + (ref || 'assessment'),
                src
              };
              ch.items = Array.isArray(ch.items) ? ch.items : [];
              if (!ch.items.some(it => it && it.type === 'assessment')) {
                ch.items.push({ type: 'assessment', title: ch.assessment.title, href: ch.assessment.href });
              }
            }
          }
        }

        // Ensure quizzes can render even if payloads aren’t inlined
        (ch.sections || []).forEach(sec => {
          (sec.sub_objectives || []).forEach(so => {
            if (so && so.type === 'quiz' && !so.quiz) {
              const ref = so.ref || so.id || null;
              const regQ = REG && ref ? REG.quizzes?.[ref] : null;
              const src = so.src || (regQ && regQ.src) || (ref ? ('data/quizzes/' + ref + '.json') : null);
              if (src) so.quiz = { src }; // renderQuiz() will lazy-load by src
            }});        });
      });


      return v2;
    }
  
</script>

  <script>
    (function() {
      const GA_ID = 'G-C2E79R93CQ';
      const CLARITY_ID = 't38u1ekrco';

      function loadGA() {
        if (!GA_ID || window.__gaLoaded) return;
        window.__gaLoaded = true;
        var s = document.createElement('script');
        s.async = true;
        s.src = 'https://www.googletagmanager.com/gtag/js?id=' + encodeURIComponent(GA_ID);
        document.head.appendChild(s);
        window.dataLayer = window.dataLayer || [];
        function gtag(){ dataLayer.push(arguments); }
        window.gtag = gtag;
        gtag('js', new Date());
        gtag('config', GA_ID, { anonymize_ip: true });
      }

      function loadClarity() {
        if (!CLARITY_ID || window.__clarityLoaded) return;
        window.__clarityLoaded = true;
        (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){ (c[a].q=c[a].q||[]).push(arguments); };
          t=l.createElement(r); t.async=1; t.src='https://www.clarity.ms/tag/' + i;
          y=l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t,y);
        })(window, document, 'clarity', 'script', CLARITY_ID);
      }

      window.loadGA = loadGA;
      window.loadClarity = loadClarity;

      window.AOAnalytics = {
        enable(){ localStorage.setItem('ao.v2.analytics.ga','1'); localStorage.setItem('ao.v2.analytics.clarity','1'); window.loadGA?.(); window.loadClarity?.(); },
        disable(){ localStorage.setItem('ao.v2.analytics.ga','0'); localStorage.setItem('ao.v2.analytics.clarity','0'); },
        isOn(){ return localStorage.getItem('ao.v2.analytics.ga')==='1' || localStorage.getItem('ao.v2.analytics.clarity')==='1'; }
      };
    })();
  

</script>
</head>
<body>

<header class="top" id="top">
  <div class="top-wrap">
    <div class="logo">
      <img src="static/brand/ao-teal-logo.png" alt="AO Logo" onerror="this.remove()"/>
      <a href="#home" id="brand">Advice-Only®</a>
    </div>
    <nav class="menu" id="menu">
      <a href="#home" data-route="home">Home</a>
      <a href="#data" data-route="data">My Data</a>
      <a href="#events" data-route="events">Events</a>
      <a href="#privacy" data-route="privacy">Privacy</a>
      <a href="#about" data-route="about">About</a>
    </nav>
    <div class="search" id="search">
      <input id="q" aria-label="Search or ask" placeholder="Search or ask (Enter to view all)…" autocomplete="off"/>
      <div class="dd" id="dd"></div>
    </div>
    <button id="theme-toggle" aria-label="Toggle theme">
      <svg class="icon-dark" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <title>Activate light mode</title>
        <circle cx="12" cy="12" r="5"></circle>
        <path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 7.05-1.41-1.41M6.46 6.46 5.05 5.05m13.9 0-1.41 1.41M6.46 17.54 5.05 18.95"></path>
      </svg>
      <svg class="icon-light" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <title>Activate dark mode</title>
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    </button>
  </div>
</header>

<div class="wrap">
  <aside class="card nav" id="nav"><div class="muted">Loading…</div></aside>

  <main class="card main" id="main">
    <h1>Welcome</h1>
    <p class="lead">Select a learning objective from the left. Use the search above to jump to content.</p>
    <div class="muted">Data comes from <span class="kbd">site.json</span>. Add <span class="kbd">?full=1</span> to load <span class="kbd">full/site.json</span>.</div>
  </main>

  <aside class="card rail" id="rail">
    <div class="cardlet">
      <h4>Alerts</h4>
      <div class="muted">This panel is a placeholder for progress and events.</div>
    </div>
    <div class="cardlet" id="rail-events"></div>
    <div class="cardlet" id="rail-progress"></div>
  </aside>
</div>

<div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="Zoom" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:100">
  <button class="btn" id="lbClose" style="position:absolute;top:14px;right:14px">Close</button>
  <div id="lbSlot" style="max-width:92vw;max-height:92vh;margin:auto"></div>
</div>

<script>
  (function(){
    const KEY='ao.theme';
    const root=document.documentElement;
    const btn=document.getElementById('theme-toggle');
    const apply=isLight=>root.classList.toggle('light', isLight);
    let saved=false;
    try{ saved = localStorage.getItem(KEY)==='light'; }catch{}
    apply(saved);
    btn?.addEventListener('click', ()=>{
      const next=!root.classList.contains('light');
      apply(next);
      try{ localStorage.setItem(KEY, next?'light':'dark'); }catch{}
    });
  })();

</script><script>
document.addEventListener('DOMContentLoaded', function () {
  // Surface any boot errors in the left nav
  window.addEventListener('error', (ev) => {
    try {
      const n = document.getElementById('nav');
      if (!n) return;
      const d = document.createElement('div');
      d.className = 'muted';
      d.textContent = 'Script error: ' + (ev.error?.message || ev.message || ev.type);
      n.appendChild(d);
    } catch {}
  });
});
</script>

<script>
/* ===== Minimal runtime shims (safe) ===== */
window.buildLeftNav = window.buildLeftNav || function(){
  const nav = document.getElementById('nav');
  if (!nav || !window.site || !Array.isArray(site.chapters)) return;
  nav.innerHTML = '';
  for (const ch of site.chapters){
    const a = document.createElement('a');
    a.href = '#'; a.textContent = ch.title || 'Chapter';
    nav.appendChild(a);
  }
};
window.buildDocs   = window.buildDocs   || function(){};   // no-op
window.refreshRail = window.refreshRail || function(){};   // no-op
window.route       = window.route       || function(){};   // no-op
</script>

<script>
// ===== Boot (safe) =====
document.addEventListener('DOMContentLoaded', () => {
  const callBoot = () => {
    if (typeof window.boot === 'function') {
      Promise.resolve(window.boot()).catch(e => console.error('[boot] failed', e));
      return true;
    }
    return false;
  };
  // try immediately
  if (!callBoot()) {
    // and try once more on next tick; also probe site.json so you see it in Network
    setTimeout(() => { callBoot(); }, 30);
    fetch('site.json').then(r => console.log('[probe] site.json', r.status))
                      .catch(e => console.error('[probe] failed', e));
  }
});
</script>

<script>
// ===== AO Privacy Popup & Consent (clean) ===== (clean) =====
document.addEventListener('DOMContentLoaded', () => {
  const LS = window.localStorage;
  const KEY = 'ao:consent';
  const banner   = document.getElementById('ao-v2-privacyBanner');
  const allowBtn = document.getElementById('ao-analytics-allow');
  const saveBtn  = document.getElementById('ao-analytics-save');
  const gaBox    = document.getElementById('opt-ga');
  const mcBox    = document.getElementById('opt-clarity');
  const hasGPC   = () => (navigator && navigator.globalPrivacyControl === true);

  const get  = () => { try { return JSON.parse(LS.getItem(KEY) || '{}'); } catch { return {}; } };
  const set  = (v) => { try { LS.setItem(KEY, JSON.stringify(v)); } catch {} };

  const apply = (c) => {
    // Hook analytics loaders here if you want; no-op by default.
    if (!hasGPC() && c.ga) { window.dataLayer = window.dataLayer || []; }
  };

  const state = get();
  if (!hasGPC() && (state.ga || state.clarity)) apply(state);

  if (banner) {
    const save = () => {
      const next = { ga: !!(gaBox && gaBox.checked), clarity: !!(mcBox && mcBox.checked) };
      set(next); apply(next);
      banner.style.display = 'none';
    };
    if (allowBtn) allowBtn.addEventListener('click', () => {
      if (gaBox) gaBox.checked = true;
      if (mcBox) mcBox.checked = true;
      save();
    });
    if (saveBtn) saveBtn.addEventListener('click', save);
  }
});


</script>

<script>
/* ===== AO Modal & SurveyJS Logic (safe minimal stub) ===== */
document.addEventListener('DOMContentLoaded', function () {
  document.addEventListener('click', function (e) {
    const btn = e.target && e.target.closest && e.target.closest('.ao-token');
    if (!btn) return;
    e.preventDefault();
    // TODO: wire to SurveyJS here if needed.
    console.log('[ao-token]', btn.dataset && btn.dataset.kind, btn.dataset && btn.dataset.id);
  });
});


</script>

<script>
/* ===== Restored boot() (exported, guarded) ===== */
async function boot(){
  // 1) Load site.json (directly or via loadSiteJSON if present)
  let site;
  try{
    site = await (typeof loadSiteJSON==='function'
      ? loadSiteJSON()
      : (await fetch('site.json')).json());
  }catch(e){
    console.error('[boot] load site.json failed', e);
    throw e;
  }

  // 2) Adapt v2 -> legacy if those helpers exist
  try{
    if (typeof __ao_isV2Shape==='function' && __ao_isV2Shape(site) &&
        typeof __ao_adaptV2ToLegacy==='function'){
      site = __ao_adaptV2ToLegacy(site);
      console.log('[AO] adapted v2 → legacy');
    }
  }catch(e){ console.warn('[AO] adapt failed:', e); }

  // 3) Try legacy helpers first
  let used=false;
  try{
    if (typeof buildLeftNav==='function'){ buildLeftNav(); used=true; }
    if (typeof buildDocs   ==='function'){ buildDocs();    used=true; }
    if (typeof refreshRail ==='function'){ refreshRail(); }
    if (typeof route       ==='function'){ route(); window.addEventListener('hashchange', route); used=true; }
  }catch(e){
    console.warn('[boot] legacy render failed, will attempt minimal fallback', e);
  }

  // 4) Minimal fallback renderer (brand + simple nav + clear the "Loading..." msg)
  if (!used){
    try{
      const brand=document.getElementById('brand');
      if (brand && site?.title) brand.textContent = site.title;

      const nav = document.getElementById('nav') || document.getElementById('menu');
      if (nav && Array.isArray(site?.chapters)){
        nav.innerHTML='';
        site.chapters.forEach((ch,i)=>{
          const a=document.createElement('a');
          a.textContent = ch.title || ('Chapter '+(i+1));
          a.href = '#ch-'+i;
          a.dataset.route='chapter';
          nav.appendChild(a);
        });
      }

      const main = document.querySelector('main') || document.getElementById('home') || document.getElementById('content');
      if (main){
        const loading = [...main.querySelectorAll('.muted')].find(n=>/loading/i.test(n.textContent||'')) || null;
        if (loading) loading.textContent = 'Loaded.';
      }
    }catch(e){
      console.warn('[minimal] render failed', e);
    }
  }

  // 5) Expose for the DCL caller
  try{ window.boot = boot; }catch{}
}
</script>

</body>
</html>