<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Advice-Only® Bookstore (Preview)</title>
<meta name="robots" content="noindex,nofollow"/>

<meta name="ao-root" content="/"/>
<link rel="stylesheet" href="static/css/ao-ui.css"/>

</head>
<body>

  <header class="top" id="top">
    <div class="top-wrap">
      <div class="logo">
        <img src="static/brand/ao-teal-logo.png" alt="AO Logo" onerror="this.remove()"/>
        <a href="#home" id="brand">Advice-Only®</a>
      </div>
      <nav class="menu" id="menu">
        <a href="#home" data-route="home">Home</a>
        <a href="#data" data-route="data">My Data</a>
        <a href="#events" data-route="events">Events</a>
        <a href="#privacy" data-route="privacy">Privacy</a>
        <a href="#about" data-route="about">About</a>
      </nav>
      <div class="search" id="search">
        <input id="q" placeholder="Search or ask…" autocomplete="off"/>
        <div class="dd" id="dd"></div>
      </div>
      <button id="theme-toggle" aria-label="Toggle theme">
        <svg class="icon-dark" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <title>Activate light mode</title>
          <circle cx="12" cy="12" r="5"></circle>
          <path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 7.05-1.41-1.41M6.46 6.46 5.05 5.05m13.9 0-1.41 1.41M6.46 17.54 5.05 18.95"></path>
        </svg>
        <svg class="icon-light" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <title>Activate dark mode</title>
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
    </div>
  </header>

  <div class="wrap">
    <aside class="card nav" id="nav"><div class="muted">Loading…</div></aside>

    <main class="card main" id="main">
      <h1>Welcome</h1>
      <p class="lead">Select a learning objective from the left. Use the search above to jump to content.</p>
      <div class="muted">Data comes from <span class="kbd">site.json</span>. Add <span class="kbd">?full=1</span> to load <span class="kbd">full/site.json</span>.</div>
    </main>

    <aside class="card rail" id="rail">
      <div class="cardlet">
        <h4>Alerts</h4>
        <div class="muted">This panel is a placeholder for progress and events.</div>
      </div>
      <div class="cardlet" id="rail-events"></div>
      <div class="cardlet" id="rail-progress"></div>
    </aside>
  </div>

  <div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="Zoom" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:100">
    <button class="btn" id="lbClose" style="position:absolute;top:14px;right:14px">Close</button>
    <div id="lbSlot" style="max-width:92vw;max-height:92vh;margin:auto"></div>
  </div>

<script>
(function(){
  const KEY='ao.theme';
  const root=document.documentElement;
  const btn=document.getElementById('theme-toggle');
  const apply=isLight=>root.classList.toggle('light', isLight);
  let saved=false;
  try{ saved = localStorage.getItem(KEY)==='light'; }catch{}
  apply(saved);
  btn?.addEventListener('click', ()=>{
    const next=!root.classList.contains('light');
    apply(next);
    try{ localStorage.setItem(KEY, next?'light':'dark'); }catch{}
  });
})();
</script>
<script>
/* Surface any boot errors in the left nav */
window.addEventListener('error', (ev) => {
  try {
    const n = document.getElementById('nav');
    if (!n) return;
    n.innerHTML = '';
    const d = document.createElement('div');
    d.className = 'muted';
    d.textContent = 'Script error: ' + (ev.error?.message || ev.message || 'unknown');
    n.appendChild(d);
  } catch {}
});

(function(){
  // ---------- DOM ----------
  const NAV  = document.getElementById('nav');
  const MAIN = document.getElementById('main');
  const RAIL = document.getElementById('rail');
  const MENU = document.getElementById('menu');
  const SEARCH_BOX = document.getElementById('q');
  const SEARCH_DD  = document.getElementById('dd');
  const LB = document.getElementById('lightbox');
  const LB_SLOT = document.getElementById('lbSlot');
  const LB_CLOSE = document.getElementById('lbClose');

  // ---------- Config ----------
  const LS_SEEN = 'ao.v2.seen';
  const LS_TIME = 'ao.v2.time';
  const LS_LAST = 'ao.v2.last';
  const LS_QUIZ     = 'ao.v2.quiz';
  const LS_ASSESS = 'ao.v2.assess';
  const COMP_THRESH = { red:20, yellow:60 };

  const params = new URLSearchParams(location.search);
  const WANT_DEMO = params.get('demo') === '1';   // only show demo if requested
  const WANT_FULL = params.get('full') === '1';   // load /full/site.json

  // ---------- Helpers ----------
  const h=(t,a={},...c)=>{const e=document.createElement(t);
    for(const[k,v]of Object.entries(a)){
      if(k==='class')e.className=v;
      else if(k==='html')e.innerHTML=v;
      else if(k.startsWith('on')&&typeof v==='function')e.addEventListener(k.slice(2),v);
      else e.setAttribute(k,v);
    }
    c.forEach(x=>{ if(x!=null) e.appendChild(typeof x==='string'?document.createTextNode(x):x) });
    return e;
  };
  const num = s => s ? parseInt(s,10) : NaN;
  const tokenize = s => (s||'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(Boolean);
  const fmtDate=(iso,tz,time)=>{
    try{const dt=new Date(`${iso}T${time||'00:00'}:00`);
      const opt={dateStyle:'medium',timeStyle:time?'short':undefined};
      if(tz) opt.timeZone = tz;
      const s=new Intl.DateTimeFormat(undefined,opt).format(dt);
      return s + (tz?` (${(tz.split('/')[1]||tz)})`:'');
    }catch{ return iso+(time?` ${time}`:''); }
  };
  const loadJSON=(k,def)=>{ try{const v=JSON.parse(localStorage.getItem(k)||''); return v??def;}catch{ return def; } };
  const saveJSON=(k,v)=>localStorage.setItem(k, JSON.stringify(v));

  // ---------- State ----------
  const seen = new Set(loadJSON(LS_SEEN, []));
  const timeMap = loadJSON(LS_TIME, {});
  const quizResults     = loadJSON(LS_QUIZ,    {});
  const assessResults = loadJSON(LS_ASSESS, {});
  let currentTimer = null;
  let site=null, chapters=[], docs=[];

  // ---------- Timing ----------
  function startTiming(key){ stopTiming(); currentTimer={key,start:Date.now()}; localStorage.setItem(LS_LAST,key); }
  function stopTiming(){ if(!currentTimer) return; const dt=Math.max(0,Math.round((Date.now()-currentTimer.start)/1000)); timeMap[currentTimer.key]=(timeMap[currentTimer.key]||0)+dt; saveJSON(LS_TIME,timeMap); currentTimer=null; localStorage.removeItem(LS_LAST); }
  window.addEventListener('beforeunload', stopTiming);
  document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopTiming(); });
  (function recover(){ const last=localStorage.getItem(LS_LAST); if(last){ seen.add(last); saveJSON(LS_SEEN,[...seen]); localStorage.removeItem(LS_LAST); } })();

  // ---------- Ordering + labels ----------
  function chapterOrderIndex(ch, i) {
    if (typeof ch.index === 'number') return ch.index;
    const ct = (ch.title || '').trim();
    let m = /^Chapter\s+(\d+)/i.exec(ct);
    if (m) return num(m[1]);
    let best = Infinity;
    (ch.los||[]).forEach(lo=>{
      const t=(lo.title||'').trim();
      const matches = t.match(/\b(\d+\.\d+)\b/g);
      if(matches){matches.forEach(mm=>{
        const major=parseInt(mm.split('.')[0],10);
        if(!Number.isNaN(major)&&major<best)best=major;
      })};
    });
    return best !== Infinity ? best : 1000+i;
  }
  function loLabel(lo){
    const t=(lo.title||'').trim();
    const m=t.match(/(\d+\.\d+)/);
    if(m){
      const rest=t.replace(m[0],'').replace(/^[-—:\s]+/,'').trim();
      return `${m[0]} — ${rest||''}`.trim();
    }
    return t||'Untitled';
  }

  // ---------- Inline media (tokens) ----------
  function normalizeMedia(raw){
    const toItem = (x)=>{
      if(typeof x==='string'){
        if(/^https?:/i.test(x) && (/\.(mp4|webm|ogg)(\?|$)/i).test(x)) return {kind:'video',src:x};
        return {kind:'image',src:x};
      }
      if(x && typeof x==='object'){
        const kind = x.type==='video' || x.video ? 'video' : ((x.src||'').match(/\.(mp4|webm|ogg)(\?|$)/i) ? 'video':'image');
        return { kind, src:x.src, alt:x.alt||'', caption:x.caption||x.title||'' };
      }
      return null;
    };
    if(Array.isArray(raw)) return raw.map(toItem).filter(Boolean);
    if(!raw) return [];
    const one=toItem(raw); return one? [one] : [];
  }
  function extractTokenIndices(text, token){
    const re = token==='img' ? /\[\[img:(\d+)\]\]/gi : /\[\[vid:(\d+)\]\]/gi;
    const inds=[]; (text||'').replace(re,(_,n)=>{ inds.push(Math.max(1,parseInt(n,10))-1); return ''; });
    return inds;
  }
  function openZoom(node){
    LB_SLOT.innerHTML='';
    if(node.tagName==='IMG'){
      LB_SLOT.appendChild(h('img',{src:node.src, alt:node.alt||'', style:'max-width:92vw;max-height:92vh;border-radius:10px'}));
    }else if(node.tagName==='VIDEO'){
      const v = h('video',{src:node.currentSrc||node.src, controls:true, autoplay:true, style:'max-width:92vw;max-height:92vh;border-radius:10px'});
      LB_SLOT.appendChild(v);
    }
    LB.style.display='flex';
  }
  function closeZoom(){ LB.style.display='none'; LB_SLOT.innerHTML=''; }
  LB_CLOSE.addEventListener('click', closeZoom);
  LB.addEventListener('click', (e)=>{ if(e.target===LB) closeZoom(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeZoom(); });

  // ---------- QUIZ & ASSESSMENT ----------
  function valueSafe(s){ return String(s||'').replace(/[^a-zA-Z0-9_-]/g,'_'); }
  function saveQuizResult(id, payload){ quizResults[id] = payload; saveJSON(LS_QUIZ, quizResults); }
  function saveAssessResult(id, payload){ assessResults[id] = payload; saveJSON(LS_ASSESS, assessResults); }

  function renderQuiz(lo, key){
    // ... (This function remains unchanged) ...
  }

  function renderAssessment(ch, chIdx){
    // ... (This function remains unchanged) ...
  }
  
  // ---------- (The rest of the main script is unchanged) ----------

})();
</script>
<script>
/* ===== AO Privacy Popup & Consent (standalone) ===== */
// ... (Your privacy script remains unchanged) ...
</script>

</body>
</html>