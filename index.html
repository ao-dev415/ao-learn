<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Advice-Only® Learning Management System (Preview)</title>
  <meta name="robots" content="noindex,nofollow"/>
  <meta name="ao-root" content="/"/>

  <link rel="stylesheet" href="static/css/ao-ui.css"/>

  <script src="https://unpkg.com/survey-core@1.9.162/survey.core.min.js"></script>
  <script src="https://unpkg.com/survey-knockout-ui@1.9.162/survey-knockout-ui.min.js"></script>
  <link href="https://unpkg.com/survey-core@1.9.162/defaultV2.min.css" rel="stylesheet"/>

  <!-- analytics block unchanged -->
</head>
<body>
  <!-- header, navigation, theme toggle … unchanged -->

<script>
/* Surface any boot errors in the left nav */
window.addEventListener('error', (ev) => {
  try {
    const n = document.getElementById('nav');
    if (n) {
      n.innerHTML = '';
      const d = document.createElement('div');
      d.className = 'muted';
      d.textContent = 'Script error: ' + (ev.error?.message || ev.message || 'unknown');
      n.appendChild(d);
    }
  } catch {}
});
(function(){
  /* ---------- DOM ---------- */
  const NAV  = document.getElementById('nav');
  const MAIN = document.getElementById('main');
  const RAIL = document.getElementById('rail');
  const MENU = document.getElementById('menu');
  const SEARCH_BOX = document.getElementById('q');
  const SEARCH_DD  = document.getElementById('dd');

  /* ---------- Config ---------- */
  const LS_SEEN  = 'ao.v2.seen';
  const LS_TIME  = 'ao.v2.time';
  const LS_LAST  = 'ao.v2.last';
  const LS_QUIZ  = 'ao.v2.quiz';
  const LS_ASSESS= 'ao.v2.assess';
  const COMP_THRESH = { red:20, yellow:60 };

  const params   = new URLSearchParams(location.search);
  const WANT_DEMO = params.get('demo') === '1';
  const WANT_FULL = params.get('full') === '1';   // ← fixed

  /* ---------- Helpers, state, timing … unchanged ---------- */

  /* ---------- QUIZ & ASSESSMENT ---------- */
  function saveQuizResult(id, payload){ quizResults[id] = payload; saveJSON(LS_QUIZ, quizResults); }
  function saveAssessResult(id, payload){ assessResults[id] = payload; saveJSON(LS_ASSESS, assessResults); }

  function renderQuiz(lo, key){
    const surveyJson = lo.quiz; if (!surveyJson) return;
    const surveyHost = h('div', { class: 'cardlet', style: 'margin-top:20px;' });
    MAIN.appendChild(surveyHost);

    Survey.StylesManager.applyTheme("defaultV2");
    const survey = new Survey.Model(surveyJson);
    survey.onComplete.add(sender => {
      saveQuizResult(lo.quiz.id || `quiz_${key}`, {
        key,
        score: sender.getCorrectAnswerCount(),
        total: sender.getQuestionCount(),
        answers: sender.data,
        ts: Date.now()
      });
    });
    survey.render(surveyHost);
  }

  function renderAssessment(ch, chIdx){
    const surveyJson = ch.assessment; if (!surveyJson) return;
    const surveyHost = document.getElementById('survey-container'); if (!surveyHost) return;

    Survey.StylesManager.applyTheme("defaultV2");
    const survey = new Survey.Model(surveyJson);
    survey.onComplete.add(sender => {
      saveAssessResult(ch.assessment.id || `assess_ch${chIdx+1}`, {
        chapter: chIdx + 1,
        answers: sender.data,
        ts: Date.now()
      });
    });
    survey.render(surveyHost);
  }

  /* ---------- Reader, My Data, etc. unchanged ---------- */

  /* ---------- Search ---------- */
  function showSearchDD(results, qTokens){
    if (SEARCH_DD) SEARCH_DD.innerHTML = '';
    if (!results.length){ SEARCH_DD.classList.remove('show'); return; }
    results.slice(0,8).forEach(r=>{
      const pv = (chapters[r.ci].los[r.li].snippets?.[0]?.body) ||
                 (chapters[r.ci].los[r.li].preview) || '';
      SEARCH_DD.appendChild(
        h('div',{class:'res',onclick:()=>{
            location.hash=`#ch${r.ci+1}-lo${r.li+1}`;
            SEARCH_DD.classList.remove('show');
            SEARCH_BOX.blur();
          }},
          h('div',{html: hilite(`${r.chTitle} — ${r.loTitle}`, qTokens)}),
          h('small',{html: hilite(pv, qTokens)})
        )
      );
    });
    SEARCH_DD.classList.add('show');
  }

  function runSearch(q, mode){
    const qTokens = tokenize(q);
    if(!qTokens.length){ SEARCH_DD.classList.remove('show'); return; }
    const results = docs.map(d => {
      const pv = (chapters[d.ci].los[d.li].snippets?.[0]?.body) ||
                 (chapters[d.ci].los[d.li].preview) || '';
      return {...d, score: scoreDoc(qTokens, d), preview: pv};
    }).filter(r => r.score>0).sort((a,b)=>b.score-a.score);
    if(mode==='dd'){ showSearchDD(results,qTokens); return; }
    // … remainder of runSearch unchanged …
  }

  /* ---------- Boot, route, etc. unchanged ---------- */
  async function boot(){ /* ... existing logic ... */ }
  boot();
})();
</script>
<!-- privacy popup + analytics allow button scripts unchanged -->
</body>
</html>
