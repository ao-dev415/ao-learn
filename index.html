<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Advice-Only® Learning Management System (Preview)</title>
  <meta name="robots" content="noindex,nofollow"/>
  <meta name="ao-root" content="/"/>

  <link rel="stylesheet" href="static/css/ao-ui.css"/>

  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
  <link rel="preconnect" href="https://www.clarity.ms" crossorigin>

  <link href="static/js/vendor/survey/survey-core.min.css" rel="stylesheet"/>
  <script src="static/js/vendor/survey/survey.core.min.js"></script>
  <script src="static/js/vendor/survey/survey-js-ui.min.js"></script>

  <script>
  (function() {
    const GA_ID = 'G-C2E79R93CQ';
    const CLARITY_ID = 't38u1ekrco';

    function loadGA() {
      if (!GA_ID || window.__gaLoaded) return;
      window.__gaLoaded = true;
      var s = document.createElement('script');
      s.async = true;
      s.src = 'https://www.googletagmanager.com/gtag/js?id=' + encodeURIComponent(GA_ID);
      document.head.appendChild(s);
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', GA_ID, { anonymize_ip: true });
    }

    function loadClarity() {
      if (!CLARITY_ID || window.__clarityLoaded) return;
      window.__clarityLoaded = true;
      (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){ (c[a].q=c[a].q||[]).push(arguments); };
        t=l.createElement(r); t.async=1; t.src='https://www.clarity.ms/tag/' + i;
        y=l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t,y);
      })(window, document, 'clarity', 'script', CLARITY_ID);
    }
    
    window.loadGA = loadGA;
    window.loadClarity = loadClarity;

    window.AOAnalytics = {
      enable(){ localStorage.setItem('ao.v2.analytics.ga','1'); localStorage.setItem('ao.v2.analytics.clarity','1'); window.loadGA?.(); window.loadClarity?.(); },
      disable(){ localStorage.setItem('ao.v2.analytics.ga','0'); localStorage.setItem('ao.v2.analytics.clarity','0'); },
      isOn(){ return localStorage.getItem('ao.v2.analytics.ga')==='1' || localStorage.getItem('ao.v2.analytics.clarity')==='1'; }
    };
  })();
  </script>
</head>
<body>

  <header class="top" id="top">
    <div class="top-wrap">
      <div class="logo">
        <img src="static/brand/ao-teal-logo.png" alt="AO Logo" onerror="this.remove()"/>
        <a href="#home" id="brand">Advice-Only®</a>
      </div>
      <nav class="menu" id="menu">
        <a href="#home" data-route="home">Home</a>
        <a href="#data" data-route="data">My Data</a>
        <a href="#events" data-route="events">Events</a>
        <a href="#privacy" data-route="privacy">Privacy</a>
        <a href="#about" data-route="about">About</a>
      </nav>
      <div class="search" id="search">
        <input id="q" aria-label="Search or ask" placeholder="Search or ask (Enter to view all)…" autocomplete="off"/>
        <div class="dd" id="dd"></div>
      </div>
      <button id="theme-toggle" aria-label="Toggle theme">
        <svg class="icon-dark" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <title>Activate light mode</title>
          <circle cx="12" cy="12" r="5"></circle>
          <path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 7.05-1.41-1.41M6.46 6.46 5.05 5.05m13.9 0-1.41 1.41M6.46 17.54 5.05 18.95"></path>
        </svg>
        <svg class="icon-light" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <title>Activate dark mode</title>
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
    </div>
  </header>

  <div class="wrap">
    <aside class="card nav" id="nav"><div class="muted">Loading…</div></aside>

    <main class="card main" id="main">
      <h1>Welcome</h1>
      <p class="lead">Select a learning objective from the left. Use the search above to jump to content.</p>
      <div class="muted">Data comes from <span class="kbd">site.json</span>. Add <span class="kbd">?full=1</span> to load <span class="kbd">full/site.json</span>.</div>
    </main>

    <aside class="card rail" id="rail">
      <div class="cardlet">
        <h4>Alerts</h4>
        <div class="muted">This panel is a placeholder for progress and events.</div>
      </div>
      <div class="cardlet" id="rail-events"></div>
      <div class="cardlet" id="rail-progress"></div>
    </aside>
  </div>

  <div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="Zoom" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:100">
    <button class="btn" id="lbClose" style="position:absolute;top:14px;right:14px">Close</button>
    <div id="lbSlot" style="max-width:92vw;max-height:92vh;margin:auto"></div>
  </div>

<script>
(function(){
  const KEY='ao.theme';
  const root=document.documentElement;
  const btn=document.getElementById('theme-toggle');
  const apply=isLight=>root.classList.toggle('light', isLight);
  let saved=false;
  try{ saved = localStorage.getItem(KEY)==='light'; }catch{}
  apply(saved);
  btn?.addEventListener('click', ()=>{
    const next=!root.classList.contains('light');
    apply(next);
    try{ localStorage.setItem(KEY, next?'light':'dark'); }catch{}
  });
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  /* Surface any boot errors in the left nav */
  window.addEventListener('error', (ev) => {
    try {
      const n = document.getElementById('nav');
      if (n) {
        n.innerHTML = '';
        const d = document.createElement('div');
        d.className = 'muted';
        d.textContent = 'Script error: ' + (ev.error?.message || ev.message || 'unknown');
        n.appendChild(d);
      }
    } catch {}
  });

  window.addEventListener('unhandledrejection', (ev)=>{
    try{
      const n=document.getElementById('nav');
      if(n){
        n.innerHTML='';
        const d=document.createElement('div');
        d.className='muted';
        d.textContent='Promise error: ' + (ev.reason?.message || String(ev.reason));
        n.appendChild(d);
      }
    }catch{}
  });

  (function(){
    // ---------- DOM ----------
    const NAV  = document.getElementById('nav');
    const MAIN = document.getElementById('main');
    const RAIL = document.getElementById('rail');
    const MENU = document.getElementById('menu');
    const SEARCH_BOX = document.getElementById('q');
    const SEARCH_DD  = document.getElementById('dd');
    const LB = document.getElementById('lightbox');
    const LB_SLOT = document.getElementById('lbSlot');
    const LB_CLOSE = document.getElementById('lbClose');

    // ---------- Config ----------
    const LS_SEEN = 'ao.v2.seen';
    const LS_TIME = 'ao.v2.time';
    const LS_LAST = 'ao.v2.last';
    const LS_QUIZ     = 'ao.v2.quiz';
    const LS_ASSESS = 'ao.v2.assess';
    const COMP_THRESH = { red:20, yellow:60 };

    const params = new URLSearchParams(location.search);
    const WANT_DEMO = params.get('demo') === '1';
    const WANT_FULL = params.get('full') === '1';

    // ---------- Helpers ----------
    const h=(t,a={},...c)=>{const e=document.createElement(t);for(const[k,v]of Object.entries(a)){if(k==='class')e.className=v;else if(k==='html'&&e)e.innerHTML=v;else if(k.startsWith('on')&&typeof v==='function')e.addEventListener(k.slice(2),v);else e.setAttribute(k,v);}c.forEach(x=>{if(x!=null)e.appendChild(typeof x==='string'?document.createTextNode(x):x)});return e;};
    const num = s => s ? parseInt(s,10) : NaN;
    const tokenize = s => (s||'').toLowerCase().replace(/[^\p{L}\p{N}\s]/gu,' ').split(/\s+/).filter(Boolean);
    const fmtDate=(iso,tz,time)=>{try{const dt=new Date(`${iso}T${time||'00:00'}:00`);const opt={dateStyle:'medium',timeStyle:time?'short':undefined};if(tz)opt.timeZone=tz;const s=new Intl.DateTimeFormat(undefined,opt).format(dt);return s+(tz?` (${(tz.split('/')[1]||tz)})`:'');}catch{return iso+(time?` ${time}`:'');}};
    const loadJSON=(k,def)=>{try{const v=JSON.parse(localStorage.getItem(k)||'');return v??def;}catch{return def;}};
    const saveJSON=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
    
    function csvEscape(v){ 
      const s = String(v ?? "");
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }
    function buildCSV(){
      const rows = [];
      rows.push(["Chapter/LO","Seconds","Seen?"].map(csvEscape).join(","));
      (chapters||[]).forEach((ch,ci)=>{
        (ch.los||[]).forEach((lo,li)=>{
          const key = `${ci+1}.${li+1}`;
          const secs = timeMap[key] || 0;
          const seenFlag = seen.has(key) ? "yes" : "no";
          rows.push([`${key} ${lo.title||""}`, secs, seenFlag].map(csvEscape).join(","));
        });
      });
      rows.push("", "Quiz Results", "Quiz ID,Score,Total,When,LO Key");
      Object.entries(quizResults||{}).forEach(([id,res])=>{
        rows.push([id, res.score??"", res.total??"", new Date(res.ts||Date.now()).toISOString(), res.key||""].map(csvEscape).join(","));
      });
      rows.push("", "Assessments", "Assessment ID,Score,When");
      Object.entries(assessResults||{}).forEach(([id,res])=>{
        rows.push([id, res.answers?.totalScore ?? "", new Date(res.ts||Date.now()).toISOString()].map(csvEscape).join(","));
      });
      return rows.join("\n");
    }
    function downloadFile(filename, content, mime){
      const blob = new Blob([content], {type: mime || "application/octet-stream"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }
    
    // ---------- State ----------
    const seen = new Set(loadJSON(LS_SEEN, []));
    const timeMap = loadJSON(LS_TIME, {});
    const quizResults = loadJSON(LS_QUIZ, {});
    const assessResults = loadJSON(LS_ASSESS, {});
    let currentTimer = null;
    let site=null, chapters=[], docs=[];

    // ---------- Timing ----------
    function startTiming(key){stopTiming();currentTimer={key,start:Date.now()};localStorage.setItem(LS_LAST,key);}
    function stopTiming(){if(!currentTimer)return;const dt=Math.max(0,Math.round((Date.now()-currentTimer.start)/1000));timeMap[currentTimer.key]=(timeMap[currentTimer.key]||0)+dt;saveJSON(LS_TIME,timeMap);currentTimer=null;localStorage.removeItem(LS_LAST);}
    window.addEventListener('beforeunload', stopTiming);
    document.addEventListener('visibilitychange', ()=>{if(document.hidden)stopTiming();});
    (function recover(){const last=localStorage.getItem(LS_LAST);if(last){seen.add(last);saveJSON(LS_SEEN,[...seen]);localStorage.removeItem(LS_LAST);}})();
    
    // ---------- Ordering + labels ----------
    function chapterOrderIndex(ch,i){if(typeof ch.index==='number')return ch.index;const ct=(ch.title||'').trim();let m=/^Chapter\s+(\d+)/i.exec(ct);if(m)return num(m[1]);let best=Infinity;(ch.los||[]).forEach(lo=>{const t=(lo.title||'').trim();const matches=t.match(/\b(\d+\.\d+)\b/g);if(matches){matches.forEach(mm=>{const major=parseInt(mm.split('.')[0],10);if(!Number.isNaN(major)&&major<best)best=major;})}});return best!==Infinity?best:1000+i;}
    function loLabel(lo){const t=(lo.title||'').trim();const m=t.match(/(\d+\.\d+)/);if(m){const rest=t.replace(m[0],'').replace(/^[-—:\s]+/,'').trim();return`${m[0]} — ${rest||''}`.trim();}return t||'Untitled';}

    // ---------- Inline media (tokens) ----------
    function normalizeMedia(raw){const toItem=(x)=>{if(typeof x==='string'){if(/^https?:/i.test(x)&&(/\.(mp4|webm|ogg)(\?|$)/i).test(x))return{kind:'video',src:x};return{kind:'image',src:x};}if(x&&typeof x==='object'){const kind=x.type==='video'||x.video?'video':((x.src||'').match(/\.(mp4|webm|ogg)(\?|$)/i)?'video':'image');return{kind,src:x.src,alt:x.alt||'',caption:x.caption||x.title||''};}return null;};if(Array.isArray(raw))return raw.map(toItem).filter(Boolean);if(!raw)return[];const one=toItem(raw);return one?[one]:[];}
    function extractTokenIndices(text,token){const re=token==='img'?/\[\[img:(\d+)\]\]/gi:/\[\[vid:(\d+)\]\]/gi;const inds=[];(text||'').replace(re,(_,n)=>{inds.push(Math.max(1,parseInt(n,10))-1);return'';});return inds;}
    function openZoom(node){if(LB_SLOT)LB_SLOT.innerHTML='';if(node.tagName==='IMG'){LB_SLOT.appendChild(h('img',{src:node.src,alt:node.alt||''}));}else if(node.tagName==='VIDEO'){const v=h('video',{src:node.currentSrc||node.src,controls:true,autoplay:true});LB_SLOT.appendChild(v);}if(LB)LB.style.display='flex';}
    function closeZoom(){if(LB)LB.style.display='none';if(LB_SLOT)LB_SLOT.innerHTML='';}
    LB_CLOSE.addEventListener('click',closeZoom);
    LB.addEventListener('click',(e)=>{if(e.target===LB)closeZoom();});
    document.addEventListener('keydown',(e)=>{if(e.key==='Escape')closeZoom();});
    
    // ---------- QUIZ & ASSESSMENT ----------
    function saveQuizResult(id, payload){ quizResults[id] = payload; saveJSON(LS_QUIZ, quizResults); }
    function saveAssessResult(id, payload){ assessResults[id] = payload; saveJSON(LS_ASSESS, assessResults); }

    // NEW: resolve root + robust fetch
    function resolveRoot(u) {
      const metaRoot = document.querySelector('meta[name="ao-root"]')?.content || '/';
      if (!u) return u;
      if (/^https?:\/\//i.test(u) || u.startsWith('/')) return u;
      const base = metaRoot.endsWith('/') ? metaRoot.slice(0, -1) : metaRoot;
      return base + '/' + u.replace(/^\/+/, '');
    }
    async function loadJSONMaybe(u) {
      const url = resolveRoot(u);
      const res = await fetch(url, { cache: 'no-store', credentials: 'same-origin' });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return res.json();
    }

    async function renderQuiz(quiz, key){
      try{
        let surveyJson = quiz;
        if (!surveyJson?.pages && typeof quiz?.src === 'string') {
          surveyJson = await loadJSONMaybe(quiz.src);
        }
        if (!surveyJson?.pages?.length) throw new Error('Quiz JSON has no pages/elements.');

        const surveyHost = h('div', { class: 'cardlet', style: 'margin-top:20px;' });
        MAIN.appendChild(surveyHost);

        if (Survey?.Theme?.applyTheme) Survey.Theme.applyTheme(Survey.Theme.Default);
        else if (Survey?.StylesManager?.applyTheme) Survey.StylesManager.applyTheme('defaultV2');

        const survey = new Survey.Model(surveyJson);
        survey.onComplete.add(sender => {
          saveQuizResult(quiz.id || `quiz_${key}`, {
            key,
            score: sender.getCorrectAnswerCount?.() ?? null,
            total: sender.getQuestionCount?.() ?? null,
            answers: sender.data,
            ts: Date.now()
          });
        });
        survey.render(surveyHost);
      }catch(err){
        console.error('[quiz] render failed:', err);
        MAIN.appendChild(h('div', { class: 'cardlet' },
          h('div', { class: 'muted' }, 'Quiz failed to load: ' + (err.message || err))
        ));
      }
    }

    async function renderAssessment(assessment, key, host) {
      try{
        let surveyJson = assessment;
        if (!surveyJson?.pages && typeof assessment?.src === 'string') {
          surveyJson = await loadJSONMaybe(assessment.src);
        }
        if (!surveyJson?.pages?.length) throw new Error('Assessment JSON has no pages/elements.');

        const surveyHost = host || h('div', { class: 'cardlet', style: 'margin-top:20px;' });
        if (!host) MAIN.appendChild(surveyHost);

        if (Survey?.Theme?.applyTheme) Survey.Theme.applyTheme(Survey.Theme.Default);
        else if (Survey?.StylesManager?.applyTheme) Survey.StylesManager.applyTheme('defaultV2');

        const survey = new Survey.Model(surveyJson);
        survey.onComplete.add(sender => {
          const chapter = parseInt((key || '').split('.')[0], 10) || null;
          saveAssessResult(assessment.id || `assess_${key}`, {
            chapter,
            answers: sender.data,
            ts: Date.now()
          });
        });
        survey.render(surveyHost);
      }catch(err){
        console.error('[assess] render failed:', err);
        const holder = host || MAIN;
        holder.appendChild(h('div', { class: 'cardlet' },
          h('div', { class: 'muted' }, 'Assessment failed to load: ' + (err.message || err))
        ));
      }
    }
    
    // ---------- Reader & Page Views ----------
    function renderMain(ch, lo, chIdx, loIdx){
      const key = `${chIdx+1}.${loIdx+1}`;
      if(!seen.has(key)){ seen.add(key); saveJSON(LS_SEEN,[...seen]); }
      stopTiming(); startTiming(key);

      if (MAIN) MAIN.innerHTML='';
      
      MAIN.append(
        h('h1',{}, `${ch.title || 'Chapter'} — ${lo.title || 'Learning Objective'}`),
        h('p',{class:'lead'}, lo.preview || 'This is preview text for this learning objective.')
      );
      
      const pool = [...normalizeMedia(lo.images), ...normalizeMedia(lo.image||lo.img)];
      (lo.snippets||[]).forEach(s=>{ pool.push(...normalizeMedia(s.images), ...normalizeMedia(s.image||s.img)); });

      const addFigure = (item)=>{
        const fig=h('figure');
        if(item.kind==='image'){const im=h('img',{src:item.src,alt:item.alt||''});im.addEventListener('dblclick',()=>openZoom(im));fig.appendChild(im);}
        else{const v=h('video',{src:item.src,controls:true});v.addEventListener('dblclick',()=>openZoom(v));fig.appendChild(v);}
        if(item.caption)fig.appendChild(h('figcaption',{},item.caption));
        MAIN.appendChild(fig);
      };

      let hasMediaToken = false;
      (lo.snippets || []).forEach(s => {
        if (!s) return;
        if (s.type === 'quiz' && s.quiz) { renderQuiz(s.quiz, key); return; }
        if (s.type === 'assessment' && s.assessment) { renderAssessment(s.assessment, key); return; }
        if (s.title) MAIN.append(h('h3', {}, s.title));
        if (s.body) {
          const strippedBody = s.body.replace(/\[\[(img|vid):\d+\]\]/gi, '').trim();
          if (strippedBody) MAIN.append(h('p', {}, strippedBody));
          const imgTokens = extractTokenIndices(s.body,'img').filter(i=>pool[i] && pool[i].kind==='image');
          const vidTokens = extractTokenIndices(s.body,'vid').filter(i=>pool[i] && pool[i].kind==='video');
          if(imgTokens.length || vidTokens.length) hasMediaToken = true;
          [...imgTokens.map(i=>({i,kind:'img'})), ...vidTokens.map(i=>({i,kind:'vid'}))].sort((a,b)=>a.i-b.i).forEach(t => addFigure(pool[t.i]));
        }
      });

      if(!hasMediaToken && pool[0]) addFigure(pool[0]);
      // assessment invitation (optional, only if chapter has one)
      if (ch.assessment) renderAssessmentInvitation(ch, chIdx);
    }

    function renderAssessmentView(ch, chIdx) {
      stopTiming();
      if (MAIN) MAIN.innerHTML = '';
      const container = h('div', { id: 'survey-container' });
      MAIN.append(
        h('h1', {}, `${ch.title || 'Chapter'} — Assessment`),
        container
      );
      renderAssessment(ch.assessment, `${chIdx+1}`, container);
    }
    
    function renderAssessmentInvitation(ch, chIdx) {
      if (!ch.assessment) return;
      const host = h('div', { class: 'cardlet', style: 'margin-top: 16px;' });
      host.appendChild(h('h4', {}, ch.assessment.title || 'Chapter Assessment'));
      host.appendChild(h('p', { class: 'muted' }, 'You have completed the learning objectives for this chapter.'));
      const assessButton = h('a', { class: 'btn', href: `#ch${chIdx + 1}-assessment` }, 'Begin Assessment');
      host.appendChild(h('div', { style: 'margin-top:12px;' }, assessButton));
      MAIN.appendChild(host);
    }

    function buildLeftNav() {
      if (NAV) NAV.innerHTML = '';
      const list = h('ul');
      chapters.forEach((ch, chIdx) => {
        list.append(h('h3', {}, ch.title || `Chapter ${chIdx+1}`));
        (ch.los || []).forEach((lo, loIdx) => {
          const btn = h('button', {
            class: 'lo',
            onclick: () => {
              renderMain(ch, lo, chIdx, loIdx);
              location.hash = `#ch${chIdx+1}-lo${loIdx+1}`;
              setActiveLO(btn);
              refreshRail();
            }
          }, loLabel(lo));
          list.append(h('li', {}, btn));
        });

        if (ch.assessment) {
          const assessmentBtn = h('button', {
            class: 'assessment-link',
            onclick: () => {
              renderAssessmentView(ch, chIdx);
              location.hash = `#ch${chIdx+1}-assessment`;
              setActiveLO(assessmentBtn);
            }
          }, ch.assessment.title || 'Chapter Assessment');
          list.append(h('li', {}, assessmentBtn));
        }
      });
      NAV.append(list, h('a', {
        href: '#data',
        class: 'meta-link'
      }, '→ Open My Data'));
      const year = new Date().getFullYear();
      const foot = h('div', {
        class: 'foot',
        id: 'foot'
      });
      foot.appendChild(h('div', {
        html: `©${year} Hall Financial Services, Inc. d/b/a ADVICE ONLY.`
      }));
      foot.appendChild(h('div', {}, h('a', {
        href: 'https://adviceonly.info/important-disclosures-and-privacy/',
        target: '_blank',
        rel: 'noopener'
      }, 'Privacy')));
      NAV.appendChild(foot);
    }

    function setActiveLO(btn){NAV.querySelectorAll('button[aria-current="true"]').forEach(b=>b.setAttribute('aria-current','false'));btn?.setAttribute('aria-current','true');btn?.scrollIntoView({block:'nearest',inline:'nearest'});}

    function openFromHash(){const m_lo=location.hash.match(/^#ch(\d+)-lo(\d+)$/);if(m_lo){const ch=chapters[+m_lo[1]-1];const lo=ch?.los?.[+m_lo[2]-1];if(ch&&lo){renderMain(ch,lo,+m_lo[1]-1,+m_lo[2]-1);const btns=NAV.querySelectorAll('button');let flat=0,target=-1;chapters.forEach((c,ci)=>{(c.los||[]).forEach((l,li)=>{if(c===ch&&l===lo)target=flat;flat++;});if(c.assessment)flat++;});if(target!==-1)setActiveLO(btns[target]);return true;}}const m_as=location.hash.match(/^#ch(\d+)-assessment$/);if(m_as){const ch=chapters[+m_as[1]-1];if(ch&&ch.assessment){renderAssessmentView(ch,+m_as[1]-1);const btns=NAV.querySelectorAll('button');let flat=0,target=-1;chapters.forEach((c,ci)=>{flat+=(c.los||[]).length;if(c===ch)target=flat;if(c.assessment)flat++;});if(target!==-1)setActiveLO(btns[target]);return true;}}return false;}

    function totals(){let total=0;(chapters||[]).forEach(ch=>total+=(ch.los?.length||0));let done=0;for(const k of seen){const[ci,li]=(k||'').split('.').map(Number);if(chapters?.[ci-1]?.los?.[li-