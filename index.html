<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Advice Only‚Ñ¢ Bookstore</title>
<meta name="robots" content="noindex,nofollow"/>
<style>
  :root{
    --bg:#0b0d10;--panel:#12151a;--muted:#8ea1b2;--fg:#e8eef3;--brand:#00d0b6;--border:#1e242c;--hover:#171c24;
    --leftW:300px; --gutter:6px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,sans-serif}
  a{color:var(--brand);text-decoration:none}
  .topbar{display:flex;gap:12px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(11,13,16,.9);backdrop-filter:saturate(1.2) blur(6px);z-index:5}
  .brand{display:flex;align-items:center;gap:8px;font-weight:600}
  .tabs{display:flex;gap:8px}
  .tabs a{padding:6px 10px;border:1px solid var(--border);border-radius:10px;color:#cfe0ee;background:transparent}
  .tabs a[aria-current="page"]{background:#0e2723;border-color:#11433b}
  .search{margin-left:auto;display:flex;gap:6px}
  .search input{background:#0d1117;border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--fg);min-width:260px}
  .search button{border:1px solid var(--border);background:transparent;color:var(--fg);border-radius:8px;padding:6px 10px}

  .wrap{display:grid;grid-template-columns:var(--leftW) var(--gutter) 1fr 320px;gap:0;min-height:calc(100vh - 48px)}
  .left{padding:12px 10px 12px 12px;overflow:auto;border-right:1px solid var(--border)}
  .gutter{cursor:col-resize;background:linear-gradient(90deg,transparent 0,#0f141b 48%,#18202a 52%,transparent 100%);user-select:none}
  .main{padding:16px;overflow:auto;border-right:1px solid var(--border)}
  .rail{padding:12px;overflow:auto}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px}
  .block{padding:10px;margin-bottom:12px}
  .block h3{margin:0 0 8px;color:#bcd0e0;font-weight:600;font-size:13px}
  .muted{color:var(--muted)}
  .lead{color:#c7d7e6}
  .list{list-style:none;margin:0;padding:0}
  .list li{margin:0}
  .navbtn{display:block;width:100%;text-align:left;background:transparent;border:0;color:#cfe0ee;padding:7px 8px;border-radius:8px;cursor:pointer}
  .navbtn:hover{background:var(--hover)}
  .navbtn[aria-current="true"]{background:#0e2723;outline:1px solid #11433b}
  .lo{padding-left:14px}
  .alert{border:1px solid var(--border);padding:12px;border-radius:10px;color:#c7d7e6}
  h1{margin:0 0 12px;font-size:22px}
  h2{margin:18px 0 8px;font-size:16px}
  .kbd{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0d1117;padding:1px 6px;border-radius:6px;border:1px solid #222a33;color:#a3b4c5}

  /* small screens */
  @media (max-width:1100px){
    .wrap{grid-template-columns:1fr;grid-template-rows:auto auto auto}
    .gutter{display:none}
    .left,.rail{order:1}
    .main{order:2}
  }
</style>
</head>
<body>
<header class="topbar">
  <div class="brand">üíß Advice Only‚Ñ¢ Bookstore</div>
  <nav class="tabs" id="tabs">
    <a href="#read"           data-view="read">Read</a>
    <a href="#data"           data-view="data">My Data</a>
    <a href="#events"         data-view="events">Events</a>
    <a href="#profile"        data-view="profile">Profile</a>
    <a href="#transparency"   data-view="transparency">Transparency</a>
  </nav>
  <form class="search" id="searchForm">
    <input id="searchInput" placeholder="Search snippets, topics‚Ä¶"/>
    <button type="submit">Search</button>
  </form>
</header>

<div class="wrap">
  <!-- LEFT RAIL: CARDS STACK -->
  <aside class="left" id="left">
    <!-- Book nav card -->
    <section class="card block" id="bookCard">
      <h3>Book</h3>
      <ul class="list" id="bookNav"><li class="muted">Loading‚Ä¶</li></ul>
    </section>

    <!-- Quick links card -->
    <section class="card block">
      <h3>Quick Links</h3>
      <ul class="list">
        <li><a class="navbtn" href="#data">üìä My Data</a></li>
        <li><a class="navbtn" href="#events">üóìÔ∏è Events</a></li>
        <li><a class="navbtn" href="#profile">üë§ Profile</a></li>
        <li><a class="navbtn" href="#transparency">üîé Transparency</a></li>
      </ul>
    </section>

    <!-- Events sample card -->
    <section class="card block" id="eventsCard">
      <h3>Events</h3>
      <ul class="list" id="leftEvents">
        <li><a class="navbtn" href="#events">Online ‚Äî Platform Walkthrough (Preview)</a></li>
        <li><a class="navbtn" href="#events">Advisor CE ‚Äî Advice Only in Practice</a></li>
      </ul>
    </section>
  </aside>

  <!-- DRAG GUTTER -->
  <div class="gutter" id="gutter" title="Drag to resize"></div>

  <!-- CENTER -->
  <main class="main" id="main">
    <h1>Welcome</h1>
    <p class="lead">Select a learning objective from the left.</p>
    <div class="muted">If blank, check <span class="kbd">site.json</span> in Network, then hard-reload.</div>
  </main>

  <!-- RIGHT RAIL -->
  <aside class="rail" id="rail">
    <h3 style="margin:0 0 8px;color:#bcd0e0;font-weight:600">Alerts</h3>
    <div class="alert">‚ÄúSite accessibility tutorial‚Äù lives here for now. Later: notifications for subscribed users.</div>
  </aside>
</div>

<!-- (Optional) Inline JSON for preview. Remove if you want to fetch site.json instead.
<script id="site_json" type="application/json">
{ "book":"Advice Only‚Ñ¢ Methodology (Preview)", "chapters":[
  { "title":"My Perfect Plan","los":[
    {"title":"1.1 ‚Äî What's The Perfect Plan?","preview":"BODY ‚Ä¶"},
    {"title":"1.2 ‚Äî Why Be Rational?","preview":"‚Ä¶"},
    {"title":"1.3 ‚Äî Me, Myself and I","preview":"‚Ä¶"}
  ]},
  { "title":"Expenses","los":[
    {"title":"2.1 ‚Äî Being Real","preview":"‚Ä¶"},
    {"title":"2.2 ‚Äî My Expenses","preview":"‚Ä¶"},
    {"title":"2.3 ‚Äî Understanding Inflation","preview":"‚Ä¶"}
  ]},
  { "title":"Cash Flow & Net Worth","los":[
    {"title":"3.1 ‚Äî Key Planning Documents","preview":"‚Ä¶"},
    {"title":"3.2 ‚Äî Positive Cash Flow","preview":"‚Ä¶"},
    {"title":"3.3 ‚Äî Compounding Interest","preview":"‚Ä¶"}
  ]}
]}
</script>
-->

<script>
(async () => {
  // ---------- elements
  const tabs   = document.getElementById('tabs');
  const left   = document.getElementById('left');
  const bookNav= document.getElementById('bookNav');
  const main   = document.getElementById('main');
  const rail   = document.getElementById('rail');
  const gutter = document.getElementById('gutter');
  const searchForm = document.getElementById('searchForm');
  const searchInput= document.getElementById('searchInput');

  // ---------- drag-to-resize (no text select)
  (function setupDrag(){
    let down=false,startX=0,startW=0;
    gutter.addEventListener('mousedown',(e)=>{
      down=true; startX=e.clientX; startW=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--leftW'))||300;
      document.body.style.userSelect='none';
      e.preventDefault();
    });
    window.addEventListener('mousemove',(e)=>{
      if(!down) return;
      const dx = e.clientX - startX;
      const w = Math.max(220, Math.min(520, startW + dx));
      document.documentElement.style.setProperty('--leftW', w+'px');
    });
    window.addEventListener('mouseup',()=>{
      if(down){ down=false; document.body.style.userSelect=''; }
    });
  })();

  // ---------- tiny helpers
  const h = (t,a={},...c)=>{const e=document.createElement(t);
    for (const[k,v] of Object.entries(a)){
      if(k==='class') e.className=v;
      else if(k==='html') e.innerHTML=v;
      else e.setAttribute(k,v);
    }
    for(const x of c) e.appendChild(typeof x==='string'?document.createTextNode(x):x);
    return e;
  };
  const num = s => s ? parseInt(s,10) : NaN;

  // Extract chapter order robustly
  function chapterOrderIndex(ch,i){
    if (typeof ch.index==='number') return ch.index;
    const ct=(ch.title||'').trim();
    let m=/^Chapter\s+(\d+)/i.exec(ct); if(m) return num(m[1]);
    let best=Infinity;
    (ch.los||[]).forEach(lo=>{
      const t=(lo.title||'').trim();
      const matches=t.match(/\b(\d+\.\d+)\b/g);
      if(matches){
        matches.forEach(mm=>{
          const major=parseInt(mm.split('.')[0],10);
          if(!Number.isNaN(major)&&major<best) best=major;
        });
      }
    });
    return best!==Infinity ? best : 1000+i;
  }
  function loLabel(lo){
    const t=(lo.title||'').trim();
    const m=t.match(/(\d+\.\d+)/);
    if(m){
      const rest=t.replace(m[0],'').replace(/^[-‚Äî:\s]+/,'').trim();
      return `${m[0]} ‚Äî ${rest||''}`.trim();
    }
    return t || 'Untitled';
  }

  // ---------- load SITE (inline first, else fetch)
  let SITE=null;
  const inline = document.getElementById('site_json');
  if (inline){
    try { SITE = JSON.parse(inline.textContent); } catch(e){ console.error('Inline JSON parse error',e); }
  }
  if (!SITE){
    try{
      const res = await fetch('site.json',{cache:'no-store',credentials:'same-origin'});
      const txt = await res.text();
      SITE = JSON.parse(txt);
    }catch(e){
      bookNav.innerHTML = '';
      bookNav.append(h('li',{class:'muted'},'Could not load site.json.'));
      console.error(e);
      return;
    }
  }

  // normalize / sort
  const CHAPTERS = (SITE.chapters||[])
    .map((ch,i)=>({ch,ord:chapterOrderIndex(ch,i)}))
    .sort((a,b)=>a.ord-b.ord)
    .map(x=>x.ch);

  // ---------- build left Book card
  function buildBookNav(){
    bookNav.innerHTML='';
    if (!CHAPTERS.length){
      bookNav.append(h('li',{class:'muted'},'No readable chapters in this preview.'));
      return;
    }
    CHAPTERS.forEach((ch,ci)=>{
      // chapter header
      bookNav.append(h('li',{},h('div',{class:'muted',style:'padding:6px 8px 4px 8px;font-weight:600'}, ch.title||`Chapter ${ci+1}`)));
      // LOs
      (ch.los||[]).forEach((lo,li)=>{
        const btn = h('button',{class:'navbtn lo',type:'button'}, loLabel(lo));
        btn.addEventListener('click',()=>{
          location.hash = `#ch${ci+1}-lo${li+1}`;
          renderReadFromHash();
        });
        bookNav.append(h('li',{},btn));
      });
    });
  }

  // ---------- READ view renderer
  function renderLO(ci,li){
    const ch = CHAPTERS[ci];
    const lo = ch?.los?.[li];
    if (!ch || !lo){
      main.innerHTML = '';
      main.append(h('h1',{},'Book'), h('div',{class:'muted'},'Select a learning objective from the left.'));
      return;
    }
    // set active state in book card
    left.querySelectorAll('.navbtn[aria-current="true"]').forEach(b=>b.setAttribute('aria-current','false'));
    const flatBtns = [...left.querySelectorAll('.navbtn.lo')];
    // compute flat index to find btn
    let idx=0, target=0;
    CHAPTERS.forEach((C,ci2)=> (C.los||[]).forEach((L,li2)=>{ if(ci===ci2 && li===li2) target=idx; idx++; }));
    flatBtns[target]?.setAttribute('aria-current','true');

    // center content
    main.innerHTML='';
    main.append(
      h('h1',{}, `${ch.title} ‚Äî ${lo.title}`),
      h('p',{class:'lead'}, lo.preview || 'This is preview text for this learning objective.')
    );
    // Optional snippet blocks
    if (Array.isArray(lo.snippets)){
      lo.snippets.forEach(s=>{
        if (s.title) main.append(h('h2',{}, s.title));
        if (s.body)  main.append(h('p',{}, s.body));
        if (s.image?.src){
          const fig=h('figure',{style:'margin:12px 0'});
          fig.append(h('img',{src:s.image.src,alt:s.image.alt||'',style:'max-width:100%;border-radius:8px'}));
          if (s.image.caption) fig.append(h('figcaption',{class:'muted'},s.image.caption));
          main.append(fig);
        }
      });
    }
  }
  function renderReadFromHash(){
    const m = location.hash.match(/^#ch(\d+)-lo(\d+)$/);
    const ci = m ? (parseInt(m[1],10)-1) : 0;
    const li = m ? (parseInt(m[2],10)-1) : 0;
    renderLO(ci,li);
  }

  // ---------- other views (center swaps only)
  function renderData(){
    main.innerHTML='';
    main.append(h('h1',{},'My Data'),
      h('p',{class:'muted'},'Later: saved snippets, progress, notes, and exports.'));
  }
  function renderEvents(){
    main.innerHTML='';
    main.append(h('h1',{},'Events'),
      h('ul',{},
        h('li',{},'Online ‚Äî Platform Walkthrough (Preview) ‚Äî Mon Nov 3, 4‚Äì5pm PT'),
        h('li',{},'Advisor CE ‚Äî Advice Only in Practice ‚Äî Wed Oct 1, 4‚Äì5pm PT')));
  }
  function renderProfile(){
    main.innerHTML='';
    main.append(h('h1',{},'Profile'),
      h('p',{class:'muted'},'Sign in with email, LinkedIn, or Facebook to unlock the full book.'));
  }
  function renderTransparency(){
    main.innerHTML='';
    main.append(h('h1',{},'Transparency'),
      h('ul',{},
        h('li',{},'Changelog & build info'),
        h('li',{},'Headers/robots directives'),
        h('li',{},'Accessibility and keyboard support')));
  }

  // ---------- router (tabs + hash)
  const R = {
    read: ()=>{ buildBookNav(); renderReadFromHash(); },
    data: ()=>{ renderData(); },
    events: ()=>{ renderEvents(); },
    profile: ()=>{ renderProfile(); },
    transparency: ()=>{ renderTransparency(); },
  };
  function setActiveTab(view){
    tabs.querySelectorAll('a[data-view]').forEach(a=>a.setAttribute('aria-current', a.dataset.view===view?'page':'false'));
  }
  function currentView(){
    const v=(location.hash||'#read').slice(1).toLowerCase();
    if(/^ch\d+-lo\d+$/.test(v)) return 'read';
    if(!v) return 'read';
    if(R[v]) return v;
    return 'read';
  }
  function go(view){
    setActiveTab(view);
    R[view]();
  }
  window.addEventListener('hashchange', ()=>go(currentView()));
  tabs.addEventListener('click',(e)=>{
    const a=e.target.closest('a[data-view]'); if(!a) return;
    e.preventDefault(); location.hash='#'+a.dataset.view;
  });

  // ---------- search: first match => navigate
  searchForm.addEventListener('submit',(e)=>{
    e.preventDefault();
    const q=(searchInput.value||'').trim().toLowerCase(); if(!q) return;
    let found=null, fci=0, fli=0;
    CHAPTERS.some((ch,ci)=>{
      return (ch.los||[]).some((lo,li)=>{
        const hay=[lo.title, lo.preview, ...(lo.snippets||[]).map(s=>[s.title,s.body].join(' '))].join(' ').toLowerCase();
        if(hay.includes(q)){ found=lo; fci=ci; fli=li; return true; }
        return false;
      });
    });
    if(found){
      location.hash = `#ch${fci+1}-lo${fli+1}`;
      go('read');
    }
  });

  // ---------- boot
  go(currentView());
})();
</script>
</body>
</html>
