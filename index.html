<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Advice-Only® Learning Management System (Preview)</title>
  <meta name="robots" content="noindex,nofollow"/>
  <meta name="ao-root" content="/"/>

  <link rel="stylesheet" href="static/css/ao-ui.css"/>

  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
  <link rel="preconnect" href="https://www.clarity.ms" crossorigin>

  <link href="static/js/vendor/survey/survey-core.min.css" rel="stylesheet"/>
  <script src="static/js/vendor/survey/survey.core.min.js"></script>
  <script src="static/js/vendor/survey/survey-js-ui.min.js"></script>

</head>
<body>

  <header class="top" id="top">
    <div class="top-wrap">
      <div class="logo">
        <img src="static/brand/ao-teal-logo.png" alt="AO Logo" onerror="this.remove()"/>
        <a href="#home" id="brand">Advice-Only®</a>
      </div>
      <nav class="menu" id="menu">
        <a href="#home" data-route="home">Home</a>
        <a href="#data" data-route="data">My Data</a>
        <a href="#events" data-route="events">Events</a>
        <a href="#privacy" data-route="privacy">Privacy</a>
        <a href="#about" data-route="about">About</a>
      </nav>
      <div class="search" id="search">
        <input id="q" aria-label="Search or ask" placeholder="Search or ask (Enter to view all)…" autocomplete="off"/>
        <div class="dd" id="dd"></div>
      </div>
      <button id="theme-toggle" aria-label="Toggle theme">
        <svg class="icon-dark" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <title>Activate light mode</title>
          <circle cx="12" cy="12" r="5"></circle>
          <path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 7.05-1.41-1.41M6.46 6.46 5.05 5.05m13.9 0-1.41 1.41M6.46 17.54 5.05 18.95"></path>
        </svg>
        <svg class="icon-light" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <title>Activate dark mode</title>
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
    </div>
  </header>

  <div class="wrap">
    <aside class="card nav" id="nav"><div class="muted">Loading…</div></aside>

    <main class="card main" id="main">
      <h1>Welcome</h1>
      <p class="lead">Select a learning objective from the left. Use the search above to jump to content.</p>
      <div class="muted">Data comes from <span class="kbd">site.json</span>. Add <span class="kbd">?full=1</span> to load <span class="kbd">full/site.json</span>.</div>
    </main>

    <aside class="card rail" id="rail">
      <div class="cardlet">
        <h4>Alerts</h4>
        <div class="muted">This panel is a placeholder for progress and events.</div>
      </div>
      <div class="cardlet" id="rail-events"></div>
      <div class="cardlet" id="rail-progress"></div>
    </aside>
  </div>

  <div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="Zoom" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:100">
    <button class="btn" id="lbClose" style="position:absolute;top:14px;right:14px">Close</button>
    <div id="lbSlot" style="max-width:92vw;max-height:92vh;margin:auto"></div>
  </div>

<script>
(() => {
    // Basic helpers, theme, analytics, etc.
    const KEY = 'ao.theme';
    const root = document.documentElement;
    const btn = document.getElementById('theme-toggle');
    const apply = isLight => root.classList.toggle('light', isLight);
    let saved = false;
    try { saved = localStorage.getItem(KEY) === 'light'; } catch {}
    apply(saved);
    btn?.addEventListener('click', () => {
        const next = !root.classList.contains('light');
        apply(next);
        try { localStorage.setItem(KEY, next ? 'light' : 'dark'); } catch {}
    });

    const h=(t,a={},...c)=>{const e=document.createElement(t);for(const[k,v]of Object.entries(a)){if(k==='class')e.className=v;else if(k==='html'&&e)e.innerHTML=v;else if(k.startsWith('on')&&typeof v==='function')e.addEventListener(k.slice(2),v);else e.setAttribute(k,v);}c.forEach(x=>{if(x!=null)e.appendChild(typeof x==='string'?document.createTextNode(x):x)});return e;};

    // Main app logic
    let site = null;
    let currentLO = null;

    function renderChapter(chapter) {
        document.querySelector('main h1').textContent = chapter.title;
        document.querySelector('main p.lead').textContent = 'Loading learning objectives...';
        
        const contentArea = h('div', { class: 'content-area' });
        document.querySelector('main').appendChild(contentArea);

        chapter.sections.forEach(section => {
            const sectionEl = h('section', { id: section.h2_id });
            sectionEl.innerHTML = section.section_public_html;
            
            if (section.sub_objectives && section.sub_objectives.length > 0) {
                const subObjectivesList = h('ul', { class: 'sub-objectives-list' });
                section.sub_objectives.forEach(sub => {
                    const li = h('li', {}, sub.title);
                    if (sub.teaser_public) {
                        li.appendChild(h('p', { class: 'teaser' }, sub.teaser_public));
                    }
                    if (sub.type === 'quiz' && sub.quiz) {
                        const quizButton = h('button', {
                            class: 'ao-token',
                            'data-kind': 'quiz',
                            'data-id': sub.quiz.id
                        }, 'Take Quiz');
                        li.appendChild(quizButton);
                    }
                    if (sub.type === 'assessment' && sub.assessment) {
                         const assessButton = h('button', {
                            class: 'ao-token',
                            'data-kind': 'assessment',
                            'data-id': sub.assessment.id
                        }, 'Begin Assessment');
                        li.appendChild(assessButton);
                    }
                    subObjectivesList.appendChild(li);
                });
                sectionEl.appendChild(subObjectivesList);
            }
            contentArea.appendChild(sectionEl);
        });
        
        // Handle tokens after DOM is built
        enhanceTokens();
    }
    
    function enhanceTokens() {
        const areas = document.querySelectorAll('main');
        areas.forEach(el => {
          el.innerHTML = el.innerHTML
            .replace(/\[\[(quiz):([a-z0-9\-]+)\]\]/gi,
              (_m, _k, id) => `<button class="ao-token" data-kind="quiz" data-id="${id}">Take quiz</button>`)
            .replace(/\[\[(assessment):([a-z0-9\-]+)\]\]/gi,
              (_m, _k, id) => `<button class="ao-token" data-kind="assessment" data-id="${id}">Chapter assessment</button>`);
        });
    }

    async function boot() {
        try {
            const response = await fetch('site.json');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            site = await response.json();
            
            // For this specific test, let's load chapter 2
            const chapter = site.chapters.find(c => c.id === 'ch-02') || site.chapters[0];
            if (chapter) {
                renderChapter(chapter);
            }

        } catch(e) {
            console.error('Failed to load site.json', e);
            document.querySelector('main').innerHTML = '<h1>Error</h1><p>Failed to load site content. Check file paths and server.</p>';
        }
    }
    
    document.addEventListener('click', (e) => {
        const btn = e.target.closest('.ao-token');
        if (!btn) return;
        const kind = btn.dataset.kind;
        const id = btn.dataset.id;
        
        const path = kind === 'quiz'
          ? `data/quizzes/${id}.json`
          : `data/assessments/${id}.json`;
        
        fetch(path)
            .then(res => res.json())
            .then(json => {
                const modalContent = h('div', { class: 'modal-content' });
                const model = new Survey.Model(json);
                model.render(modalContent);
                document.body.appendChild(modalContent);
            })
            .catch(err => {
                console.error(err);
                alert('Could not load ' + kind + ' "' + id + '"');
            });
    });

    boot();
})();
</script>
</body>
</html>