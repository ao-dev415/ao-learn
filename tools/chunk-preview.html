<!doctype html>
<html lang="en">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chunk Preview</title>
<style>
  body{margin:0;font:14px/1.45 system-ui;background:#0b0d10;color:#e8eef3}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  header{padding:10px 12px;background:#0c1015;border-bottom:1px solid #1e242c}
  input,select,button{border-radius:8px;border:1px solid #233041;background:#0d131a;color:#e8eef3;padding:8px 10px}
  button{background:#0e2723;border-color:#11433b;cursor:pointer}
  main{padding:12px}
  .chunk{border:1px solid #1f2630;border-radius:10px;padding:10px;margin:0 0 10px;background:#0e1218}
  .pill{display:inline-block;border:1px solid #2a3340;border-radius:999px;padding:2px 8px;font-size:12px;color:#c7d7e6;background:#0d1117;margin-right:6px}
  mark{background:transparent;border-bottom:1px dashed #2f4b59;color:#e6fff7}
</style>
<header class="row">
  <b>Chunk Preview</b>
  <input id="src" style="min-width:320px" placeholder="/main.static/rag/chunks.json">
  <button id="fetch">Fetch URL</button>
  <input id="file" type="file" accept=".json,.jsonl,application/json">
  <input id="q" placeholder="search (Enter)">
  <select id="ch"><option value="">All chapters</option></select>
  <select id="lo"><option value="">All LOs</option></select>
  <label><input id="pv" type="checkbox" checked> 200-word preview</label>
  <span id="stat" style="opacity:.8"></span>
</header>
<main id="out"><div>Load a file or fetch a URL.</div></main>
<script>
let ALL=[], VIEW=[];
const $=id=>document.getElementById(id), esc=s=>String(s??'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
function parse(text){
  const t=String(text||'').replace(/^\uFEFF/,'').trim(); if(!t) return [];
  if(t[0]==='['){const a=JSON.parse(t); if(!Array.isArray(a)) throw new Error('Expected array'); return a;}
  if(t[0]==='{'){const o=JSON.parse(t); if(Array.isArray(o.items)) return o.items; if(Array.isArray(o.data)) return o.data; return [o];}
  return t.split(/\r?\n/).filter(Boolean).map((ln,i)=>{try{return JSON.parse(ln)}catch(e){throw new Error(`JSONL line ${i+1}: ${e.message}`)}})
}
function uniq(a){return [...new Set(a)]}
function get(o,ks,d=''){for(const k of ks){if(o&&o[k]!=null)return o[k]}return d}
function toks(s){return (String(s||'').toLowerCase().match(/[a-z0-9]+/g)||[])}
function score(qt,c){if(!qt.length) return 1; const hay=(get(c,['text','content','body'],'')+' '+get(c,['chapter','h1'],'')+' '+get(c,['lo','h2'],'')+' '+get(c,['subhead','section','h3'],'')).toLowerCase(); let s=0; for(const q of qt){const n=hay.split(q).length-1; if(n>0) s+=n*2} return s}
function hi(t,qt){let out=esc(t); qt.forEach(q=>{const re=new RegExp(`(${q.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&')})`,'ig'); out=out.replace(re,'<mark>$1</mark>')}); return out}
function render(qt){
  const out=$('out'); if(!VIEW.length){ out.innerHTML='<div>No matches.</div>'; return }
  const pv=$('pv').checked; const frag=document.createDocumentFragment();
  VIEW.forEach(c=>{
    const h1=get(c,['chapter','h1'],''), h2=get(c,['lo','h2'],''), h3=get(c,['subhead','section','h3'],''), t=get(c,['text','content','body'],'');
    const d=document.createElement('div'); d.className='chunk';
    const words=(t.match(/\S+/g)||[]).length;
    const clip = pv ? t.split(/\s+/).slice(0,200).join(' ') + (words>200?'â€¦':'') : t;
    d.innerHTML = `<div>${h1?`<span class="pill">${esc(h1)}</span>`:''}${h2?`<span class="pill">${esc(h2)}</span>`:''}${h3?`<span class="pill">${esc(h3)}</span>`:''}<span class="pill">words:${words}</span></div><div>${hi(clip,qt)}</div>`;
    frag.appendChild(d);
  });
  out.innerHTML=''; out.appendChild(frag);
}
function apply(){
  const q=$('q').value.trim(), ch=$('ch').value, lo=$('lo').value; const qt=toks(q);
  VIEW = ALL.map(c=>({c,s:score(qt,c)}))
    .filter(x=>x.s>0)
    .filter(x=>!ch || get(x.c,['chapter','h1'],'')===ch)
    .filter(x=>!lo || get(x.c,['lo','h2'],'')===lo)
    .sort((a,b)=>b.s-a.s).map(x=>x.c);
  $('stat').textContent = `${VIEW.length}/${ALL.length}`;
  render(qt);
}
function afterLoad(lbl){
  const chs=uniq(ALL.map(c=>get(c,['chapter','h1'],'')).filter(Boolean)).sort();
  const los=uniq(ALL.map(c=>get(c,['lo','h2'],'')).filter(Boolean)).sort();
  $('ch').innerHTML='<option value="">All chapters</option>'+chs.map(v=>`<option>${esc(v)}</option>`).join('');
  $('lo').innerHTML='<option value="">All LOs</option>'+los.map(v=>`<option>${esc(v)}</option>`).join('');
  $('stat').textContent = `${ALL.length} chunks from ${lbl}`; apply();
}
$('fetch').onclick=async()=>{try{const u=$('src').value.trim()||'/main.static/rag/chunks.json'; const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(`HTTP ${r.status}`); ALL=parse(await r.text()); afterLoad(u);}catch(e){$('out').innerHTML=`<div style="color:#ff9aa2">Fetch/parse error: ${e.message}</div>`}};
$('file').onchange=e=>{const f=e.target.files?.[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{try{ALL=parse(fr.result); afterLoad(f.name)}catch(e){$('out').innerHTML=`<div style="color:#ff9aa2">Parse error: ${e.message}</div>`}}; fr.readAsText(f);}
$('q').onkeydown=e=>{if(e.key==='Enter') apply()}
$('ch').onchange=apply; $('lo').onchange=apply; $('pv').onchange=()=>render(toks($('q').value))
</script>
</html>
